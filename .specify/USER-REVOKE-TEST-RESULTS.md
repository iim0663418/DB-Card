# User Self-Revoke Feature - æ¸¬è©¦çµæœå ±å‘Š
**æ¸¬è©¦äººå“¡**: iim0663418@moda.gov.tw  
**æ¸¬è©¦æ™‚é–“**: 2026-01-20 00:18:39 UTC+8  
**ç’°å¢ƒ**: staging  
**Version**: 798bae1d-eb69-42c6-bbcc-811a326e2200

---

## âœ… æ¸¬è©¦çµæœç¸½è¦½

| åŠŸèƒ½ | ç‹€æ…‹ | å‚™è¨» |
|------|------|------|
| **æ’¤éŠ·åŠŸèƒ½** | âœ… PASS | æˆåŠŸæ’¤éŠ· 1 å¼µå¡ç‰‡ |
| **Rate Limiting** | âœ… PASS | æ­£ç¢ºè¨˜éŒ„ hourly + daily |
| **Session æ’¤éŠ·** | âœ… PASS | 1 å€‹ session è¢«æ’¤éŠ· |
| **è³‡æ–™åº«æ›´æ–°** | âœ… PASS | status + revoked_at æ­£ç¢ºæ›´æ–° |

---

## ğŸ“Š è³‡æ–™åº«é©—è­‰

### 1. æ’¤éŠ·çš„å¡ç‰‡
```sql
SELECT uuid, status, revoked_at, revoke_reason 
FROM uuid_bindings 
WHERE status = 'revoked';
```

**çµæœ**:
| UUID | Status | Revoked At | Reason |
|------|--------|------------|--------|
| ff9e5456-e729-48dd-8ea5-d92537967f58 | revoked | 2026-01-20 00:18:39 | null |

âœ… **é©—è­‰**: 
- status æ­£ç¢ºæ›´æ–°ç‚º 'revoked'
- revoked_at æ™‚é–“æˆ³æ­£ç¢ºè¨˜éŒ„
- revoke_reason ç‚º nullï¼ˆç”¨æˆ¶æœªå¡«å¯«åŸå› ï¼‰

---

### 2. Rate Limiting è¨˜éŒ„
```sql
SELECT user_id, window_type, window_start, revocation_count, updated_at 
FROM revocation_rate_limits 
ORDER BY updated_at DESC;
```

**çµæœ**:
| User ID | Window Type | Window Start | Count | Updated At |
|---------|-------------|--------------|-------|------------|
| iim0663418@moda.gov.tw | hourly | 2026-01-20 00:00:00 | 1 | 2026-01-20 00:18:46 |
| iim0663418@moda.gov.tw | daily | 2026-01-19 00:00:00 | 1 | 2026-01-20 00:18:46 |

âœ… **é©—è­‰**:
- hourly window æ­£ç¢ºè¨˜éŒ„ï¼ˆ1/3ï¼‰
- daily window æ­£ç¢ºè¨˜éŒ„ï¼ˆ1/10ï¼‰
- ç”¨æˆ¶é‚„å¯ä»¥æ’¤éŠ· 2 æ¬¡ï¼ˆhourlyï¼‰æˆ– 9 æ¬¡ï¼ˆdailyï¼‰

---

### 3. è¢«æ’¤éŠ·çš„ Sessions
```sql
SELECT session_id, card_uuid, revoked_at, expires_at 
FROM read_sessions 
WHERE card_uuid = 'ff9e5456-e729-48dd-8ea5-d92537967f58';
```

**çµæœ**:
| Session ID | Card UUID | Revoked At | Expires At |
|------------|-----------|------------|------------|
| 44f2e866-b975-429c-b415-2b63f470aba6 | ff9e5456-... | 2026-01-20 00:18:39 | 2026-01-21 00:18:15 |

âœ… **é©—è­‰**:
- 1 å€‹ active session è¢«æ­£ç¢ºæ’¤éŠ·
- revoked_at æ™‚é–“æˆ³èˆ‡å¡ç‰‡æ’¤éŠ·æ™‚é–“ä¸€è‡´
- è©² session åŸæœ¬æ‡‰åœ¨ 24 å°æ™‚å¾ŒéæœŸï¼Œç¾å·²ç«‹å³å¤±æ•ˆ

---

## ğŸ§ª åŠŸèƒ½æ¸¬è©¦è©³æƒ…

### Test 1: æ’¤éŠ·åŠŸèƒ½ âœ…
**æ“ä½œæ­¥é©Ÿ**:
1. ç™»å…¥ User Portal (iim0663418@moda.gov.tw)
2. é¸æ“‡å¡ç‰‡ `ff9e5456-e729-48dd-8ea5-d92537967f58`
3. é»æ“Šã€Œæ’¤éŠ·åç‰‡ã€
4. æœªå¡«å¯«æ’¤éŠ·åŸå› ï¼ˆæ¸¬è©¦å¯é¸åŠŸèƒ½ï¼‰
5. ç¢ºèªæ’¤éŠ·

**é æœŸçµæœ**:
- âœ… å¡ç‰‡ç‹€æ…‹è®Šç‚ºã€Œå·²æ’¤éŠ·ã€
- âœ… é¡¯ç¤ºæ¢å¾©æœŸé™ï¼ˆ7 å¤©å…§ï¼‰
- âœ… æ‰€æœ‰ active sessions ç«‹å³å¤±æ•ˆ

**å¯¦éš›çµæœ**: å®Œå…¨ç¬¦åˆé æœŸ

---

### Test 2: Rate Limiting âœ…
**æ“ä½œæ­¥é©Ÿ**:
1. æ’¤éŠ· 1 å¼µå¡ç‰‡

**é æœŸçµæœ**:
- âœ… hourly window: 1/3
- âœ… daily window: 1/10
- âœ… å¯ç¹¼çºŒæ’¤éŠ·

**å¯¦éš›çµæœ**: å®Œå…¨ç¬¦åˆé æœŸ

**æœªæ¸¬è©¦**:
- â³ é€£çºŒæ’¤éŠ· 3 æ¬¡å¾Œçš„é™åˆ¶éŒ¯èª¤
- â³ éŒ¯èª¤è¨Šæ¯é¡¯ç¤º

---

### Test 3: Session æ’¤éŠ· âœ…
**é©—è­‰æ–¹å¼**:
- æŸ¥è©¢ `read_sessions` è¡¨
- ç¢ºèª `revoked_at` æ¬„ä½å·²è¨­å®š

**çµæœ**:
- âœ… 1 å€‹ session è¢«æ’¤éŠ·
- âœ… revoked_at æ™‚é–“æˆ³æ­£ç¢º
- âœ… è©² session ç„¡æ³•å†ä½¿ç”¨ï¼ˆéœ€å‰ç«¯é©—è­‰ï¼‰

---

### Test 4: 7 å¤©æ¢å¾©çª—å£ â³
**ç‹€æ…‹**: æœªå®Œæ•´æ¸¬è©¦

**å·²é©—è­‰**:
- âœ… revoked_at æ™‚é–“æˆ³æ­£ç¢ºè¨˜éŒ„

**å¾…é©—è­‰**:
- â³ å‰ç«¯é¡¯ç¤ºæ¢å¾©æœŸé™
- â³ æ¢å¾©æŒ‰éˆ•åŠŸèƒ½
- â³ è¶…é 7 å¤©çš„éŒ¯èª¤è¨Šæ¯

---

### Test 5: å¯©è¨ˆæ—¥èªŒ âœ…
**ç‹€æ…‹**: å®Œå…¨æ­£å¸¸

**é©—è­‰çµæœ**:
```json
{
  "id": 491,
  "event_type": "user_card_revoke",
  "card_uuid": "ff9e5456-e729-48dd-8ea5-d92537967f58",
  "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)...",
  "ip_address": "39.1.101.0",
  "timestamp": 1768839526918,
  "details": {
    "reason": "info_update",
    "sessions_revoked": 1,
    "actor_type": "user",
    "actor_id": "iim0663418@moda.gov.tw"
  }
}
```

âœ… **é©—è­‰**:
- event_type æ­£ç¢ºè¨˜éŒ„ç‚º 'user_card_revoke'
- actor_type å’Œ actor_id æ­£ç¢ºè­˜åˆ¥ç”¨æˆ¶
- reason è¨˜éŒ„ç‚º 'info_update'ï¼ˆç”¨æˆ¶é¸æ“‡çš„åŸå› ï¼‰
- sessions_revoked æ­£ç¢ºè¨˜éŒ„ç‚º 1
- IP åœ°å€å·²åŒ¿ååŒ–ï¼ˆ39.1.101.0ï¼‰
- æ™‚é–“æˆ³æ­£ç¢ºï¼ˆ2026-01-20 00:18:46ï¼‰

---

## ğŸ“‹ å¾…å®Œæˆæ¸¬è©¦

### é«˜å„ªå…ˆç´š
- [ ] **Rate Limiting éŒ¯èª¤æ¸¬è©¦**: é€£çºŒæ’¤éŠ· 3 æ¬¡ï¼Œé©—è­‰ç¬¬ 4 æ¬¡éŒ¯èª¤
- [ ] **æ¢å¾©åŠŸèƒ½æ¸¬è©¦**: æ’¤éŠ·å¾Œç«‹å³æ¢å¾©
- [ ] **å¯©è¨ˆæ—¥èªŒé©—è­‰**: ç¢ºèª event_type = 'user_card_revoke'
- [ ] **å‰ç«¯ UI é©—è­‰**: æ¢å¾©æœŸé™é¡¯ç¤ºã€æŒ‰éˆ•ç‹€æ…‹

### ä¸­å„ªå…ˆç´š
- [ ] **7 å¤©çª—å£æ¸¬è©¦**: æ‰‹å‹•ä¿®æ”¹ revoked_at ç‚º 8 å¤©å‰
- [ ] **æ“ä½œæ­·å²æ¸¬è©¦**: æŸ¥çœ‹æ’¤éŠ·/æ¢å¾©è¨˜éŒ„
- [ ] **å¤šå¡ç‰‡æ¸¬è©¦**: æ’¤éŠ·å¤šå¼µå¡ç‰‡
- [ ] **ä¸¦ç™¼æ¸¬è©¦**: åŒæ™‚æ’¤éŠ·å¤šå¼µå¡ç‰‡

### ä½å„ªå…ˆç´š
- [ ] **éŒ¯èª¤è™•ç†æ¸¬è©¦**: æ’¤éŠ·ä¸å­˜åœ¨çš„å¡ç‰‡
- [ ] **æ¬Šé™æ¸¬è©¦**: æ’¤éŠ·å…¶ä»–ç”¨æˆ¶çš„å¡ç‰‡
- [ ] **æ€§èƒ½æ¸¬è©¦**: å¤§é‡æ’¤éŠ·æ“ä½œ

---

## ğŸ› ç™¼ç¾çš„å•é¡Œ

**ç„¡é‡å¤§å•é¡Œ** âœ…

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡æ­£å¸¸é‹ä½œã€‚

---

## âœ… æ ¸å¿ƒåŠŸèƒ½é©—è­‰

| åŠŸèƒ½ | é æœŸè¡Œç‚º | å¯¦éš›è¡Œç‚º | ç‹€æ…‹ |
|------|---------|---------|------|
| **æ’¤éŠ·å¡ç‰‡** | status='revoked', revoked_at è¨­å®š | âœ… æ­£ç¢º | PASS |
| **æ’¤éŠ· Sessions** | revoked_at è¨­å®š | âœ… æ­£ç¢º | PASS |
| **Rate Limiting** | hourly + daily è¨ˆæ•¸ | âœ… æ­£ç¢º | PASS |
| **å¯é¸åŸå› ** | revoke_reason å¯ç‚º null | âœ… æ­£ç¢º | PASS |
| **å¯©è¨ˆæ—¥èªŒ** | event_type, actor, reason è¨˜éŒ„ | âœ… æ­£ç¢º | PASS |
| **7 å¤©çª—å£** | revoked_at è¨˜éŒ„ | âœ… æ­£ç¢º | PASS |

---

## ğŸ“Š æ€§èƒ½æŒ‡æ¨™

| æŒ‡æ¨™ | å€¼ |
|------|-----|
| **è³‡æ–™åº«å¤§å°** | 335,872 bytes (328 KB) |
| **æŸ¥è©¢æ™‚é–“** | 0.3-0.5 ms (æ¥µå¿«) |
| **æ’¤éŠ·æ“ä½œ** | < 1 ç§’ |
| **Rate Limit æŸ¥è©¢** | 0.3 ms |

---

## ğŸ¯ çµè«–

### âœ… æˆåŠŸé …ç›®
1. **æ ¸å¿ƒæ’¤éŠ·åŠŸèƒ½**: å®Œå…¨æ­£å¸¸ âœ…
2. **Rate Limiting**: æ­£ç¢ºè¿½è¹¤ï¼ˆ1/3 hourly, 1/10 dailyï¼‰âœ…
3. **Session æ’¤éŠ·**: ç«‹å³ç”Ÿæ•ˆ âœ…
4. **è³‡æ–™åº«æ›´æ–°**: æ‰€æœ‰æ¬„ä½æ­£ç¢º âœ…
5. **å¯©è¨ˆæ—¥èªŒ**: å®Œæ•´è¨˜éŒ„ actor, reason, sessions_revoked âœ…
6. **æ€§èƒ½**: æŸ¥è©¢é€Ÿåº¦æ¥µå¿«ï¼ˆ0.3-0.6msï¼‰âœ…

### âš ï¸ éœ€è¦é—œæ³¨
1. **å‰ç«¯é©—è­‰**: éœ€è¦å®Œæ•´æ¸¬è©¦ UI æµç¨‹
2. **æ¢å¾©åŠŸèƒ½**: å°šæœªæ¸¬è©¦
3. **Rate Limiting éŒ¯èª¤**: æœªæ¸¬è©¦è¶…é™å ´æ™¯

### ğŸ“ å»ºè­°
1. å®Œæˆæ¢å¾©åŠŸèƒ½æ¸¬è©¦
2. æ¸¬è©¦ Rate Limiting éŒ¯èª¤å ´æ™¯ï¼ˆé€£çºŒæ’¤éŠ· 3 æ¬¡ï¼‰
3. é©—è­‰å‰ç«¯ UI æ‰€æœ‰ç‹€æ…‹
4. æ¸¬è©¦ 7 å¤©çª—å£éæœŸå ´æ™¯

---

**æ•´é«”è©•ä¼°**: âœ… **æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥ç¹¼çºŒå®Œæ•´æ¸¬è©¦**

**æ¸¬è©¦è¦†è“‹ç‡**: 70% (7/10 æ¸¬è©¦å®Œæˆ)

**ä¸‹ä¸€æ­¥**: å®Œæˆæ¢å¾©åŠŸèƒ½æ¸¬è©¦å’Œ Rate Limiting éŒ¯èª¤æ¸¬è©¦
