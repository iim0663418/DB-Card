# Asset Upload API ç¨‹å¼ç¢¼é©—æ”¶å ±å‘Š

**é©—æ”¶æ—¥æœŸ**: 2026-01-28  
**é©—æ”¶äºº**: Amazon Q Dev CLI  
**BDD è¦æ ¼**: `.specify/specs/asset-upload-api.md`

---

## ğŸ“‹ é©—æ”¶çµæœç¸½è¦½

### âœ… é€šéé …ç›®ï¼ˆ7/8 scenariosï¼‰
### âš ï¸ éœ€ä¿®æ­£é …ç›®ï¼ˆ1 scenarioï¼‰

---

## ğŸ” é€é …é©—æ”¶

### âœ… Scenario 1: æˆåŠŸä¸Šå‚³åœ–ç‰‡
**æª”æ¡ˆ**: `handlers/admin/assets.ts:202-220`

**é©—æ”¶é»**:
- âœ… è¿”å› 200 OK
- âœ… å›æ‡‰åŒ…å« asset_id, current_version, variants, size
- âœ… æ’å…¥ assets è¡¨
- âœ… æ’å…¥ asset_versions è¡¨
- âœ… ä¸Šå‚³è‡³ R2ï¼ˆ2 å€‹ variantsï¼‰

**ç¨‹å¼ç¢¼å“è³ª**: â­â­â­â­â­

---

### âœ… Scenario 2: æ‹’çµ•è¶…å¤§æª”æ¡ˆ
**æª”æ¡ˆ**: `handlers/admin/assets.ts:83-88`

**é©—æ”¶é»**:
- âœ… æª”æ¡ˆ > 5 MB â†’ 413 Payload Too Large
- âœ… éŒ¯èª¤è¨Šæ¯æ­£ç¢º
- âœ… ä¸å¯«å…¥è³‡æ–™åº«
- âœ… ä¸ä¸Šå‚³è‡³ R2

**ç¨‹å¼ç¢¼å“è³ª**: â­â­â­â­â­

---

### âœ… Scenario 3: æ‹’çµ•ç„¡æ•ˆæ ¼å¼
**æª”æ¡ˆ**: `handlers/admin/assets.ts:108-113`

**é©—æ”¶é»**:
- âœ… Magic Bytes é©—è­‰
- âœ… è¿”å› 400 Bad Request
- âœ… éŒ¯èª¤è¨Šæ¯æ­£ç¢º

**Magic Bytes å¯¦ä½œ** (`image-validator.ts:14-38`):
```typescript
âœ… JPEG: [0xFF, 0xD8, 0xFF]
âœ… PNG: [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]
âœ… WebP: [0x52, 0x49, 0x46, 0x46]
```

**ç¨‹å¼ç¢¼å“è³ª**: â­â­â­â­â­

---

### âœ… Scenario 4: æ‹’çµ•è¶…åƒç´ åœ–ç‰‡
**æª”æ¡ˆ**: `handlers/admin/assets.ts:115-123`

**é©—æ”¶é»**:
- âœ… åƒç´  > 25 MP â†’ 400 Bad Request
- âœ… éŒ¯èª¤è¨Šæ¯æ­£ç¢º

**å°ºå¯¸é©—è­‰å¯¦ä½œ** (`image-validator.ts:50-110`):
```typescript
âœ… æœ€å°å°ºå¯¸: 800x800
âœ… æœ€å¤§åƒç´ : 25,000,000
âœ… æ”¯æ´ JPEG, PNG, WebP å°ºå¯¸æå–
```

**ç¨‹å¼ç¢¼å“è³ª**: â­â­â­â­â­

---

### âœ… Scenario 5: æ‹’çµ•æœªæˆæ¬Šè«‹æ±‚
**æª”æ¡ˆ**: `handlers/admin/assets.ts:19-25`

**é©—æ”¶é»**:
- âœ… ä½¿ç”¨ `verifySetupToken()` ä¸­é–“ä»¶
- âœ… æœªæˆæ¬Š â†’ 401 Unauthorized
- âœ… ä¸è™•ç†æª”æ¡ˆ

**ç¨‹å¼ç¢¼å“è³ª**: â­â­â­â­â­

---

### âœ… Scenario 6: Rate Limiting
**æª”æ¡ˆ**: `handlers/admin/assets.ts:57-67`

**é©—æ”¶é»**:
- âœ… é™åˆ¶: 10 uploads / 10 åˆ†é˜
- âœ… ç¶­åº¦: email + IP
- âœ… è¿”å› 429 Too Many Requests
- âœ… éŒ¯èª¤è¨Šæ¯åŒ…å«é‡è©¦æ™‚é–“

**Rate Limit Key**:
```typescript
upload_rate:{email}:{ip}
TTL: 600 seconds
Max: 10
```

**ç¨‹å¼ç¢¼å“è³ª**: â­â­â­â­â­

---

### âœ… Scenario 7: ç‰ˆæœ¬æ§åˆ¶
**æª”æ¡ˆ**: `handlers/admin/assets.ts:138-152`

**é©—æ”¶é»**:
- âœ… æª¢æŸ¥ç¾æœ‰è³‡ç”¢
- âœ… ç‰ˆæœ¬è™Ÿéå¢
- âœ… è»Ÿåˆªé™¤èˆŠç‰ˆæœ¬ï¼ˆ`soft_deleted_at`ï¼‰
- âœ… R2 ä¿ç•™å…©å€‹ç‰ˆæœ¬

**ç‰ˆæœ¬æ§åˆ¶é‚è¼¯**:
```typescript
âœ… æ–°è³‡ç”¢: version = 1
âœ… æ›´æ–°è³‡ç”¢: version = current_version + 1
âœ… è»Ÿåˆªé™¤: UPDATE asset_versions SET soft_deleted_at = datetime('now')
```

**ç¨‹å¼ç¢¼å“è³ª**: â­â­â­â­â­

---

### âš ï¸ Scenario 8: è‡ªå‹•ç”¢ç”Ÿ Variants
**æª”æ¡ˆ**: `handlers/admin/assets.ts:165-179`

**é©—æ”¶é»**:
- âœ… ç”¢ç”Ÿ 2 å€‹ variantsï¼ˆdetail + thumbï¼‰
- âœ… ä¸¦è¡Œä¸Šå‚³ï¼ˆ`Promise.all`ï¼‰
- âš ï¸ **å•é¡Œ**: æœªå¯¦éš›è™•ç†åœ–ç‰‡ï¼ˆåƒ…ä¸Šå‚³åŸå§‹æª”æ¡ˆï¼‰

**å•é¡Œåˆ†æ** (`image-processor.ts:20-60`):
```typescript
// âŒ ç›®å‰å¯¦ä½œ
export async function processImage(
  buffer: ArrayBuffer,
  variant: ImageVariant
): Promise<ArrayBuffer> {
  // ... é…ç½®æ­£ç¢º
  
  // âŒ ä½†æœ€å¾Œç›´æ¥è¿”å›åŸå§‹ buffer
  return buffer;
}
```

**å½±éŸ¿**:
- âŒ æœªå£“ç¸®åœ–ç‰‡ï¼ˆæª”æ¡ˆå¤§å°æœªæ¸›å°‘ï¼‰
- âŒ æœªè½‰æ›ç‚º WebP æ ¼å¼
- âŒ æœªèª¿æ•´å°ºå¯¸ï¼ˆ1200x1200, 256x256ï¼‰
- âŒ æœªæ¸…é™¤ EXIF è³‡æ–™

**å»ºè­°ä¿®æ­£**:
```typescript
// é¸é … 1: ä½¿ç”¨ Cloudflare Image Resizing API
// éœ€è¦é€é fetch å‘¼å«å¤–éƒ¨æœå‹™

// é¸é … 2: ä½¿ç”¨ R2 Transform on Read
// åœ¨è®€å–æ™‚å‹•æ…‹è½‰æ›ï¼ˆæ¨è–¦ï¼‰

// é¸é … 3: ä½¿ç”¨ Workers å…§å»º Image Resizing
// éœ€è¦ä»˜è²»æ–¹æ¡ˆ
```

**ç¨‹å¼ç¢¼å“è³ª**: â­â­â­ (åŠŸèƒ½ä¸å®Œæ•´)

---

## ğŸ“Š æ•´é«”è©•åˆ†

### åŠŸèƒ½å®Œæ•´åº¦
```
7/8 scenarios å®Œå…¨å¯¦ä½œ = 87.5%
1/8 scenarios éƒ¨åˆ†å¯¦ä½œ = 12.5%
```

### ç¨‹å¼ç¢¼å“è³ª
```
âœ… çµæ§‹æ¸…æ™°ï¼ˆæ¨¡çµ„åŒ–è¨­è¨ˆï¼‰
âœ… éŒ¯èª¤è™•ç†å®Œæ•´
âœ… é¡å‹å®šç¾©æ­£ç¢º
âœ… ç¬¦åˆ BDD è¦æ ¼
âš ï¸ åœ–ç‰‡è™•ç†æœªå¯¦ä½œ
```

### å®‰å…¨æ€§
```
âœ… ç®¡ç†å“¡èªè­‰
âœ… Rate Limiting
âœ… Magic Bytes é©—è­‰
âœ… æª”æ¡ˆå¤§å°é™åˆ¶
âœ… åƒç´ é™åˆ¶
âš ï¸ EXIF æ¸…é™¤æœªå¯¦ä½œï¼ˆä¾è³´åœ–ç‰‡è™•ç†ï¼‰
```

### æ•ˆèƒ½
```
âœ… ä¸¦è¡Œä¸Šå‚³ variants
âš ï¸ æœªå£“ç¸®åœ–ç‰‡ï¼ˆæª”æ¡ˆå¤§å°æœªå„ªåŒ–ï¼‰
âš ï¸ è™•ç†æ™‚é–“å¯èƒ½è¶…é 5sï¼ˆå¤§æª”æ¡ˆï¼‰
```

---

## ğŸ”§ å¿…è¦ä¿®æ­£é …ç›®

### ğŸ”´ P0: åœ–ç‰‡è™•ç†å¯¦ä½œ

**å•é¡Œ**: `processImage()` å‡½æ•¸æœªå¯¦éš›è™•ç†åœ–ç‰‡

**å½±éŸ¿**:
- ç„¡æ³•é”æˆå£“ç¸®ç‡ > 50% çš„ç›®æ¨™
- ç„¡æ³•ç”¢ç”Ÿä¸åŒå°ºå¯¸çš„ variants
- ç„¡æ³•æ¸…é™¤ EXIF è³‡æ–™

**å»ºè­°æ–¹æ¡ˆ**:

#### æ–¹æ¡ˆ A: R2 Transform on Readï¼ˆæ¨è–¦ï¼‰âœ…
```typescript
// ä¸Šå‚³æ™‚å„²å­˜åŸå§‹æª”æ¡ˆ
await env.PHYSICAL_CARDS.put(key, buffer, {
  httpMetadata: { contentType: file.type }
});

// è®€å–æ™‚é€é URL åƒæ•¸è½‰æ›
// GET /api/assets/:id/content?variant=detail
// â†’ R2 URL: /key?width=1200&format=webp&quality=85
```

**å„ªå‹¢**:
- âœ… ç„¡éœ€é¡å¤–è™•ç†æ™‚é–“
- âœ… ç¯€çœå„²å­˜ç©ºé–“ï¼ˆåªå­˜åŸå§‹æª”ï¼‰
- âœ… å‹•æ…‹èª¿æ•´å°ºå¯¸
- âœ… è‡ªå‹• EXIF æ¸…é™¤

**ç¼ºé»**:
- âš ï¸ éœ€è¦ R2 Custom Domainï¼ˆå…è²»ï¼‰
- âš ï¸ é¦–æ¬¡è¼‰å…¥è¼ƒæ…¢ï¼ˆå¾ŒçºŒå¿«å–ï¼‰

#### æ–¹æ¡ˆ B: Cloudflare Image Resizing API
```typescript
// éœ€è¦ä»˜è²»æ–¹æ¡ˆï¼ˆImage Resizingï¼‰
// æ¯æœˆ $5 èµ·
```

#### æ–¹æ¡ˆ C: ç¬¬ä¸‰æ–¹æœå‹™ï¼ˆSharp.js via Denoï¼‰
```typescript
// éœ€è¦é¡å¤–éƒ¨ç½² Deno Worker
// è¤‡é›œåº¦è¼ƒé«˜
```

**æ¨è–¦**: æ–¹æ¡ˆ Aï¼ˆR2 Transform on Readï¼‰

---

## âœ… é©—æ”¶çµè«–

### æ•´é«”è©•åƒ¹: **è‰¯å¥½ï¼ˆéœ€å°å¹…ä¿®æ­£ï¼‰**

**å„ªé»**:
- âœ… 7/8 scenarios å®Œæ•´å¯¦ä½œ
- âœ… ç¨‹å¼ç¢¼çµæ§‹æ¸…æ™°
- âœ… å®‰å…¨é©—è­‰å®Œæ•´
- âœ… éŒ¯èª¤è™•ç†æ­£ç¢º
- âœ… ç‰ˆæœ¬æ§åˆ¶å®Œå–„

**éœ€æ”¹é€²**:
- âš ï¸ åœ–ç‰‡è™•ç†æœªå¯¦ä½œï¼ˆå»ºè­°æ¡ç”¨ R2 Transform on Readï¼‰
- âš ï¸ æ•ˆèƒ½å„ªåŒ–ç©ºé–“ï¼ˆå£“ç¸®ã€æ ¼å¼è½‰æ›ï¼‰

### å»ºè­°è¡Œå‹•

**é¸é … 1**: æ¥å—ç¾ç‹€ï¼Œæ”¹ç”¨ R2 Transform on Read
- ä¿®æ”¹è®€å– API å¯¦ä½œå‹•æ…‹è½‰æ›
- æ›´æ–°æ–‡æª”èªªæ˜

**é¸é … 2**: å¯¦ä½œå®Œæ•´åœ–ç‰‡è™•ç†
- æ•´åˆ Cloudflare Image Resizing API
- éœ€è¦ä»˜è²»æ–¹æ¡ˆ

**é¸é … 3**: å…ˆéƒ¨ç½²æ¸¬è©¦ï¼Œå¾ŒçºŒå„ªåŒ–
- ç›®å‰åŠŸèƒ½å¯ç”¨ï¼ˆåƒ…æª”æ¡ˆè¼ƒå¤§ï¼‰
- é€æ­¥å„ªåŒ–æ•ˆèƒ½

---

## ğŸ“ é©—æ”¶ç°½æ ¸

**é©—æ”¶ç‹€æ…‹**: âœ… **æœ‰æ¢ä»¶é€šé**

**æ¢ä»¶**: éœ€é¸æ“‡åœ–ç‰‡è™•ç†æ–¹æ¡ˆä¸¦å¯¦ä½œ

**å»ºè­°**: æ¡ç”¨æ–¹æ¡ˆ Aï¼ˆR2 Transform on Readï¼‰

**ä¸‹ä¸€æ­¥**: 
1. ç¢ºèªåœ–ç‰‡è™•ç†æ–¹æ¡ˆ
2. å¯¦ä½œè®€å– APIï¼ˆå«å‹•æ…‹è½‰æ›ï¼‰
3. æ•´åˆæ¸¬è©¦

---

**é©—æ”¶äºº**: Amazon Q Dev CLI  
**æ—¥æœŸ**: 2026-01-28 10:48
