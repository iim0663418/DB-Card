# Card Display API æ€§èƒ½åˆ†æå ±å‘Š

**åˆ†ææ™‚é–“**: 2026-01-20T23:21:00+08:00  
**åˆ†æç¯„åœ**: card-display.html + /api/read ç«¯é»  
**ç•¶å‰ç‰ˆæœ¬**: v4.2.0

---

## 1. ç•¶å‰æ¶æ§‹åˆ†æ

### 1.1 å‰ç«¯è«‹æ±‚æµç¨‹
```
ç”¨æˆ¶è¨ªå• card-display.html
  â†“
è§£æ URL åƒæ•¸ (uuid, session)
  â†“
èª¿ç”¨ readCard(uuid, sessionId) [api.js]
  â†“
fetch /api/read?uuid=xxx&session=yyy
  â†“
æ¸²æŸ“åç‰‡è³‡æ–™
```

### 1.2 å¾Œç«¯è™•ç†æµç¨‹ (handlers/read.ts)
```
1. åƒæ•¸é©—è­‰ (uuid, session)
2. æª¢æŸ¥éŸ¿æ‡‰å¿«å– (KV: read:uuid:session, 60s TTL) âœ“
3. æŸ¥è©¢ read_sessions è¡¨ (é©—è­‰ session)
4. é©—è­‰ session (expires_at, revoked_at, max_reads)
5. æŸ¥è©¢ cards è¡¨ (encrypted_payload, wrapped_dek)
6. è§£å¯†å¡ç‰‡è³‡æ–™:
   - æª¢æŸ¥å¡ç‰‡å¿«å– (KV: card:uuid, 300s TTL) âœ“
   - è‹¥ç„¡å¿«å–: unwrap DEK + decrypt payload
   - å¯«å…¥å¿«å–
7. æ›´æ–° reads_used (éåŒæ­¥)
8. è¨˜éŒ„ audit log (éåŒæ­¥)
9. è¿”å›éŸ¿æ‡‰ + å¯«å…¥éŸ¿æ‡‰å¿«å–
```

---

## 2. å·²å¯¦ä½œçš„å„ªåŒ–

### âœ… å¾Œç«¯å„ªåŒ– (v4.0.1 - P0 Backend Optimization)

| å„ªåŒ–é …ç›® | å¯¦ä½œä½ç½® | æ•ˆæœ | TTL |
|---------|---------|------|-----|
| éŸ¿æ‡‰å¿«å– | `responseCacheKey` | å®Œå…¨è·³éæ‰€æœ‰æŸ¥è©¢ | 60s |
| å¡ç‰‡æ•¸æ“šå¿«å– | `getCachedCardData()` | è·³éè§£å¯†æ“ä½œ | 300s |
| éåŒæ­¥å¯«å…¥ | `ctx.waitUntil()` | æ¸›å°‘éŸ¿æ‡‰æ™‚é–“ | - |
| ä¸¦è¡ŒæŸ¥è©¢ | å·²å„ªåŒ– | æ¸›å°‘ DB å¾€è¿” | - |

**å¯¦æ¸¬æ•ˆæœ** (ä¾†è‡ª v4.0.1):
- Tap API: 0.6s â†’ 0.35s (-42%)
- Read API (å¿«å–å‘½ä¸­): 0.31s â†’ 0.10s (-68%)
- Read API (å¿«å–æœªå‘½ä¸­): 0.31s â†’ 0.15s (-52%)

### âœ… å‰ç«¯å„ªåŒ– (v4.0.1)

| å„ªåŒ–é …ç›® | å¯¦ä½œä½ç½® | æ•ˆæœ |
|---------|---------|------|
| CDN preconnect | `<link rel="preconnect">` | æ¸›å°‘ DNS æŸ¥è©¢ |
| defer è¼‰å…¥ | Three.js, Lucide, QRCode | éé˜»å¡è¼‰å…¥ |
| å»¶é²åˆå§‹åŒ– | Three.js (100ms) | å„ªå…ˆè¼‰å…¥å…§å®¹ |

**å¯¦æ¸¬æ•ˆæœ**:
- é˜»å¡è³‡æº: 6 â†’ 1 (-83%)
- FCP æ”¹å–„: ~200ms

---

## 3. æ€§èƒ½ç“¶é ¸åˆ†æ

### 3.1 é¦–æ¬¡è¨ªå• (Cold Start)
```
ç¸½æ™‚é–“: ~150-200ms (å¿«å–æœªå‘½ä¸­)
â”œâ”€ åƒæ•¸é©—è­‰: ~1ms
â”œâ”€ Session æŸ¥è©¢: ~20-30ms (D1 Database)
â”œâ”€ Session é©—è­‰: ~1ms
â”œâ”€ Card æŸ¥è©¢: ~20-30ms (D1 Database)
â”œâ”€ è§£å¯†æ“ä½œ: ~50-80ms (unwrap DEK + decrypt)
â”‚  â””â”€ ç“¶é ¸: åŠ å¯†é‹ç®— (ç„¡æ³•é¿å…)
â”œâ”€ éåŒæ­¥æ“ä½œ: 0ms (ä¸é˜»å¡éŸ¿æ‡‰)
â””â”€ ç¶²è·¯å‚³è¼¸: ~20-50ms (å–æ±ºæ–¼ç”¨æˆ¶ä½ç½®)
```

### 3.2 ç†±è®€å– (Cache Hit)
```
ç¸½æ™‚é–“: ~50-100ms (éŸ¿æ‡‰å¿«å–å‘½ä¸­)
â”œâ”€ KV æŸ¥è©¢: ~10-20ms
â”œâ”€ ååºåˆ—åŒ–: ~5ms
â””â”€ ç¶²è·¯å‚³è¼¸: ~20-50ms
```

### 3.3 æº«è®€å– (Card Cache Hit)
```
ç¸½æ™‚é–“: ~100-150ms (å¡ç‰‡å¿«å–å‘½ä¸­)
â”œâ”€ Session æŸ¥è©¢: ~20-30ms
â”œâ”€ Session é©—è­‰: ~1ms
â”œâ”€ Card æŸ¥è©¢: ~20-30ms
â”œâ”€ KV å¿«å–è®€å–: ~10-20ms (è·³éè§£å¯†)
â”œâ”€ éåŒæ­¥æ“ä½œ: 0ms
â””â”€ ç¶²è·¯å‚³è¼¸: ~20-50ms
```

---

## 4. å„ªåŒ–å»ºè­°

### ğŸŸ¢ P0: å‰ç«¯å¿«å– (ç«‹å³å¯è¡Œ, é«˜å½±éŸ¿)

**å•é¡Œ**: ç”¨æˆ¶åœ¨åŒä¸€ session å…§é‡æ–°æ•´ç†é é¢æœƒé‡è¤‡è«‹æ±‚ API

**æ–¹æ¡ˆ**: å¯¦ä½œå‰ç«¯ sessionStorage å¿«å–

```javascript
// åœ¨ api.js çš„ readCard() å‡½æ•¸ä¸­åŠ å…¥
export async function readCard(uuid, sessionId) {
  // æª¢æŸ¥ sessionStorage å¿«å–
  const cacheKey = `card:${uuid}:${sessionId}`;
  const cached = sessionStorage.getItem(cacheKey);
  
  if (cached) {
    const { data, timestamp } = JSON.parse(cached);
    // å¿«å– 5 åˆ†é˜
    if (Date.now() - timestamp < 300000) {
      return data;
    }
  }
  
  // åŸæœ‰çš„ fetch é‚è¼¯
  const response = await fetch(...);
  const result = await response.json();
  
  // å¯«å…¥å¿«å–
  sessionStorage.setItem(cacheKey, JSON.stringify({
    data: result,
    timestamp: Date.now()
  }));
  
  return result;
}
```

**é æœŸæ•ˆæœ**:
- é‡æ–°æ•´ç†é é¢: 200ms â†’ <10ms (-95%)
- æ¸›å°‘ API è«‹æ±‚: ~50% (ç”¨æˆ¶è¡Œç‚ºä¾è³´)

---

### ğŸŸ¡ P1: Service Worker å¿«å– (ä¸­æœŸ, ä¸­å½±éŸ¿)

**å•é¡Œ**: é›¢ç·šæˆ–å¼±ç¶²ç’°å¢ƒä¸‹ç„¡æ³•è¨ªå•

**æ–¹æ¡ˆ**: å¯¦ä½œ Service Worker å¿«å–ç­–ç•¥

```javascript
// sw.js
self.addEventListener('fetch', (event) => {
  if (event.request.url.includes('/api/read')) {
    event.respondWith(
      caches.open('api-cache-v1').then((cache) => {
        return cache.match(event.request).then((response) => {
          // å¿«å–å„ªå…ˆï¼Œç¶²è·¯å›é€€
          return response || fetch(event.request).then((networkResponse) => {
            cache.put(event.request, networkResponse.clone());
            return networkResponse;
          });
        });
      })
    );
  }
});
```

**é æœŸæ•ˆæœ**:
- é›¢ç·šè¨ªå•: æ”¯æ´
- å¼±ç¶²ç’°å¢ƒ: 200ms â†’ <50ms

---

### ğŸŸ¡ P2: é è¼‰å…¥å„ªåŒ– (ä¸­æœŸ, ä½å½±éŸ¿)

**å•é¡Œ**: ç”¨æˆ¶é»æ“Š QR Code å¾Œæ‰é–‹å§‹è¼‰å…¥è³‡æº

**æ–¹æ¡ˆ**: åœ¨ NFC tap é é¢é è¼‰å…¥é—œéµè³‡æº

```html
<!-- åœ¨ tap æˆåŠŸå¾Œçš„è·³è½‰é é¢åŠ å…¥ -->
<link rel="prefetch" href="/card-display.html">
<link rel="prefetch" href="/js/main.js">
<link rel="prefetch" href="/js/api.js">
```

**é æœŸæ•ˆæœ**:
- é é¢è¼‰å…¥: -50-100ms

---

### ğŸ”µ P3: è³‡æ–™åº«é€£æ¥æ±  (é•·æœŸ, ä½å½±éŸ¿)

**å•é¡Œ**: D1 Database æŸ¥è©¢å»¶é² (20-30ms)

**æ–¹æ¡ˆ**: Cloudflare Workers å·²è‡ªå‹•å„ªåŒ–ï¼Œç„¡éœ€é¡å¤–è™•ç†

**ç¾ç‹€**: D1 æŸ¥è©¢å·²ç¶“å¾ˆå¿« (20-30ms)ï¼Œé€²ä¸€æ­¥å„ªåŒ–ç©ºé–“æœ‰é™

---

## 5. ä¸å»ºè­°çš„å„ªåŒ–

### âŒ æ¸›å°‘å¿«å– TTL
- **åŸå› **: ç•¶å‰ 60s/300s å·²ç¶“å¹³è¡¡äº†æ–°é®®åº¦å’Œæ€§èƒ½
- **é¢¨éšª**: éçŸ­æœƒå¢åŠ  API è² è¼‰ï¼Œéé•·æœƒå°è‡´æ•¸æ“šä¸åŒæ­¥

### âŒ ç§»é™¤è§£å¯†æ“ä½œ
- **åŸå› **: å®‰å…¨æ€§æ ¸å¿ƒè¦æ±‚ï¼Œä¸å¯å¦¥å”
- **æ›¿ä»£**: å·²é€éå¿«å–æœ€å°åŒ–è§£å¯†æ¬¡æ•¸

### âŒ åˆä½µ session å’Œ card æŸ¥è©¢
- **åŸå› **: å·²ç¶“æ˜¯å–®æ¬¡æŸ¥è©¢ï¼ŒJOIN ä¸æœƒæ›´å¿«
- **ç¾ç‹€**: å…©æ¬¡æŸ¥è©¢æ˜¯å¿…è¦çš„ï¼ˆé©—è­‰ + æ•¸æ“šï¼‰

---

## 6. æ€§èƒ½åŸºæº– (Baseline)

### ç•¶å‰æ€§èƒ½ (v4.2.0)
| å ´æ™¯ | éŸ¿æ‡‰æ™‚é–“ | è©•ç´š |
|------|---------|------|
| é¦–æ¬¡è¨ªå• (Cold) | 150-200ms | ğŸŸ¢ å„ªç§€ |
| ç†±è®€å– (Cache Hit) | 50-100ms | ğŸŸ¢ å„ªç§€ |
| æº«è®€å– (Card Cache) | 100-150ms | ğŸŸ¢ å„ªç§€ |

### ç›®æ¨™æ€§èƒ½ (å¯¦ä½œ P0 å¾Œ)
| å ´æ™¯ | éŸ¿æ‡‰æ™‚é–“ | æ”¹å–„ |
|------|---------|------|
| é¦–æ¬¡è¨ªå• | 150-200ms | - |
| é‡æ–°æ•´ç† | <10ms | -95% |
| ç†±è®€å– | 50-100ms | - |

---

## 7. å¯¦ä½œå„ªå…ˆç´š

### ç«‹å³å¯¦ä½œ (æœ¬é€±)
- âœ… P0: å‰ç«¯ sessionStorage å¿«å–

### çŸ­æœŸå¯¦ä½œ (2 é€±å…§)
- â³ P1: Service Worker å¿«å–ç­–ç•¥
- â³ P2: é è¼‰å…¥å„ªåŒ–

### é•·æœŸè§€å¯Ÿ
- ğŸ“Š ç›£æ§å¯¦éš›ç”¨æˆ¶æ€§èƒ½æ•¸æ“š
- ğŸ“Š åˆ†æå¿«å–å‘½ä¸­ç‡
- ğŸ“Š è©•ä¼°æ˜¯å¦éœ€è¦é€²ä¸€æ­¥å„ªåŒ–

---

## 8. çµè«–

**ç•¶å‰ç‹€æ…‹**: ğŸŸ¢ æ€§èƒ½å„ªç§€

card-display.html çš„ API éŸ¿æ‡‰é€Ÿåº¦å·²ç¶“è™•æ–¼å„ªç§€æ°´å¹³ (150-200ms é¦–æ¬¡è¨ªå•ï¼Œ50-100ms å¿«å–å‘½ä¸­)ã€‚ä¸»è¦å„ªåŒ–ç©ºé–“åœ¨æ–¼ï¼š

1. **å‰ç«¯å¿«å–** (P0): å¯å¤§å¹…æ¸›å°‘é‡è¤‡è«‹æ±‚
2. **é›¢ç·šæ”¯æ´** (P1): æå‡ç”¨æˆ¶é«”é©—
3. **é è¼‰å…¥** (P2): é‚Šéš›æ”¹å–„

**å»ºè­°**: å„ªå…ˆå¯¦ä½œ P0 å‰ç«¯å¿«å–ï¼Œå…¶ä»–å„ªåŒ–å¯æ ¹æ“šå¯¦éš›ç”¨æˆ¶åé¥‹æ±ºå®šã€‚

---

**å ±å‘Šç”¢ç”Ÿ**: 2026-01-20T23:21:00+08:00  
**åˆ†æå·¥å…·**: ä»£ç¢¼å¯©æŸ¥ + æ¶æ§‹åˆ†æ  
**ä¸‹ä¸€æ­¥**: å¯¦ä½œ P0 å‰ç«¯ sessionStorage å¿«å–
