# 撤銷後發新名片 - 使用指南

## 📋 當前設計說明

### 核心機制
DB-Card 使用 **UNIQUE INDEX** 限制每個用戶每種類型只能有 **1 張 active 名片**：

```sql
CREATE UNIQUE INDEX idx_uuid_bindings_email_type
  ON uuid_bindings(bound_email, type)
  WHERE status = 'bound';
```

**關鍵點**：
- 限制只適用於 `status = 'bound'` 的卡片
- 撤銷後（`status = 'revoked'`），該限制不再生效
- 用戶可以立即創建同類型的新卡片

---

## 🎯 使用場景與解決方案

### 場景 1: 資訊需要更新（推薦）✅
**情況**: 職位變更、聯絡方式更新、照片更換

**方案 A - 恢復並編輯**（最快）:
1. 點擊「恢復名片」
2. 點擊「編輯」
3. 更新資訊
4. 保存

**優點**:
- ✅ 保留原有 UUID（分享連結不變）
- ✅ 保留歷史記錄
- ✅ 最快速度

**方案 B - 撤銷後創建新卡片**:
1. 撤銷舊卡片
2. 創建新卡片（同類型）
3. 系統自動生成新 UUID

**優點**:
- ✅ 全新開始
- ✅ 舊連結完全失效
- ✅ 清晰的版本管理

---

### 場景 2: 卡片遺失或外洩（緊急）🚨
**情況**: NFC 卡片遺失、QR code 被惡意傳播

**步驟**:
1. **立即撤銷**（所有分享連結立即失效）
2. **等待確認**（確保沒有誤報）
3. **選擇處理方式**:
   - **找回卡片**: 恢復名片
   - **確認遺失**: 創建新卡片

**時間窗口**: 7 天內可自助恢復

---

### 場景 3: 測試或臨時使用
**情況**: 展會、活動、測試

**步驟**:
1. 創建 `event_booth` 類型卡片
2. 活動結束後撤銷
3. 下次活動創建新卡片

**優點**:
- ✅ 每次活動獨立 UUID
- ✅ 歷史記錄清晰
- ✅ 不影響 personal 卡片

---

## 🔄 三種處理方式對比

| 方式 | 適用場景 | UUID | 歷史記錄 | 速度 |
|------|---------|------|---------|------|
| **恢復並編輯** | 資訊更新 | 保留 | 保留 | ⚡ 最快 |
| **撤銷後創建** | 全新開始 | 新 UUID | 獨立 | 🔄 中等 |
| **永久刪除後創建** | 清理測試資料 | 新 UUID | 清除 | 🗑️ 最慢 |

---

## 📊 當前限制

### 每種類型限制
```
personal: 1 張 active
event_booth: 1 張 active  
sensitive: 1 張 active
```

### 撤銷後狀態
```
personal (revoked): 不計入限制
personal (bound): 可以創建 ✅
```

### 範例
```
用戶 A 的卡片狀態：
├─ personal (revoked) - 舊卡片
└─ personal (bound) - 新卡片 ✅ 允許

用戶 B 的卡片狀態：
├─ personal (bound) - 當前卡片
└─ personal (bound) - 新卡片 ❌ 不允許（違反 UNIQUE INDEX）
```

---

## 🛠️ 實際操作步驟

### 方式 1: 恢復並編輯（推薦）

1. **登入 User Portal**
   ```
   https://db-card-staging.csw30454.workers.dev/user-portal.html
   ```

2. **找到已撤銷的卡片**
   - 狀態顯示：「已撤銷」
   - 顯示恢復期限（7 天內）

3. **點擊「恢復名片」**
   - 確認恢復
   - 卡片狀態變為「已綁定」

4. **點擊「編輯」**
   - 更新資訊
   - 保存

**結果**: 
- ✅ UUID 不變
- ✅ 分享連結繼續有效
- ✅ 更新後的資訊立即生效

---

### 方式 2: 創建新卡片

1. **確認舊卡片已撤銷**
   - 狀態：「已撤銷」

2. **點擊「創建新名片」**
   - 選擇類型（personal/event_booth/sensitive）
   - 填寫資訊

3. **保存**
   - 系統生成新 UUID
   - 舊卡片保持 revoked 狀態

**結果**:
- ✅ 新 UUID
- ✅ 舊連結失效
- ✅ 新連結獨立

---

### 方式 3: 永久刪除後創建（管理員）

**注意**: 只有管理員可以永久刪除

1. **管理員登入 Admin Dashboard**

2. **找到已撤銷的卡片**

3. **點擊「永久刪除」**
   - 二次確認
   - 從資料庫完全移除

4. **用戶創建新卡片**
   - 不受任何限制

**用途**: 清理測試資料、重置用戶名片

---

## ⚠️ 注意事項

### 1. 撤銷是可逆的（7 天內）
- 撤銷後可以恢復
- 超過 7 天需聯繫管理員

### 2. 創建新卡片前確認
- 確認舊卡片已撤銷
- 確認不需要保留舊 UUID

### 3. Rate Limiting
- 每小時最多撤銷 3 次
- 每天最多撤銷 10 次
- 超限需等待

### 4. 類型選擇
- personal: 日常使用
- event_booth: 展會活動
- sensitive: 敏感資訊（限制讀取次數）

---

## 🎯 最佳實踐

### 日常使用
```
推薦：恢復並編輯
原因：保留 UUID，分享連結不變
```

### 緊急情況
```
推薦：撤銷後創建新卡片
原因：舊連結完全失效，安全性最高
```

### 測試環境
```
推薦：永久刪除後創建
原因：清理測試資料，避免混淆
```

---

## 📝 FAQ

### Q1: 撤銷後多久可以創建新卡片？
**A**: 立即可以。撤銷後 `status = 'revoked'`，不受 UNIQUE INDEX 限制。

### Q2: 創建新卡片後，舊卡片還能恢復嗎？
**A**: 可以。但恢復後會有 2 張同類型卡片（1 bound + 1 revoked），需要再次撤銷其中一張。

### Q3: 如何完全清除舊卡片？
**A**: 聯繫管理員使用「永久刪除」功能。

### Q4: 撤銷會影響其他類型的卡片嗎？
**A**: 不會。每種類型獨立管理。

### Q5: Rate Limiting 會影響創建新卡片嗎？
**A**: 不會。Rate Limiting 只限制撤銷操作，不限制創建。

---

## 🔗 相關文檔

- [User Self-Revoke BDD 規格](../.specify/specs/user-self-revoke.md)
- [測試結果報告](../.specify/USER-REVOKE-TEST-RESULTS.md)
- [資料庫架構](../workers/migrations/0004_uuid_bindings_v2.sql)

---

**總結**: 當前設計完全支援撤銷後創建新卡片，用戶可根據實際需求選擇最適合的處理方式。
