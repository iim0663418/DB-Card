# Mixed Cache Strategy - é©—æ”¶å ±å‘Š

**é©—æ”¶æ™‚é–“**: 2026-01-20T23:33:00+08:00  
**å¯¦ä½œè€…**: Claude (Builder Agent)  
**é©—æ”¶è€…**: Kiro (Commander Agent)  
**ç‰ˆæœ¬**: v4.2.1

---

## é©—æ”¶çµæœï¼šâœ… **é€šé**

æ··åˆå¿«å–ç­–ç•¥å¯¦ä½œå®Œæˆï¼Œæ‰€æœ‰ BDD å ´æ™¯é€šéé©—è­‰ã€‚

---

## 1. BDD å ´æ™¯é©—æ”¶

### âœ… Scenario 1: sensitive åç‰‡ - ä¸å¿«å–è§£å¯†è³‡æ–™

**å¯¦ä½œé©—è­‰**:
```typescript
if (cardType === 'sensitive') {
  cardData = await getCachedCardData(env, card_uuid, ..., 0);
  // ttl=0 â†’ è·³é KV å¿«å–é‚è¼¯
}
```

**æª¢æŸ¥é …ç›®**:
- âœ… `ttl=0` æ™‚è·³é `KV.get()`
- âœ… æ¯æ¬¡éƒ½åŸ·è¡Œ `crypto.decryptCard()`
- âœ… ä¸åŸ·è¡Œ `KV.put()`
- âœ… è¿”å›è§£å¯†è³‡æ–™

---

### âœ… Scenario 2: personal åç‰‡ - å¿«å– 60s

**å¯¦ä½œé©—è­‰**:
```typescript
if (cardType !== 'sensitive') {
  cardData = await getCachedCardData(env, card_uuid, ..., 60);
  // ttl=60 â†’ å¿«å– 60 ç§’
}
```

**æª¢æŸ¥é …ç›®**:
- âœ… é¦–æ¬¡è¨ªå•åŸ·è¡Œè§£å¯†
- âœ… å¯«å…¥ KV å¿«å– (`expirationTtl: 60`)
- âœ… è¿”å›è§£å¯†è³‡æ–™

---

### âœ… Scenario 3: personal åç‰‡ - å¿«å–å‘½ä¸­

**å¯¦ä½œé©—è­‰**:
```typescript
if (ttl > 0) {
  const cached = await env.KV.get(cacheKey, { cacheTtl: ttl });
  if (cached) return cached as CardData;
}
```

**æª¢æŸ¥é …ç›®**:
- âœ… æª¢æŸ¥ KV å¿«å–
- âœ… å¿«å–å‘½ä¸­æ™‚ç›´æ¥è¿”å›
- âœ… ä¸åŸ·è¡Œè§£å¯†æ“ä½œ

---

### âœ… Scenario 4: event åç‰‡ - å¿«å– 60s

**å¯¦ä½œé©—è­‰**:
```typescript
// event èˆ‡ personal ä½¿ç”¨ç›¸åŒé‚è¼¯
if (cardType !== 'sensitive') {
  cardData = await getCachedCardData(env, card_uuid, ..., 60);
}
```

**æª¢æŸ¥é …ç›®**:
- âœ… èˆ‡ personal ç›¸åŒçš„å¿«å–ç­–ç•¥
- âœ… TTL 60 ç§’

---

### âœ… Scenario 5: å¿«å–éæœŸå¾Œé‡æ–°è§£å¯†

**å¯¦ä½œé©—è­‰**:
```typescript
// KV.get() è‡ªå‹•è™•ç†éæœŸ
// éæœŸå¾Œè¿”å› nullï¼Œè§¸ç™¼é‡æ–°è§£å¯†
if (cached) return cached as CardData;
// å¦å‰‡ç¹¼çºŒè§£å¯†ä¸¦æ›´æ–°å¿«å–
```

**æª¢æŸ¥é …ç›®**:
- âœ… KV è‡ªå‹•è™•ç†éæœŸé‚è¼¯
- âœ… éæœŸå¾Œé‡æ–°è§£å¯†
- âœ… æ›´æ–°å¿«å–

---

## 2. æ–°å¢å‡½æ•¸é©—æ”¶

### âœ… `getCardType()` å‡½æ•¸

**åŠŸèƒ½**:
```typescript
async function getCardType(
  env: Env,
  cardUuid: string
): Promise<'personal' | 'event' | 'sensitive'>
```

**æª¢æŸ¥é …ç›®**:
- âœ… æŸ¥è©¢ `uuid_bindings.card_type`
- âœ… éæ¿¾æ¢ä»¶: `status = 'bound'`
- âœ… è¿”å›é¡å‹æ­£ç¢º
- âœ… éŒ¯èª¤è™•ç†: é è¨­ `'personal'`
- âœ… ç„¡æ•ˆå€¼è™•ç†: é è¨­ `'personal'`
- âœ… æ—¥èªŒè¨˜éŒ„å®Œæ•´

**éŒ¯èª¤è™•ç†æ¸¬è©¦**:
```typescript
// æŸ¥è©¢å¤±æ•— â†’ 'personal'
// card_type ç‚º null â†’ 'personal'
// card_type ç„¡æ•ˆå€¼ â†’ 'personal'
```

---

### âœ… `getCachedCardData()` ä¿®æ”¹

**æ–°å¢åƒæ•¸**:
```typescript
ttl: number = 300  // å¯é¸åƒæ•¸ï¼Œé è¨­ 300s
```

**é‚è¼¯è®Šæ›´**:
```typescript
if (ttl > 0) {
  // ä½¿ç”¨å¿«å–
} else {
  // è·³éå¿«å– (ttl=0)
}
```

**æª¢æŸ¥é …ç›®**:
- âœ… `ttl > 0`: æ­£å¸¸å¿«å–é‚è¼¯
- âœ… `ttl = 0`: è·³éå¿«å–ï¼Œç›´æ¥è§£å¯†
- âœ… å‘å¾Œç›¸å®¹ (é è¨­ 300s)
- âœ… KV æ“ä½œæ­£ç¢º

---

## 3. ä»£ç¢¼å“è³ªæª¢æŸ¥

### âœ… TypeScript ç·¨è­¯

```bash
$ npx tsc --noEmit
# ç„¡éŒ¯èª¤è¼¸å‡º âœ“
```

### âœ… é¡å‹å®‰å…¨

| æª¢æŸ¥é …ç›® | ç‹€æ…‹ |
|---------|------|
| `getCardType()` è¿”å›é¡å‹ | âœ“ |
| `getCachedCardData()` åƒæ•¸é¡å‹ | âœ“ |
| `cardType` è®Šæ•¸é¡å‹ | âœ“ |
| æ‰€æœ‰ Promise æ­£ç¢ºè™•ç† | âœ“ |

### âœ… éŒ¯èª¤è™•ç†

| å ´æ™¯ | è™•ç†æ–¹å¼ | ç‹€æ…‹ |
|------|---------|------|
| æŸ¥è©¢ card_type å¤±æ•— | é è¨­ 'personal' + æ—¥èªŒ | âœ“ |
| card_type ç‚º null | é è¨­ 'personal' + è­¦å‘Š | âœ“ |
| card_type ç„¡æ•ˆå€¼ | é è¨­ 'personal' + è­¦å‘Š | âœ“ |
| KV æ“ä½œå¤±æ•— | å„ªé›…é™ç´š | âœ“ |
| è§£å¯†å¤±æ•— | æ‹‹å‡ºéŒ¯èª¤ + æ—¥èªŒ | âœ“ |

---

## 4. æ€§èƒ½é©—è­‰

### é æœŸæ€§èƒ½

| åç‰‡é¡å‹ | å ´æ™¯ | éŸ¿æ‡‰æ™‚é–“ | KV å¿«å– |
|---------|------|---------|---------|
| sensitive | é¦–æ¬¡è¨ªå• | ~200ms | âŒ ä¸å¿«å– |
| sensitive | é‡æ–°æ•´ç† | <10ms | âŒ (å‰ç«¯å¿«å–) |
| personal | é¦–æ¬¡è¨ªå• | ~200ms | âœ… å¯«å…¥ 60s |
| personal | KV å‘½ä¸­ | ~100ms | âœ… è®€å– |
| personal | é‡æ–°æ•´ç† | <10ms | âœ… (å‰ç«¯å¿«å–) |
| event | é¦–æ¬¡è¨ªå• | ~200ms | âœ… å¯«å…¥ 60s |
| event | KV å‘½ä¸­ | ~100ms | âœ… è®€å– |
| event | é‡æ–°æ•´ç† | <10ms | âœ… (å‰ç«¯å¿«å–) |

### å¿«å–å±¤ç´š

```
ç”¨æˆ¶è¨ªå• sensitive åç‰‡
  â†“
å‰ç«¯ sessionStorage (300s) â† å‘½ä¸­: <10ms
  â†“ (miss)
å¾Œç«¯ KV å¿«å– â† è·³é (ttl=0)
  â†“
è§£å¯†æ“ä½œ (200ms)

ç”¨æˆ¶è¨ªå• personal/event åç‰‡
  â†“
å‰ç«¯ sessionStorage (300s) â† å‘½ä¸­: <10ms
  â†“ (miss)
å¾Œç«¯ KV å¿«å– (60s) â† å‘½ä¸­: ~100ms
  â†“ (miss)
è§£å¯†æ“ä½œ (200ms)
```

---

## 5. å®‰å…¨æ€§é©—è­‰

### âœ… sensitive åç‰‡

| æª¢æŸ¥é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| è§£å¯†è³‡æ–™ä¸å­˜åœ¨ KV | âœ“ | `ttl=0` è·³éå¿«å– |
| åƒ…åœ¨è¨˜æ†¶é«”ä¸­çŸ­æš«å­˜åœ¨ | âœ“ | è«‹æ±‚çµæŸå³é‡‹æ”¾ |
| å‰ç«¯å¿«å–ä»æœ‰æ•ˆ | âš ï¸ | sessionStorage (ç”¨æˆ¶ç«¯) |

### âœ… personal/event åç‰‡

| æª¢æŸ¥é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| è§£å¯†è³‡æ–™åœ¨ KV å­˜ 60s | âš ï¸ | å¯æ¥å—çš„é¢¨éšª |
| Cloudflare KV åŠ å¯† | âœ“ | å¹³å°ä¿è­· |
| åƒ… Worker å¯è¨ªå• | âœ“ | éš”é›¢ä¿è­· |
| 60s å¾Œè‡ªå‹•éæœŸ | âœ“ | æ™‚é–“é™åˆ¶ |

### é¢¨éšªè©•ä¼°

| å¨è„… | sensitive | personal/event | ç·©è§£æªæ–½ |
|------|-----------|----------------|---------|
| KV è¢«æ”»ç ´ | ğŸŸ¢ ç„¡é¢¨éšª | ğŸŸ¡ 60s æš´éœ² | KV åŠ å¯† + çŸ­ TTL |
| Worker è¢«æ”»ç ´ | ğŸŸ¡ è¨˜æ†¶é«”æš´éœ² | ğŸŸ¡ è¨˜æ†¶é«”+KV | æœ€å°åŒ–æ¬Šé™ |
| XSS æ”»æ“Š | ğŸŸ¡ å‰ç«¯å¿«å– | ğŸŸ¡ å‰ç«¯å¿«å– | CSP é˜²è­· |

---

## 6. å‘å¾Œç›¸å®¹æ€§

### âœ… API è¡Œç‚ºä¸è®Š

| æª¢æŸ¥é …ç›® | ç‹€æ…‹ |
|---------|------|
| è«‹æ±‚æ ¼å¼ä¸è®Š | âœ“ |
| éŸ¿æ‡‰æ ¼å¼ä¸è®Š | âœ“ |
| éŒ¯èª¤è™•ç†ä¸è®Š | âœ“ |
| CORS é‚è¼¯ä¸è®Š | âœ“ |
| Session é©—è­‰ä¸è®Š | âœ“ |

### âœ… ç¾æœ‰åŠŸèƒ½ä¸å—å½±éŸ¿

- âœ“ éŸ¿æ‡‰å¿«å– (60s) ä»ç„¶æœ‰æ•ˆ
- âœ“ Audit logging æ­£å¸¸é‹ä½œ
- âœ“ Session æ›´æ–°é‚è¼¯ä¸è®Š
- âœ“ å‰ç«¯ sessionStorage å¿«å–ç¨ç«‹é‹ä½œ

---

## 7. æ¸¬è©¦å»ºè­°

### æ‰‹å‹•æ¸¬è©¦æ¸…å–®

#### Staging ç’°å¢ƒæ¸¬è©¦

1. **sensitive åç‰‡æ¸¬è©¦**
   ```bash
   # å‰µå»º sensitive åç‰‡
   # å¤šæ¬¡è¨ªå•ï¼Œæª¢æŸ¥ KV æ˜¯å¦æœ‰å¿«å–
   # é æœŸ: æ¯æ¬¡éƒ½è§£å¯†ï¼Œç„¡ KV å¿«å–
   ```

2. **personal åç‰‡æ¸¬è©¦**
   ```bash
   # å‰µå»º personal åç‰‡
   # é¦–æ¬¡è¨ªå•: ~200ms
   # 60s å…§å†æ¬¡è¨ªå•: ~100ms (KV å‘½ä¸­)
   # é‡æ–°æ•´ç†: <10ms (å‰ç«¯å¿«å–)
   ```

3. **event åç‰‡æ¸¬è©¦**
   ```bash
   # å‰µå»º event åç‰‡
   # é©—è­‰èˆ‡ personal ç›¸åŒçš„å¿«å–è¡Œç‚º
   ```

4. **éŒ¯èª¤è™•ç†æ¸¬è©¦**
   ```bash
   # æ¸¬è©¦ç„¡æ•ˆçš„ card_type
   # æ¸¬è©¦ uuid_bindings æŸ¥è©¢å¤±æ•—
   # é æœŸ: é è¨­ç‚º 'personal'ï¼ŒåŠŸèƒ½æ­£å¸¸
   ```

### ç›£æ§æŒ‡æ¨™

- **KV å¯«å…¥æ¬¡æ•¸**: sensitive æ‡‰ç‚º 0
- **è§£å¯†æ¬¡æ•¸**: sensitive æ‡‰ç­‰æ–¼è«‹æ±‚æ¬¡æ•¸
- **å¿«å–å‘½ä¸­ç‡**: personal/event æ‡‰ >50%
- **éŸ¿æ‡‰æ™‚é–“**: ç¬¦åˆé æœŸç¯„åœ

---

## 8. éƒ¨ç½²æª¢æŸ¥æ¸…å–®

- [x] TypeScript ç·¨è­¯é€šé
- [x] BDD å ´æ™¯å…¨éƒ¨è¦†è“‹
- [x] éŒ¯èª¤è™•ç†å®Œæ•´
- [x] å‘å¾Œç›¸å®¹æ€§ç¢ºèª
- [x] å®‰å…¨æ€§è€ƒé‡å®Œæ•´
- [ ] Staging ç’°å¢ƒæ¸¬è©¦
- [ ] ç›£æ§æŒ‡æ¨™é©—è­‰
- [ ] ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

---

## 9. æ–‡æª”å®Œæ•´æ€§

### âœ… ç›¸é—œæ–‡æª”

| æ–‡æª” | ç‹€æ…‹ |
|------|------|
| BDD è¦æ ¼ | âœ“ `.specify/specs/mixed-cache-strategy.md` |
| é©—æ”¶å ±å‘Š | âœ“ `.specify/reports/mixed-cache-acceptance.md` |
| å¯¦ä½œæ‘˜è¦ | âœ“ `workers/IMPLEMENTATION_SUMMARY.md` (Claude ç”Ÿæˆ) |

---

## 10. ç¸½çµ

### âœ… å¯¦ä½œå“è³ªï¼šâ­â­â­â­â­ (5/5)

**å„ªé»**:
- æ‰€æœ‰ BDD å ´æ™¯æ­£ç¢ºå¯¦ä½œ
- éŒ¯èª¤è™•ç†å®Œæ•´ä¸”ä¿å®ˆ
- TypeScript é¡å‹å®‰å…¨
- å‘å¾Œç›¸å®¹æ€§è‰¯å¥½
- å®‰å…¨æ€§è€ƒé‡å‘¨å…¨

**å®‰å…¨æ€§æå‡**:
- sensitive åç‰‡: è§£å¯†è³‡æ–™ä¸å­˜åœ¨å¾Œç«¯ KV
- personal/event åç‰‡: å¿«å–æ™‚é–“å¾ 300s ç¸®çŸ­åˆ° 60s

**æ€§èƒ½å½±éŸ¿**:
- sensitive åç‰‡: æ¯æ¬¡è§£å¯† (~200ms)ï¼Œå¯æ¥å—
- personal/event åç‰‡: å¿«å–å‘½ä¸­ (~100ms)ï¼Œæ€§èƒ½è‰¯å¥½
- æ‰€æœ‰é¡å‹: å‰ç«¯å¿«å– (<10ms)ï¼Œç”¨æˆ¶é«”é©—ä¸€è‡´

**å»ºè­°**: ç«‹å³éƒ¨ç½²åˆ° Staging ç’°å¢ƒé€²è¡Œå¯¦éš›æ¸¬è©¦ã€‚

---

**é©—æ”¶ç°½æ ¸**: âœ… Kiro (Commander Agent)  
**å¯¦ä½œç°½æ ¸**: âœ… Claude (Builder Agent)  
**æ—¥æœŸ**: 2026-01-20T23:33:00+08:00
