# DB-Card - NFC æ•¸ä½åç‰‡ç³»çµ± v4.0

ğŸ” åŸºæ–¼ã€Œéš±ç§å„ªå…ˆã€èˆ‡ã€Œå®‰å…¨è‡³ä¸Šã€ç†å¿µçš„ä¼æ¥­ç´š NFC æ•¸ä½åç‰‡ç³»çµ±

## ğŸ¯ v4.0 æ ¸å¿ƒç‰¹æ€§

### ğŸ”’ ä¼æ¥­ç´šå®‰å…¨æ¶æ§‹
- **ä¿¡å°åŠ å¯† (Envelope Encryption)**: æ¯å¼µåç‰‡ç¨ç«‹ DEKï¼ŒKEK å®šæœŸè¼ªæ›
- **æˆæ¬Šæœƒè©±æ©Ÿåˆ¶ (ReadSession)**: 24 å°æ™‚ TTLï¼Œå¯æ’¤éŠ·ã€å¯é™åˆ¶è®€å–æ¬¡æ•¸
- **å³æ™‚æ’¤éŠ·**: NFC é‡æ–°è§¸ç¢°å³å¯æ’¤éŠ·ä¸Šä¸€å€‹æœƒè©±
- **å¯©è¨ˆæ—¥èªŒ**: å®Œæ•´è¨˜éŒ„æ‰€æœ‰å­˜å–è¡Œç‚ºï¼ŒIP åŒ¿ååŒ–ä¿è­·éš±ç§

### ğŸš€ Cloudflare Workers æ¶æ§‹
- **å…¨çƒé‚Šç·£é‹ç®—**: ä½å»¶é²ã€é«˜å¯ç”¨æ€§
- **D1 Database**: SQLite ç›¸å®¹çš„åˆ†æ•£å¼è³‡æ–™åº«
- **ç„¡ä¼ºæœå™¨**: è‡ªå‹•æ“´å±•ï¼ŒæŒ‰éœ€è¨ˆè²»

### ğŸ“± ä½¿ç”¨è€…é«”é©—
- **ä¸€è§¸å³ç”¨**: NFC è§¸ç¢°è‡ªå‹•å‰µå»ºæˆæ¬Šæœƒè©±
- **é›™èªæ”¯æ´**: ä¸­è‹±æ–‡å‹•æ…‹åˆ‡æ›
- **é›¢ç·š QR ç¢¼**: ç„¡ç¶²è·¯ç’°å¢ƒä¸‹ç”Ÿæˆ vCard QR ç¢¼
- **æ™ºæ…§ vCard**: è‡ªå‹•ç”Ÿæˆè¯çµ¡äººæª”æ¡ˆ

### ğŸ›¡ï¸ ç®¡ç†å¾Œå°
- **å®Œæ•´ CRUD**: å‰µå»ºã€è®€å–ã€æ›´æ–°ã€åˆªé™¤åç‰‡
- **å³æ™‚ç›£æ§**: KEK ç‰ˆæœ¬ã€æ´»èºåç‰‡æ•¸çµ±è¨ˆ
- **ç·Šæ€¥æ’¤éŠ·**: å…¨åŸŸæ’¤éŠ·æ©Ÿåˆ¶
- **HttpOnly Cookies**: XSS é˜²è­·

## ğŸ“¦ å°ˆæ¡ˆçµæ§‹

```
DB-Card/
â”œâ”€â”€ workers/                        # v4.0 æ ¸å¿ƒç³»çµ±
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts                # ä¸»è·¯ç”±èˆ‡ä¸­ä»‹å±¤
â”‚   â”‚   â”œâ”€â”€ types.ts                # TypeScript é¡å‹å®šç¾©
â”‚   â”‚   â”œâ”€â”€ handlers/               # API è™•ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ tap.ts              # POST /api/nfc/tap
â”‚   â”‚   â”‚   â”œâ”€â”€ read.ts             # GET /api/read
â”‚   â”‚   â”‚   â”œâ”€â”€ health.ts           # GET /health
â”‚   â”‚   â”‚   â””â”€â”€ admin/              # ç®¡ç† API
â”‚   â”‚   â”‚       â”œâ”€â”€ cards.ts        # CRUD æ“ä½œ
â”‚   â”‚   â”‚       â”œâ”€â”€ auth.ts         # ç™»å…¥/ç™»å‡º
â”‚   â”‚   â”‚       â”œâ”€â”€ revoke.ts       # æ’¤éŠ·æ©Ÿåˆ¶
â”‚   â”‚   â”‚       â””â”€â”€ kek.ts          # KEK è¼ªæ›
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â””â”€â”€ auth.ts             # æ™‚åºå®‰å…¨èªè­‰
â”‚   â”‚   â”œâ”€â”€ crypto/
â”‚   â”‚   â”‚   â””â”€â”€ envelope.ts         # ä¿¡å°åŠ å¯†å¯¦ä½œ
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ session.ts          # æœƒè©±ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ policy.ts           # åç‰‡é¡å‹ç­–ç•¥
â”‚   â”‚       â”œâ”€â”€ audit.ts            # å¯©è¨ˆæ—¥èªŒ
â”‚   â”‚       â””â”€â”€ response.ts         # CORS èˆ‡å›æ‡‰
â”‚   â”œâ”€â”€ public/                     # å‰ç«¯è³‡æº
â”‚   â”‚   â”œâ”€â”€ admin-dashboard.html    # ç®¡ç†å¾Œå°
â”‚   â”‚   â”œâ”€â”€ nfc-generator.html      # åç‰‡ç”Ÿæˆå™¨
â”‚   â”‚   â”œâ”€â”€ card-display.html       # åç‰‡é¡¯ç¤ºé 
â”‚   â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”‚   â”œâ”€â”€ api.js              # API å®¢æˆ¶ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ storage.js          # IndexedDB
â”‚   â”‚   â”‚   â”œâ”€â”€ main.js             # ä¸»é‚è¼¯
â”‚   â”‚   â”‚   â””â”€â”€ error-handler.js    # éŒ¯èª¤è™•ç†
â”‚   â”‚   â””â”€â”€ css/
â”‚   â”‚       â””â”€â”€ v4-design.css       # v4.0 è¨­è¨ˆç³»çµ±
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 0001_initial_schema.sql # è³‡æ–™åº«çµæ§‹
â”‚   â”œâ”€â”€ wrangler.toml               # Cloudflare é…ç½®
â”‚   â””â”€â”€ package.json                # ä¾è³´ç®¡ç†
â”œâ”€â”€ docs/                           # æŠ€è¡“æ–‡æª”
â”‚   â”œâ”€â”€ adr/                        # æ¶æ§‹æ±ºç­–è¨˜éŒ„
â”‚   â”‚   â”œâ”€â”€ 001-privacy-first.md
â”‚   â”‚   â””â”€â”€ 002-security-architecture.md
â”‚   â””â”€â”€ api/                        # API æ–‡æª”
â”‚       â”œâ”€â”€ nfc-tap.md
â”‚       â”œâ”€â”€ read.md
â”‚       â””â”€â”€ admin-apis.md
â”œâ”€â”€ .specify/                       # é–‹ç™¼è¨˜æ†¶ç³»çµ±
â”‚   â”œâ”€â”€ specs/                      # BDD è¦æ ¼æ›¸
â”‚   â””â”€â”€ memory/                     # çŸ¥è­˜åœ–è­œ
â””â”€â”€ archive/                        # v3.X åƒè€ƒå¯¦ä½œ
    â”œâ”€â”€ v3-frontend/                # ç´”å‰ç«¯ç‰ˆæœ¬
    â”œâ”€â”€ v3-pwa/                     # PWA é›¢ç·šç³»çµ±
    â””â”€â”€ README.md                   # å°å­˜èªªæ˜
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. ç’°å¢ƒæº–å‚™

```bash
# å®‰è£ä¾è³´
cd workers
npm install

# è¨­å®šç’°å¢ƒè®Šæ•¸
cp .dev.vars.example .dev.vars
# ç·¨è¼¯ .dev.vars è¨­å®š SETUP_TOKEN å’Œ KEK
```

### 2. æœ¬åœ°é–‹ç™¼

```bash
# å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
npm run dev

# åŸ·è¡Œæ¸¬è©¦
npm test

# éƒ¨ç½²åˆ° staging
npm run deploy:staging

# éƒ¨ç½²åˆ° production
npm run deploy:production
```

### 3. è³‡æ–™åº«åˆå§‹åŒ–

```bash
# æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
npx wrangler d1 execute DB --local --file=./migrations/0001_initial_schema.sql

# ç”Ÿç”¢ç’°å¢ƒ
npx wrangler d1 execute DB --remote --file=./migrations/0001_initial_schema.sql
```

## ğŸ“± ä½¿ç”¨æµç¨‹

### ä½¿ç”¨è€…ç«¯

1. **NFC è§¸ç¢°**: æ‰‹æ©Ÿè§¸ç¢° NFC å¡ç‰‡
2. **è‡ªå‹•æˆæ¬Š**: ç³»çµ±å‰µå»º 24 å°æ™‚æˆæ¬Šæœƒè©±
3. **æŸ¥çœ‹åç‰‡**: ç€è¦½å™¨é–‹å•Ÿåç‰‡é¡¯ç¤ºé 
4. **ä¸‹è¼‰ vCard**: ä¸€éµåŠ å…¥è¯çµ¡äºº
5. **é›¢ç·šåˆ†äº«**: ç”Ÿæˆ vCard QR ç¢¼

### ç®¡ç†ç«¯

1. **ç™»å…¥å¾Œå°**: `https://your-domain/admin-dashboard.html`
2. **å‰µå»ºåç‰‡**: å¡«å¯« 11 å€‹æ¬„ä½ï¼ˆå°é½Š nfc-generatorï¼‰
3. **ç·¨è¼¯åç‰‡**: è¡¨å–®è‡ªå‹•é å¡«ç¾æœ‰è³‡æ–™
4. **æŸ¥çœ‹åç‰‡**: è‡ªå‹•å‰µå»ºæœƒè©±ä¸¦é–‹å•Ÿé è¦½
5. **æ’¤éŠ·æœƒè©±**: ç·Šæ€¥æƒ…æ³ä¸‹å…¨åŸŸæ’¤éŠ·

## ğŸ” å®‰å…¨ç‰¹æ€§

### ä¿¡å°åŠ å¯†æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NFC Card (Plaintext card_uuid)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Tap
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/nfc/tap                      â”‚
â”‚  - Create ReadSession (24h TTL)         â”‚
â”‚  - Return session token                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GET /api/read?session={token}          â”‚
â”‚  1. Validate session                    â”‚
â”‚  2. Fetch encrypted_dek + ciphertext    â”‚
â”‚  3. Unwrap DEK with KEK                 â”‚
â”‚  4. Decrypt card data with DEK          â”‚
â”‚  5. Return plaintext to user            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åç‰‡é¡å‹ç­–ç•¥

| é¡å‹ | TTL | æœ€å¤§è®€å–æ¬¡æ•¸ | ä½¿ç”¨å ´æ™¯ |
|------|-----|-------------|---------|
| personal | 24h | 20 | å€‹äººåç‰‡ |
| event_booth | 24h | 50 | å±•æœƒæ”¤ä½ |
| sensitive | 24h | 5 | æ•æ„Ÿè³‡è¨Š |

### æ’¤éŠ·æ©Ÿåˆ¶

- **å–®ä¸€æ’¤éŠ·**: é‡æ–°è§¸ç¢° NFC å¡ç‰‡ï¼ˆ10 åˆ†é˜å…§æˆ– 2 æ¬¡è®€å–å…§ï¼‰
- **å…¨åŸŸæ’¤éŠ·**: ç®¡ç†å¾Œå° `POST /api/admin/revoke`
- **ç·Šæ€¥éŸ¿æ‡‰**: KEK è¼ªæ›ä½¿æ‰€æœ‰èˆŠæœƒè©±å¤±æ•ˆ

## ğŸ› ï¸ API ç«¯é»

### å…¬é–‹ API

- `POST /api/nfc/tap` - NFC è§¸ç¢°å‰µå»ºæœƒè©±
- `GET /api/read` - è®€å–åç‰‡è³‡æ–™
- `GET /health` - ç³»çµ±å¥åº·æª¢æŸ¥

### ç®¡ç† API (éœ€èªè­‰)

- `POST /api/admin/login` - ç™»å…¥
- `POST /api/admin/logout` - ç™»å‡º
- `GET /api/admin/cards` - åˆ—å‡ºæ‰€æœ‰åç‰‡
- `GET /api/admin/cards/:uuid` - å–å¾—å–®ä¸€åç‰‡
- `POST /api/admin/cards` - å‰µå»ºåç‰‡
- `PUT /api/admin/cards/:uuid` - æ›´æ–°åç‰‡
- `DELETE /api/admin/cards/:uuid` - åˆªé™¤åç‰‡
- `POST /api/admin/revoke` - æ’¤éŠ·æœƒè©±
- `POST /api/admin/kek/rotate` - KEK è¼ªæ›

è©³ç´° API æ–‡æª”è«‹åƒè€ƒ `docs/api/`

## ğŸ“Š ç›£æ§èˆ‡æ—¥èªŒ

### å¥åº·æª¢æŸ¥

```bash
curl https://your-domain/health
```

å›æ‡‰ç¯„ä¾‹ï¼š
```json
{
  "status": "healthy",
  "timestamp": "2026-01-18T10:30:00.000Z",
  "kek": {
    "version": 1,
    "status": "active"
  },
  "database": {
    "active_cards": 42
  }
}
```

### å¯©è¨ˆæ—¥èªŒ

æ‰€æœ‰æ•æ„Ÿæ“ä½œå‡è¨˜éŒ„æ–¼ `audit_logs` è¡¨ï¼š
- åç‰‡å‰µå»º/æ›´æ–°/åˆªé™¤
- æœƒè©±å‰µå»º/è®€å–
- KEK è¼ªæ›
- IP åœ°å€è‡ªå‹•åŒ¿ååŒ–ï¼ˆä¿ç•™å‰ 3 æ®µï¼‰

## ğŸ”„ å¾ v3.X é·ç§»

v3.X ç´”å‰ç«¯æ¶æ§‹å·²å°å­˜è‡³ `archive/` ç›®éŒ„ï¼ŒåŒ…å«ï¼š
- PWA é›¢ç·šå„²å­˜ç³»çµ±
- é›™èªç¿»è­¯æ¨¡çµ„
- å®‰å…¨æ¶æ§‹æ¨¡çµ„

v4.0 æ¡ç”¨å¾Œç«¯ API æ¶æ§‹ï¼Œæä¾›æ›´å¼·çš„å®‰å…¨æ€§èˆ‡ç®¡ç†èƒ½åŠ›ã€‚

**ä¸»è¦å·®ç•°**ï¼š
- v3.X: è³‡æ–™å„²å­˜åœ¨ NFC å¡ç‰‡ URL åƒæ•¸ï¼ˆBase64ï¼‰
- v4.0: è³‡æ–™åŠ å¯†å„²å­˜æ–¼ D1 Databaseï¼ŒNFC å¡ç‰‡åƒ…å« UUID

**é·ç§»æ­¥é©Ÿ**ï¼š
1. ä½¿ç”¨ nfc-generator.html å‰µå»ºæ–°åç‰‡
2. é€éç®¡ç†å¾Œå°å–å¾— card_uuid
3. å°‡ UUID å¯«å…¥ NFC å¡ç‰‡ï¼ˆæ ¼å¼ï¼š`https://your-domain/card-display.html?card={uuid}`ï¼‰

è©³ç´°é·ç§»æŒ‡å—è«‹åƒè€ƒ `archive/README.md`

## ğŸ§ª æ¸¬è©¦

```bash
# å–®å…ƒæ¸¬è©¦
npm test

# æ•´åˆæ¸¬è©¦
npm run test:integration

# ç«¯å°ç«¯æ¸¬è©¦
npm run test:e2e
```

## ğŸ“ é–‹ç™¼æŒ‡å—

### BDD è¦æ ¼é©…å‹•é–‹ç™¼

æ‰€æœ‰åŠŸèƒ½é–‹ç™¼å‡éµå¾ª BDD è¦æ ¼ï¼Œä½æ–¼ `.specify/specs/`ï¼š
- `nfc-tap-api.md` - NFC è§¸ç¢° API
- `read-api.md` - è®€å– API
- `admin-crud-apis.md` - ç®¡ç† CRUD API
- `security-enhancements.md` - å®‰å…¨å¢å¼·

### æ¶æ§‹æ±ºç­–è¨˜éŒ„ (ADR)

é‡è¦æŠ€è¡“æ±ºç­–è¨˜éŒ„æ–¼ `docs/adr/`ï¼š
- ADR-001: éš±ç§å„ªå…ˆè¨­è¨ˆåŸå‰‡
- ADR-002: ä¿¡å°åŠ å¯†æ¶æ§‹

### è¨˜æ†¶ç³»çµ±

é–‹ç™¼éç¨‹ä½¿ç”¨çŸ¥è­˜åœ–è­œè¨˜æ†¶ç³»çµ±ï¼ˆ`.specify/memory/`ï¼‰ï¼š
- `progress.md` - ç•¶å‰é–‹ç™¼é€²åº¦
- `knowledge_graph.mem` - é•·æœŸçŸ¥è­˜æ­¸æª”

## ğŸ“„ æˆæ¬Šæ¢æ¬¾

MIT License - è©³è¦‹ [LICENSE](LICENSE)

## ğŸ¤ è²¢ç»æŒ‡å—

æ­¡è¿æäº¤ Issue å’Œ Pull Requestï¼

1. Fork å°ˆæ¡ˆ
2. å‰µå»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/amazing-feature`)
3. æ’°å¯« BDD è¦æ ¼ï¼ˆ`.specify/specs/`ï¼‰
4. å¯¦ä½œåŠŸèƒ½ä¸¦é€šéæ¸¬è©¦
5. æäº¤è®Šæ›´ (`git commit -m 'feat: add amazing feature'`)
6. æ¨é€åˆ†æ”¯ (`git push origin feature/amazing-feature`)
7. é–‹å•Ÿ Pull Request

## ğŸ“ æŠ€è¡“æ”¯æ´

- **æ–‡æª”**: `docs/`
- **Issues**: [GitHub Issues](https://github.com/yourusername/DB-Card/issues)
- **Email**: support@db-card.example.com

## ğŸ¯ ç‰ˆæœ¬æ­·ç¨‹

### v4.0.0 (2026-01-18) - ä¼æ¥­ç´šå®‰å…¨æ¶æ§‹
- âœ… ä¿¡å°åŠ å¯†æ©Ÿåˆ¶
- âœ… æˆæ¬Šæœƒè©±ç³»çµ±
- âœ… ç®¡ç†å¾Œå°å®Œæ•´ CRUD
- âœ… HttpOnly Cookies å®‰å…¨å¢å¼·
- âœ… å¯©è¨ˆæ—¥èªŒèˆ‡ç›£æ§

### v3.2.1 (2025-08-09) - PWA ç©©å®šç‰ˆ
- âœ… PWA é›¢ç·šå„²å­˜
- âœ… é›™èªç¿»è­¯ç³»çµ±
- âœ… å®‰å…¨æ¶æ§‹æ¨¡çµ„
- ğŸ“¦ å·²å°å­˜è‡³ `archive/v3-pwa/`

---

ğŸ” **ä¼æ¥­ç´šå®‰å…¨ï¼Œéš±ç§å„ªå…ˆè¨­è¨ˆï¼**  
ğŸš€ **Cloudflare Workers å…¨çƒé‚Šç·£é‹ç®—ï¼**
