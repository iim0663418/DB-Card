<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFFLINE-03 åŠŸèƒ½é©—è­‰èˆ‡ç›¸å®¹æ€§æ¸¬è©¦</title>
    <script src="../../assets/qrcode.min.js"></script>
    <script src="../../assets/qr-utils.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .test-result { margin: 8px 0; padding: 8px; border-radius: 4px; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        #qrcode { margin: 20px 0; min-height: 260px; border: 1px solid #ccc; padding: 10px; }
        .qr-label { font-size: 14px; color: #666; margin-top: 10px; }
        button { margin: 5px; padding: 8px 16px; cursor: pointer; }
        .test-controls { margin: 15px 0; }
        .security-check { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>OFFLINE-03 åŠŸèƒ½é©—è­‰èˆ‡ç›¸å®¹æ€§æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>ğŸ”§ æ¸¬è©¦æ§åˆ¶é¢æ¿</h2>
        <div class="test-controls">
            <button onclick="runAllTests()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶</button>
            <button onclick="testOnlineMode()">æ¸¬è©¦ç·šä¸Šæ¨¡å¼</button>
            <button onclick="testOfflineMode()">æ¸¬è©¦é›¢ç·šæ¨¡å¼</button>
            <button onclick="testModeSwitching()">æ¸¬è©¦æ¨¡å¼åˆ‡æ›</button>
            <button onclick="testSecurityValidation()">å®‰å…¨æ€§é©—è­‰</button>
            <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š æ¸¬è©¦çµæœ</h2>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ” QR ç¢¼é¡¯ç¤ºå€åŸŸ</h2>
        <div id="qrcode">QR ç¢¼å°‡åœ¨æ­¤é¡¯ç¤º...</div>
        <div class="qr-label" id="qr-label">ç­‰å¾…æ¸¬è©¦é–‹å§‹</div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ›¡ï¸ å®‰å…¨æ€§æª¢æŸ¥çµæœ</h2>
        <div id="security-results"></div>
    </div>

    <script>
        // æ¨¡æ“¬ç¾æœ‰ç’°å¢ƒ
        let testResults = [];
        let securityResults = [];
        
        // æ¨¡æ“¬åç‰‡è³‡æ–™
        window.getCardDataFromNFC = function() {
            return {
                data: {
                    name: "æ¸¬è©¦ä½¿ç”¨è€…",
                    title: "è³‡æ·±å·¥ç¨‹å¸«",
                    department: "è³‡è¨Šè™•",
                    organization: "æ•¸ä½ç™¼å±•éƒ¨",
                    email: "test@moda.gov.tw",
                    phone: "02-2356-5000",
                    mobile: "0912-345-678",
                    avatar: "assets/wu_sheng_fan/photo.jpg",
                    address: "100057è‡ºåŒ—å¸‚ä¸­æ­£å€å»¶å¹³å—è·¯143è™Ÿ",
                    greetings: ["æ­¡è¿èªè­˜æˆ‘ï¼", "å¾ˆé«˜èˆˆèˆ‡æ‚¨äº¤æµ"],
                    socialLinks: {
                        email: "mailto:test@moda.gov.tw",
                        socialNote: "LINE: @testuser\\nFB: fb.com/testuser"
                    }
                }
            };
        };
        
        // æ¨¡æ“¬ç¾æœ‰ vCard ç”Ÿæˆå‡½æ•¸
        window.generateVCardContent = function(cardData) {
            const data = cardData.data;
            return [
                'BEGIN:VCARD',
                'VERSION:3.0',
                `FN:${data.name}`,
                `ORG:${data.organization}`,
                `TITLE:${data.title}`,
                `EMAIL:${data.email}`,
                `TEL:${data.phone}`,
                `TEL:${data.mobile}`,
                'END:VCARD'
            ].join('\\r\\n');
        };
        
        // è¼‰å…¥å¢å¼·è…³æœ¬
        const script = document.createElement('script');
        script.src = '../../assets/offline-qr-enhancement.js';
        script.onload = function() {
            addResult('info', 'âœ… é›¢ç·š QR ç¢¼å¢å¼·è…³æœ¬è¼‰å…¥æˆåŠŸ');
        };
        script.onerror = function() {
            addResult('fail', 'âŒ é›¢ç·š QR ç¢¼å¢å¼·è…³æœ¬è¼‰å…¥å¤±æ•—');
        };
        document.head.appendChild(script);
        
        function addResult(type, message, section = 'test') {
            const container = section === 'security' ? 
                document.getElementById('security-results') : 
                document.getElementById('test-results');
            
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            container.appendChild(div);
            
            if (section === 'test') {
                testResults.push({ type, message, timestamp: new Date() });
            } else {
                securityResults.push({ type, message, timestamp: new Date() });
            }
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('security-results').innerHTML = '';
            testResults = [];
            securityResults = [];
            addResult('info', 'æ¸¬è©¦çµæœå·²æ¸…é™¤');
        }
        
        // æ¸¬è©¦ç·šä¸Šæ¨¡å¼
        function testOnlineMode() {
            addResult('info', 'ğŸŒ é–‹å§‹æ¸¬è©¦ç·šä¸Šæ¨¡å¼...');
            
            // è¨­å®šç·šä¸Šç‹€æ…‹
            Object.defineProperty(navigator, 'onLine', { 
                value: true, 
                configurable: true 
            });
            
            try {
                // åŸ·è¡Œ QR ç¢¼ç”Ÿæˆ
                if (typeof window.generateQRCode === 'function') {
                    window.generateQRCode();
                    
                    // æª¢æŸ¥ QR ç¢¼æ˜¯å¦ç”Ÿæˆ
                    setTimeout(() => {
                        const qrContainer = document.getElementById('qrcode');
                        const hasQRCode = qrContainer.querySelector('img') || qrContainer.querySelector('canvas');
                        
                        if (hasQRCode) {
                            addResult('pass', 'âœ… ç·šä¸Šæ¨¡å¼ï¼šQR ç¢¼ç”ŸæˆæˆåŠŸ');
                            
                            // æª¢æŸ¥æ¨™ç±¤æ–‡å­—
                            const label = document.getElementById('qr-label');
                            if (label && !label.textContent.includes('é›¢ç·šæ¨¡å¼')) {
                                addResult('pass', 'âœ… ç·šä¸Šæ¨¡å¼ï¼šQR ç¢¼æ¨™ç±¤æ­£ç¢º');
                            } else {
                                addResult('warning', 'âš ï¸ ç·šä¸Šæ¨¡å¼ï¼šQR ç¢¼æ¨™ç±¤å¯èƒ½ä¸æ­£ç¢º');
                            }
                        } else {
                            addResult('fail', 'âŒ ç·šä¸Šæ¨¡å¼ï¼šQR ç¢¼ç”Ÿæˆå¤±æ•—');
                        }
                    }, 1000);
                } else {
                    addResult('fail', 'âŒ generateQRCode å‡½æ•¸ä¸å­˜åœ¨');
                }
            } catch (error) {
                addResult('fail', `âŒ ç·šä¸Šæ¨¡å¼æ¸¬è©¦ç•°å¸¸: ${error.message}`);
            }
        }
        
        // æ¸¬è©¦é›¢ç·šæ¨¡å¼
        function testOfflineMode() {
            addResult('info', 'ğŸ“± é–‹å§‹æ¸¬è©¦é›¢ç·šæ¨¡å¼...');
            
            // è¨­å®šé›¢ç·šç‹€æ…‹
            Object.defineProperty(navigator, 'onLine', { 
                value: false, 
                configurable: true 
            });
            
            try {
                // åŸ·è¡Œ QR ç¢¼ç”Ÿæˆ
                if (typeof window.generateQRCode === 'function') {
                    window.generateQRCode();
                    
                    // æª¢æŸ¥ QR ç¢¼æ˜¯å¦ç”Ÿæˆ
                    setTimeout(() => {
                        const qrContainer = document.getElementById('qrcode');
                        const hasQRCode = qrContainer.querySelector('img') || qrContainer.querySelector('canvas');
                        
                        if (hasQRCode) {
                            addResult('pass', 'âœ… é›¢ç·šæ¨¡å¼ï¼švCard QR ç¢¼ç”ŸæˆæˆåŠŸ');
                            
                            // æª¢æŸ¥æ¨™ç±¤æ–‡å­—
                            const label = document.getElementById('qr-label');
                            if (label && label.textContent.includes('é›¢ç·šæ¨¡å¼')) {
                                addResult('pass', 'âœ… é›¢ç·šæ¨¡å¼ï¼šQR ç¢¼æ¨™ç±¤æ›´æ–°æ­£ç¢º');
                            } else {
                                addResult('warning', 'âš ï¸ é›¢ç·šæ¨¡å¼ï¼šQR ç¢¼æ¨™ç±¤æœªæ­£ç¢ºæ›´æ–°');
                            }
                            
                            // é©—è­‰ vCard å…§å®¹
                            testVCardContent();
                        } else {
                            addResult('fail', 'âŒ é›¢ç·šæ¨¡å¼ï¼švCard QR ç¢¼ç”Ÿæˆå¤±æ•—');
                        }
                    }, 1000);
                } else {
                    addResult('fail', 'âŒ generateQRCode å‡½æ•¸ä¸å­˜åœ¨');
                }
            } catch (error) {
                addResult('fail', `âŒ é›¢ç·šæ¨¡å¼æ¸¬è©¦ç•°å¸¸: ${error.message}`);
            }
        }
        
        // æ¸¬è©¦æ¨¡å¼åˆ‡æ›
        function testModeSwitching() {
            addResult('info', 'ğŸ”„ é–‹å§‹æ¸¬è©¦æ¨¡å¼åˆ‡æ›...');
            
            let switchCount = 0;
            const maxSwitches = 4;
            
            function performSwitch() {
                if (switchCount >= maxSwitches) {
                    addResult('pass', 'âœ… æ¨¡å¼åˆ‡æ›æ¸¬è©¦å®Œæˆï¼šç·šä¸Š/é›¢ç·šåˆ‡æ›æ­£å¸¸');
                    // æ¢å¾©ç·šä¸Šç‹€æ…‹
                    Object.defineProperty(navigator, 'onLine', { value: true, configurable: true });
                    return;
                }
                
                const isOnline = switchCount % 2 === 0;
                Object.defineProperty(navigator, 'onLine', { 
                    value: isOnline, 
                    configurable: true 
                });
                
                try {
                    window.generateQRCode();
                    addResult('info', `ğŸ”„ åˆ‡æ›åˆ°${isOnline ? 'ç·šä¸Š' : 'é›¢ç·š'}æ¨¡å¼ (${switchCount + 1}/${maxSwitches})`);
                    switchCount++;
                    
                    setTimeout(performSwitch, 800);
                } catch (error) {
                    addResult('fail', `âŒ æ¨¡å¼åˆ‡æ›å¤±æ•—: ${error.message}`);
                }
            }
            
            performSwitch();
        }
        
        // é©—è­‰ vCard å…§å®¹
        function testVCardContent() {
            try {
                const cardData = window.getCardDataFromNFC();
                const vCardContent = window.generateVCardContent(cardData);
                
                // åŸºæœ¬æ ¼å¼æª¢æŸ¥
                if (vCardContent.includes('BEGIN:VCARD') && vCardContent.includes('END:VCARD')) {
                    addResult('pass', 'âœ… vCard æ ¼å¼é©—è­‰ï¼šåŸºæœ¬çµæ§‹æ­£ç¢º');
                } else {
                    addResult('fail', 'âŒ vCard æ ¼å¼é©—è­‰ï¼šåŸºæœ¬çµæ§‹éŒ¯èª¤');
                    return;
                }
                
                // å¿…è¦æ¬„ä½æª¢æŸ¥
                const requiredFields = ['FN:', 'ORG:', 'EMAIL:'];
                let missingFields = [];
                
                requiredFields.forEach(field => {
                    if (!vCardContent.includes(field)) {
                        missingFields.push(field);
                    }
                });
                
                if (missingFields.length === 0) {
                    addResult('pass', 'âœ… vCard å…§å®¹é©—è­‰ï¼šå¿…è¦æ¬„ä½å®Œæ•´');
                } else {
                    addResult('fail', `âŒ vCard å…§å®¹é©—è­‰ï¼šç¼ºå°‘æ¬„ä½ ${missingFields.join(', ')}`);
                }
                
                // å®‰å…¨æ€§æª¢æŸ¥ï¼šç¢ºä¿æ²’æœ‰æƒ¡æ„å…§å®¹
                const dangerousPatterns = ['<script', 'javascript:', 'data:text/html'];
                let securityIssues = [];
                
                dangerousPatterns.forEach(pattern => {
                    if (vCardContent.toLowerCase().includes(pattern)) {
                        securityIssues.push(pattern);
                    }
                });
                
                if (securityIssues.length === 0) {
                    addResult('pass', 'âœ… vCard å®‰å…¨æ€§ï¼šç„¡ç™¼ç¾æƒ¡æ„å…§å®¹', 'security');
                } else {
                    addResult('fail', `âŒ vCard å®‰å…¨æ€§ï¼šç™¼ç¾å¯ç–‘å…§å®¹ ${securityIssues.join(', ')}`, 'security');
                }
                
            } catch (error) {
                addResult('fail', `âŒ vCard å…§å®¹é©—è­‰å¤±æ•—: ${error.message}`);
            }
        }
        
        // å®‰å…¨æ€§é©—è­‰
        function testSecurityValidation() {
            addResult('info', 'ğŸ›¡ï¸ é–‹å§‹å®‰å…¨æ€§é©—è­‰...', 'security');
            
            // æ¸¬è©¦ 1: è¼¸å…¥é©—è­‰
            try {
                // æ¨¡æ“¬æƒ¡æ„è¼¸å…¥
                const maliciousData = {
                    data: {
                        name: "<script>alert('xss')</script>",
                        email: "javascript:alert('xss')",
                        organization: "data:text/html,<script>alert('xss')</script>"
                    }
                };
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é©ç•¶çš„è¼¸å…¥æ¸…ç†
                const originalGetCardData = window.getCardDataFromNFC;
                window.getCardDataFromNFC = () => maliciousData;
                
                const vCardContent = window.generateVCardContent(maliciousData);
                
                // æª¢æŸ¥æ˜¯å¦åŒ…å«åŸå§‹æƒ¡æ„å…§å®¹
                if (vCardContent.includes('<script>') || vCardContent.includes('javascript:')) {
                    addResult('fail', 'âŒ è¼¸å…¥é©—è­‰ï¼šæœªæ­£ç¢ºæ¸…ç†æƒ¡æ„è¼¸å…¥', 'security');
                } else {
                    addResult('pass', 'âœ… è¼¸å…¥é©—è­‰ï¼šæƒ¡æ„è¼¸å…¥å·²è¢«è™•ç†', 'security');
                }
                
                // æ¢å¾©åŸå§‹å‡½æ•¸
                window.getCardDataFromNFC = originalGetCardData;
                
            } catch (error) {
                addResult('warning', `âš ï¸ è¼¸å…¥é©—è­‰æ¸¬è©¦ç•°å¸¸: ${error.message}`, 'security');
            }
            
            // æ¸¬è©¦ 2: éŒ¯èª¤è™•ç†
            try {
                // æ¨¡æ“¬éŒ¯èª¤æƒ…æ³
                const originalQRCode = window.QRCode;
                window.QRCode = null;
                
                Object.defineProperty(navigator, 'onLine', { value: false, configurable: true });
                window.generateQRCode();
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é©ç•¶çš„éŒ¯èª¤è™•ç†
                setTimeout(() => {
                    addResult('pass', 'âœ… éŒ¯èª¤è™•ç†ï¼šç•°å¸¸æƒ…æ³ä¸‹æœªå´©æ½°', 'security');
                    
                    // æ¢å¾©
                    window.QRCode = originalQRCode;
                    Object.defineProperty(navigator, 'onLine', { value: true, configurable: true });
                }, 500);
                
            } catch (error) {
                addResult('pass', 'âœ… éŒ¯èª¤è™•ç†ï¼šç•°å¸¸è¢«æ­£ç¢ºæ•ç²', 'security');
            }
            
            // æ¸¬è©¦ 3: DOM æ“ä½œå®‰å…¨æ€§
            try {
                const qrContainer = document.getElementById('qrcode');
                const originalInnerHTML = qrContainer.innerHTML;
                
                // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨å®‰å…¨çš„ DOM æ“ä½œ
                Object.defineProperty(navigator, 'onLine', { value: false, configurable: true });
                window.generateQRCode();
                
                setTimeout(() => {
                    // æª¢æŸ¥æ˜¯å¦æœ‰ç›´æ¥çš„ innerHTML æ³¨å…¥
                    if (qrContainer.innerHTML !== originalInnerHTML) {
                        addResult('pass', 'âœ… DOM æ“ä½œï¼šä½¿ç”¨å®‰å…¨çš„ DOM æ“ä½œæ–¹æ³•', 'security');
                    }
                    
                    Object.defineProperty(navigator, 'onLine', { value: true, configurable: true });
                }, 500);
                
            } catch (error) {
                addResult('warning', `âš ï¸ DOM å®‰å…¨æ€§æ¸¬è©¦ç•°å¸¸: ${error.message}`, 'security');
            }
        }
        
        // åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
        function runAllTests() {
            clearResults();
            addResult('info', 'ğŸš€ é–‹å§‹åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶...');
            
            // æŒ‰é †åºåŸ·è¡Œæ¸¬è©¦
            setTimeout(() => testOnlineMode(), 500);
            setTimeout(() => testOfflineMode(), 2000);
            setTimeout(() => testModeSwitching(), 4000);
            setTimeout(() => testSecurityValidation(), 8000);
            setTimeout(() => generateTestReport(), 12000);
        }
        
        // ç”Ÿæˆæ¸¬è©¦å ±å‘Š
        function generateTestReport() {
            const totalTests = testResults.length;
            const passedTests = testResults.filter(r => r.type === 'pass').length;
            const failedTests = testResults.filter(r => r.type === 'fail').length;
            const warningTests = testResults.filter(r => r.type === 'warning').length;
            
            const securityTotal = securityResults.length;
            const securityPassed = securityResults.filter(r => r.type === 'pass').length;
            const securityFailed = securityResults.filter(r => r.type === 'fail').length;
            
            addResult('info', 'ğŸ“‹ æ¸¬è©¦å ±å‘Šç”Ÿæˆä¸­...');
            
            setTimeout(() => {
                addResult('info', `
                    ğŸ“Š <strong>åŠŸèƒ½æ¸¬è©¦ç¸½çµ</strong><br>
                    â€¢ ç¸½æ¸¬è©¦æ•¸: ${totalTests}<br>
                    â€¢ é€šé: ${passedTests}<br>
                    â€¢ å¤±æ•—: ${failedTests}<br>
                    â€¢ è­¦å‘Š: ${warningTests}<br>
                    â€¢ æˆåŠŸç‡: ${totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0}%
                `);
                
                addResult('info', `
                    ğŸ›¡ï¸ <strong>å®‰å…¨æ¸¬è©¦ç¸½çµ</strong><br>
                    â€¢ å®‰å…¨æ¸¬è©¦æ•¸: ${securityTotal}<br>
                    â€¢ é€šé: ${securityPassed}<br>
                    â€¢ å¤±æ•—: ${securityFailed}<br>
                    â€¢ å®‰å…¨è©•åˆ†: ${securityTotal > 0 ? Math.round((securityPassed / securityTotal) * 100) : 0}%
                `, 'security');
                
                if (failedTests === 0 && securityFailed === 0) {
                    addResult('pass', 'ğŸ‰ OFFLINE-03 åŠŸèƒ½é©—è­‰èˆ‡ç›¸å®¹æ€§æ¸¬è©¦ï¼šå…¨éƒ¨é€šéï¼');
                } else {
                    addResult('warning', `âš ï¸ OFFLINE-03 æ¸¬è©¦å®Œæˆï¼Œç™¼ç¾ ${failedTests + securityFailed} å€‹å•é¡Œéœ€è¦è™•ç†`);
                }
            }, 1000);
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            addResult('info', 'ğŸ”§ OFFLINE-03 åŠŸèƒ½é©—è­‰èˆ‡ç›¸å®¹æ€§æ¸¬è©¦ç’°å¢ƒå·²æº–å‚™å°±ç·’');
            addResult('info', 'ğŸ’¡ é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦ï¼Œæˆ–åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶');
        });
    </script>
</body>
</html>