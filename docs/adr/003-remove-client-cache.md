# ADR-003: 移除客戶端快取機制

## 狀態
已接受 (2026-01-19)

## 背景
v4.0 從 v3.X PWA 版本繼承了 IndexedDB 客戶端快取機制，用於支援離線模式。但在實際使用中發現：

1. **與授權會話機制衝突**：session 過期後，快取仍可訪問，繞過了安全驗證
2. **資料一致性問題**：語系切換時直接使用快取，可能顯示過期/撤銷的資料
3. **架構複雜度**：增加了錯誤處理、降級邏輯的複雜度
4. **定位不符**：v4.0 定位為「企業級安全」系統，而非 PWA 離線應用

## 決策
**移除 IndexedDB 客戶端快取機制**，回歸純 API 架構：

1. **移除檔案**：
   - `public/js/storage.js` - IndexedDB 操作
   - `public/js/error-handler.js` - 快取降級邏輯

2. **簡化邏輯**：
   - 名片資料僅從 API 讀取
   - 語系切換重新載入頁面（保留 session 參數）
   - 移除離線模式相關 UI

3. **錯誤處理**：
   - Session 過期 → 顯示錯誤，引導重新觸碰 NFC
   - 網路錯誤 → 顯示錯誤，不降級到快取
   - 統一錯誤訊息，不混淆使用者

## 理由

### 1. 符合安全架構 (ADR-002)
- 授權會話是核心安全機制
- 不應被客戶端快取繞過
- 確保每次訪問都經過驗證

### 2. 確保資料一致性
- 撤銷的名片不會被顯示
- 更新的名片立即生效
- 無過期資料問題

### 3. 簡化系統架構
- 減少 2 個模組（storage, error-handler）
- 減少狀態管理複雜度
- 降低維護成本

### 4. 符合使用場景
- NFC 觸碰通常在有網路的環境
- 企業內部使用，網路穩定
- 不需要離線功能

## 後果

### 正面
- ✅ 安全性提升（無快取繞過）
- ✅ 資料一致性保證
- ✅ 架構簡化（-300 行代碼）
- ✅ 行為可預測（無降級邏輯）

### 負面
- ❌ 網路不穩時無法查看
- ❌ 語系切換需重新載入頁面
- ❌ 每次訪問都需 API 請求

### 風險緩解
- 使用 Cloudflare Workers 全球邊緣運算（低延遲）
- 實作適當的 loading 狀態
- 提供清晰的錯誤訊息

## 實作計畫

### Phase 1: 移除快取邏輯
- [ ] 刪除 `storage.js`
- [ ] 刪除 `error-handler.js`
- [ ] 移除 `main.js` 中的快取相關代碼

### Phase 2: 重構語系切換
- [ ] 改為 URL 參數 + 頁面重新載入
- [ ] 保留 session 參數

### Phase 3: 簡化錯誤處理
- [ ] 統一錯誤訊息
- [ ] 移除離線模式 UI

### Phase 4: 測試驗證
- [ ] Session 過期場景
- [ ] 網路錯誤場景
- [ ] 語系切換功能

## 相關決策
- ADR-001: 隱私優先設計原則
- ADR-002: 信封加密架構

## 參考
- Issue: 語系切換時顯示過期名片
- v3.X PWA 離線功能已封存至 `archive/`
