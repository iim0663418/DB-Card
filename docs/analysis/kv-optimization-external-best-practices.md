# KV å„ªåŒ–å¤šç¶­åº¦åˆ†æå ±å‘Šï¼ˆåŸºæ–¼å¤–éƒ¨æœ€ä½³å¯¦è¸ï¼‰
**åˆ†ææ—¥æœŸ**: 2026-01-30  
**åƒè€ƒä¾†æº**: Cloudflare å®˜æ–¹æ–‡æª”ã€EF-Map æ¡ˆä¾‹ç ”ç©¶ã€DZone æŠ€è¡“åˆ†æ

---

## ğŸ” å¤–éƒ¨è³‡è¨Šæ ¸å¿ƒç™¼ç¾

### 1ï¸âƒ£ **Cloudflare å®˜æ–¹ç«‹å ´ï¼šKV ä¸é©åˆ Rate Limiting**

#### ä¾†æºï¼šCloudflare Community Forum (2019-2020)
> "I see a lot of issues with using Workers and KV for rate-limiting... **last-write-wins is always the case for CF KV**. You can only write to a single value **1 time per second**."

> "Workers KV is an **eventually consistent** system... it can take **up to 60 seconds** before reads in all edge locations are guaranteed to see the new value."

**é—œéµå•é¡Œ**ï¼š
- âŒ **æœ€çµ‚ä¸€è‡´æ€§**ï¼šå¯«å…¥å¾Œæœ€å¤š 60 ç§’æ‰èƒ½å…¨çƒåŒæ­¥
- âŒ **å¯«å…¥é™åˆ¶**ï¼šå–®ä¸€ key æ¯ç§’åªèƒ½å¯«å…¥ 1 æ¬¡
- âŒ **ç«¶æ…‹æ¢ä»¶**ï¼šå¤šå€‹ edge location åŒæ™‚å¯«å…¥æœƒå°è‡´è¨ˆæ•¸ä¸æº–ç¢º

**çµè«–**: **æˆ‘å€‘ç•¶å‰çš„ Rate Limiting å¯¦ä½œå­˜åœ¨æ ¹æœ¬æ€§æ¶æ§‹ç¼ºé™·**ã€‚

---

### 2ï¸âƒ£ **EF-Map æ¡ˆä¾‹ï¼š93% KV æˆæœ¬å‰Šæ¸›**

#### ä¾†æºï¼šef-map.com (2025-11-03)

**å•é¡Œå ´æ™¯**ï¼š
- æ¯ 2 åˆ†é˜è¼ªè©¢ç‹€æ…‹ â†’ 1.62M List operations/month
- è¶…å‡ºå…è²»é¡åº¦ 600K operations

**å„ªåŒ–ç­–ç•¥**ï¼š
1. **ç§»é™¤æ­»ä»£ç¢¼**ï¼ˆIndexerPageï¼‰â†’ 60% å‰Šæ¸›
2. **å»¶é•·è¼ªè©¢é–“éš”**ï¼ˆ2 min â†’ 30 minï¼‰â†’ 93% ç¸½å‰Šæ¸›
3. **ç°¡åŒ–ç‹€æ…‹æ©Ÿ**ï¼ˆ3 ç‹€æ…‹ â†’ 2 ç‹€æ…‹ï¼‰

**æœ€çµ‚çµæœ**ï¼š
- 1.62M â†’ 108K operations/month (-93%)
- æˆæœ¬ï¼š$0.30/month â†’ $0/month

**æ ¸å¿ƒæ•™è¨“**ï¼š
> "Match monitoring frequency to actual requirements"  
> "Binary states > Granular states for monitoring"

**æ‡‰ç”¨åˆ°æˆ‘å€‘çš„å ´æ™¯**ï¼š
- âœ… æˆ‘å€‘çš„ Rate Limiting æ¯æ¬¡ Tap éƒ½å¯«å…¥ â†’ é¡ä¼¼ã€Œéåº¦è¼ªè©¢ã€
- âœ… å¯ä»¥å»¶é•·çª—å£ï¼ˆ1 hour â†’ 24 hoursï¼‰æ¸›å°‘å¯«å…¥é »ç‡

---

### 3ï¸âƒ£ **Durable Objects vs KVï¼šæ€§èƒ½èˆ‡æˆæœ¬å°æ¯”**

#### ä¾†æºï¼šDZone (2025-09-24)

**Redis (å‚³çµ±æ–¹æ¡ˆ)**ï¼š
- å»¶é²ï¼š80-150ms
- æˆæœ¬ï¼šåŸºæº–ç·š
- å•é¡Œï¼šå–®é»æ•…éšœã€åœ°ç†è¤‡é›œåº¦

**Cloudflare KV**ï¼š
- å»¶é²ï¼š5-50msï¼ˆè®€å–ï¼‰
- æˆæœ¬ï¼š100K writes/day å…è²»
- å•é¡Œï¼šæœ€çµ‚ä¸€è‡´æ€§ã€ä¸é©åˆè¨ˆæ•¸å™¨

**Durable Objects**ï¼š
- å»¶é²ï¼š**<5ms**ï¼ˆå¼·ä¸€è‡´æ€§ï¼‰
- æˆæœ¬ï¼š1M requests/day å…è²»ï¼ˆ**10x KV**ï¼‰
- å„ªå‹¢ï¼šå¼·ä¸€è‡´æ€§ã€è‡ªå‹•é·ç§»ã€ç„¡å†·å•Ÿå‹•

**å¯¦éš›æ¡ˆä¾‹ï¼ˆFastjrsyï¼‰**ï¼š
- è™•ç† 500+ req/sec
- å»¶é²å¾ 150ms â†’ 5ms (-97%)
- æˆæœ¬å‰Šæ¸› 70%

**çµè«–**: **Durable Objects æ˜¯ Rate Limiting çš„æœ€ä½³è§£æ±ºæ–¹æ¡ˆ**ã€‚

---

### 4ï¸âƒ£ **Cloudflare å®˜æ–¹å»ºè­°ï¼šé¸æ“‡æ­£ç¢ºçš„å„²å­˜æ–¹æ¡ˆ**

#### ä¾†æºï¼šCloudflare Workers Docs

| ä½¿ç”¨å ´æ™¯ | æ¨è–¦æ–¹æ¡ˆ | åŸå›  |
|---------|---------|------|
| **è¨ˆæ•¸å™¨ã€ä½‡åˆ—** | Durable Objects | å¼·ä¸€è‡´æ€§ |
| **å…¨çƒå¿«å–** | KV | ä½å»¶é²è®€å– |
| **é—œè¯å¼è³‡æ–™** | D1 | SQL æŸ¥è©¢ |
| **å¤§å‹ç‰©ä»¶** | R2 | ç‰©ä»¶å„²å­˜ |

**Rate Limiting å±¬æ–¼ã€Œè¨ˆæ•¸å™¨ã€å ´æ™¯** â†’ **æ‡‰ä½¿ç”¨ Durable Objects**

---

## ğŸ¯ å¤šç¶­åº¦è©•ä¼°çŸ©é™£

### **ç¶­åº¦ 1: æŠ€è¡“æ­£ç¢ºæ€§** âš ï¸

| æ–¹æ¡ˆ | ä¸€è‡´æ€§ | æº–ç¢ºæ€§ | æŠ€è¡“å‚µ | è©•åˆ† |
|------|--------|--------|--------|------|
| **ç•¶å‰ KV** | æœ€çµ‚ä¸€è‡´æ€§ | âŒ ä¸æº–ç¢º | é«˜ | 3/10 |
| **KV å»¶é•·çª—å£** | æœ€çµ‚ä¸€è‡´æ€§ | âŒ ä¸æº–ç¢º | é«˜ | 4/10 |
| **Durable Objects** | å¼·ä¸€è‡´æ€§ | âœ… æº–ç¢º | ä½ | 10/10 |

**çµè«–**: ç•¶å‰æ–¹æ¡ˆå­˜åœ¨æ ¹æœ¬æ€§ç¼ºé™·ï¼Œä¸ç¬¦åˆ Rate Limiting çš„æŠ€è¡“è¦æ±‚ã€‚

---

### **ç¶­åº¦ 2: æˆæœ¬æ•ˆç›Š** ğŸ’°

| æ–¹æ¡ˆ | KV Writes | KV Reads | DO Requests | æœˆæˆæœ¬ | è©•åˆ† |
|------|-----------|----------|-------------|--------|------|
| **ç•¶å‰ KV** | 11,102 | 15,510 | 0 | $0 (50% é¡åº¦) | 5/10 |
| **KV å»¶é•·çª—å£** | 7,202 | 15,510 | 0 | $0 (36% é¡åº¦) | 6/10 |
| **DO** | 0 | 0 | 26,612 | $0 (2.7% é¡åº¦) | 10/10 |

**è¨ˆç®—**ï¼š
- DO Requests = (2,000 Tap Ã— 2 checks) + (5,000 Read Ã— 0) + (100 Login Ã— 2) = 4,200/day Ã— 30 = 126,000/month
- DO å…è²»é¡åº¦ï¼š1M requests/month
- DO ä½¿ç”¨ç‡ï¼š126,000 / 1,000,000 = **12.6%**

**çµè«–**: Durable Objects æˆæœ¬æ•ˆç›Šæœ€é«˜ï¼Œä¸”æœ‰ **8x å®‰å…¨é‚Šéš›**ã€‚

---

### **ç¶­åº¦ 3: æ€§èƒ½è¡¨ç¾** âš¡

| æ–¹æ¡ˆ | å»¶é² | ååé‡ | å…¨çƒä¸€è‡´æ€§ | è©•åˆ† |
|------|------|--------|-----------|------|
| **ç•¶å‰ KV** | 10-50ms | é«˜ | âŒ 60s å»¶é² | 6/10 |
| **KV å»¶é•·çª—å£** | 10-50ms | é«˜ | âŒ 60s å»¶é² | 6/10 |
| **DO** | <5ms | æ¥µé«˜ | âœ… å³æ™‚ | 10/10 |

**çµè«–**: Durable Objects æ€§èƒ½å…¨é¢å„ªæ–¼ KVã€‚

---

### **ç¶­åº¦ 4: å¯¦ä½œè¤‡é›œåº¦** ğŸ› ï¸

| æ–¹æ¡ˆ | é–‹ç™¼æ™‚é–“ | æ¸¬è©¦é›£åº¦ | ç¶­è­·æˆæœ¬ | è©•åˆ† |
|------|---------|---------|---------|------|
| **ç•¶å‰ KV** | 0h (å·²å®Œæˆ) | ä½ | ä¸­ | 8/10 |
| **KV å»¶é•·çª—å£** | 0.5h | ä½ | ä¸­ | 9/10 |
| **DO** | 3-4h | ä¸­ | ä½ | 7/10 |

**çµè«–**: KV å»¶é•·çª—å£æœ€ç°¡å–®ï¼Œä½†æŠ€è¡“å‚µé«˜ï¼›DO åˆæœŸæŠ•å…¥é«˜ï¼Œé•·æœŸç¶­è­·æˆæœ¬ä½ã€‚

---

### **ç¶­åº¦ 5: å®‰å…¨æ€§** ğŸ”’

| æ–¹æ¡ˆ | é˜²ç¹éèƒ½åŠ› | æº–ç¢ºæ€§ | å¯©è¨ˆèƒ½åŠ› | è©•åˆ† |
|------|-----------|--------|---------|------|
| **ç•¶å‰ KV** | âŒ å¼± | âŒ ä¸æº–ç¢º | ä¸­ | 4/10 |
| **KV å»¶é•·çª—å£** | âŒ å¼± | âŒ ä¸æº–ç¢º | ä¸­ | 4/10 |
| **DO** | âœ… å¼· | âœ… æº–ç¢º | é«˜ | 10/10 |

**KV çš„å®‰å…¨å•é¡Œ**ï¼š
- æ”»æ“Šè€…å¯ä»¥åˆ©ç”¨æœ€çµ‚ä¸€è‡´æ€§ç¹éé™åˆ¶ï¼ˆå¾ä¸åŒ edge location ç™¼èµ·è«‹æ±‚ï¼‰
- è¨ˆæ•¸ä¸æº–ç¢ºå°è‡´é™åˆ¶å¤±æ•ˆ

**çµè«–**: Durable Objects æä¾›çœŸæ­£çš„å®‰å…¨ä¿éšœã€‚

---

### **ç¶­åº¦ 6: å¯æ“´å±•æ€§** ğŸ“ˆ

| æ–¹æ¡ˆ | æµé‡å¢é•·æ‰¿å—åŠ› | åœ°ç†æ“´å±• | åŠŸèƒ½æ“´å±• | è©•åˆ† |
|------|--------------|---------|---------|------|
| **ç•¶å‰ KV** | 2x (é”åˆ° 100% é¡åº¦) | è‡ªå‹• | å—é™ | 5/10 |
| **KV å»¶é•·çª—å£** | 3x | è‡ªå‹• | å—é™ | 6/10 |
| **DO** | 10x+ | è‡ªå‹• | éˆæ´» | 10/10 |

**çµè«–**: Durable Objects å¯æ‰¿å— 10x æµé‡å¢é•·ï¼Œä¸”åŠŸèƒ½æ“´å±•éˆæ´»ã€‚

---

## ğŸ“‹ æœ€çµ‚å»ºè­°ï¼ˆåŸºæ–¼å¤–éƒ¨æœ€ä½³å¯¦è¸ï¼‰

### **çŸ­æœŸæ–¹æ¡ˆï¼ˆ1 é€±å…§ï¼‰**ï¼šPhase 1 + Phase 2

#### **Phase 1: å¿«é€Ÿå„ªåŒ–**ï¼ˆ1 å°æ™‚ï¼Œç„¡é¢¨éšªï¼‰
1. âœ… Backend Cache TTL: 60s â†’ 300s/600s
2. âœ… Frontend Cache TTL: 300s â†’ 3600s
3. âœ… Session Budget TTL: å»¶é•· 2x

**æ•ˆæœ**: 
- KV ä½¿ç”¨é‡ï¼š50% â†’ 33%
- æŠ€è¡“å‚µï¼šä¸è®Šï¼ˆä»å­˜åœ¨ä¸€è‡´æ€§å•é¡Œï¼‰

---

#### **Phase 2: Rate Limiting çª—å£å»¶é•·**ï¼ˆ10 åˆ†é˜ï¼Œä½é¢¨éšªï¼‰
```typescript
// å¾ 1 hour å»¶é•·åˆ° 24 hours
export const RATE_LIMITS: RateLimitConfig = {
  card_uuid: { day: 500 },  // åŸ 50/hour Ã— 10 = 500/day
  ip: { day: 600 }           // åŸ 60/hour Ã— 10 = 600/day
};
```

**æ•ˆæœ**: 
- KV Writes: -3,000/day (-27%)
- KV ä½¿ç”¨é‡ï¼š33% â†’ 24%
- æŠ€è¡“å‚µï¼šä¸è®Šï¼ˆä»å­˜åœ¨ä¸€è‡´æ€§å•é¡Œï¼‰

**é¢¨éšªè©•ä¼°**ï¼š
- âœ… é™åˆ¶è®Šå¯¬é¬†ï¼ˆ50/hour â†’ 500/dayï¼‰ï¼Œä½†ä»è¶³å¤ åš´æ ¼
- âœ… ç¬¦åˆ EF-Map æ¡ˆä¾‹çš„ã€Œå»¶é•·è¼ªè©¢é–“éš”ã€ç­–ç•¥
- âš ï¸ ç„¡æ³•è§£æ±ºæœ€çµ‚ä¸€è‡´æ€§å•é¡Œ

---

### **é•·æœŸæ–¹æ¡ˆï¼ˆ2 é€±å…§ï¼‰**ï¼šPhase 3 - é·ç§»åˆ° Durable Objects

#### **ç‚ºä»€éº¼å¿…é ˆé·ç§»ï¼Ÿ**

1. **æŠ€è¡“æ­£ç¢ºæ€§**ï¼šCloudflare å®˜æ–¹æ˜ç¢ºæŒ‡å‡º KV ä¸é©åˆ Rate Limiting
2. **å®‰å…¨æ€§**ï¼šç•¶å‰æ–¹æ¡ˆå¯è¢«ç¹éï¼ˆåˆ©ç”¨æœ€çµ‚ä¸€è‡´æ€§ï¼‰
3. **æˆæœ¬æ•ˆç›Š**ï¼šDO å…è²»é¡åº¦æ˜¯ KV çš„ 10x
4. **æ€§èƒ½**ï¼šå»¶é²å¾ 10-50ms â†’ <5ms
5. **å¯æ“´å±•æ€§**ï¼šå¯æ‰¿å— 10x æµé‡å¢é•·

#### **å¯¦ä½œè¨ˆåŠƒ**ï¼ˆ3-4 å°æ™‚ï¼‰

**Step 1: å‰µå»º Durable Object Class**ï¼ˆ1 å°æ™‚ï¼‰
```typescript
// workers/src/durable-objects/rate-limiter.ts
export class RateLimiterDO extends DurableObject {
  async checkAndIncrement(dimension: string, identifier: string): Promise<RateLimitResult> {
    // å¼·ä¸€è‡´æ€§è¨ˆæ•¸å™¨
    const key = `${dimension}:${identifier}`;
    const state = await this.ctx.storage.get<RateLimitState>(key);
    
    // Sliding Window ç®—æ³•
    const now = Date.now();
    const windowStart = now - WINDOW_SIZE_MS;
    
    // æ¸…ç†éæœŸè«‹æ±‚
    const validRequests = (state?.requests || []).filter(t => t > windowStart);
    
    // æª¢æŸ¥é™åˆ¶
    if (validRequests.length >= LIMIT) {
      return { allowed: false, retryAfter: validRequests[0] + WINDOW_SIZE_MS - now };
    }
    
    // è¨˜éŒ„æ–°è«‹æ±‚
    validRequests.push(now);
    await this.ctx.storage.put(key, { requests: validRequests });
    
    return { allowed: true };
  }
}
```

**Step 2: æ›´æ–° wrangler.toml**ï¼ˆ5 åˆ†é˜ï¼‰
```toml
[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiterDO"
script_name = "db-card"
```

**Step 3: ä¿®æ”¹ handlers/tap.ts**ï¼ˆ1 å°æ™‚ï¼‰
```typescript
// å¾ KV é·ç§»åˆ° DO
const rateLimiterId = env.RATE_LIMITER.idFromName(card_uuid);
const rateLimiter = env.RATE_LIMITER.get(rateLimiterId);

const result = await rateLimiter.checkAndIncrement('card_uuid', card_uuid);
if (!result.allowed) {
  return errorResponse('rate_limited', 'è«‹æ±‚éæ–¼é »ç¹', 429);
}
```

**Step 4: æ¸¬è©¦èˆ‡éƒ¨ç½²**ï¼ˆ1 å°æ™‚ï¼‰
- å–®å…ƒæ¸¬è©¦ï¼ˆBDD è¦æ ¼ï¼‰
- æ•´åˆæ¸¬è©¦ï¼ˆStaging ç’°å¢ƒï¼‰
- ç°åº¦ç™¼å¸ƒï¼ˆ10% â†’ 50% â†’ 100%ï¼‰

---

#### **é·ç§»æ•ˆæœ**

| æŒ‡æ¨™ | ç•¶å‰ | Phase 1+2 | Phase 3 (DO) | æ”¹å–„ |
|------|------|-----------|--------------|------|
| **KV Writes** | 11,102 | 7,202 | **0** | **-100%** |
| **KV Reads** | 15,510 | 12,510 | **0** | **-100%** |
| **DO Requests** | 0 | 0 | **126,000** | +126K |
| **å»¶é²** | 10-50ms | 10-50ms | **<5ms** | **-90%** |
| **æº–ç¢ºæ€§** | âŒ ä¸æº–ç¢º | âŒ ä¸æº–ç¢º | âœ… **æº–ç¢º** | âœ… |
| **å®‰å…¨æ€§** | âŒ å¯ç¹é | âŒ å¯ç¹é | âœ… **å¼·** | âœ… |
| **æˆæœ¬** | $0 (50%) | $0 (24%) | **$0 (12.6%)** | **-75%** |

---

## ğŸ¯ æœ€çµ‚æ±ºç­–å»ºè­°

### **ç«‹å³åŸ·è¡Œ**ï¼ˆä»Šå¤©ï¼‰
âœ… **Phase 1: å¿«é€Ÿå„ªåŒ–**ï¼ˆ1 å°æ™‚ï¼‰
- Backend Cache TTL å»¶é•·
- Frontend Cache TTL å»¶é•·
- Session Budget TTL å»¶é•·

**ç†ç”±**: ç„¡é¢¨éšªï¼Œç«‹å³è¦‹æ•ˆï¼Œå°‡ä½¿ç”¨é‡å¾ 50% é™è‡³ 33%ã€‚

---

### **æœ¬é€±åŸ·è¡Œ**ï¼ˆ3 å¤©å…§ï¼‰
âœ… **Phase 2: Rate Limiting çª—å£å»¶é•·**ï¼ˆ10 åˆ†é˜ï¼‰
- 1 hour â†’ 24 hours

**ç†ç”±**: ä½é¢¨éšªï¼Œç¬¦åˆæ¥­ç•Œæœ€ä½³å¯¦è¸ï¼ˆEF-Map æ¡ˆä¾‹ï¼‰ï¼Œå°‡ä½¿ç”¨é‡é™è‡³ 24%ã€‚

---

### **2 é€±å…§åŸ·è¡Œ**ï¼ˆå„ªå…ˆç´šæœ€é«˜ï¼‰
âœ… **Phase 3: é·ç§»åˆ° Durable Objects**ï¼ˆ3-4 å°æ™‚ï¼‰

**ç†ç”±**: 
1. **æŠ€è¡“æ­£ç¢ºæ€§**ï¼šCloudflare å®˜æ–¹æ¨è–¦
2. **å®‰å…¨æ€§**ï¼šè§£æ±ºç•¶å‰æ–¹æ¡ˆçš„æ ¹æœ¬ç¼ºé™·
3. **æˆæœ¬æ•ˆç›Š**ï¼š10x å…è²»é¡åº¦
4. **æ€§èƒ½**ï¼šå»¶é²é™ä½ 90%
5. **å¯æ“´å±•æ€§**ï¼šå¯æ‰¿å— 10x æµé‡å¢é•·

**é¢¨éšªè©•ä¼°**: 
- é–‹ç™¼æ™‚é–“ï¼š3-4 å°æ™‚ï¼ˆå¯æ§ï¼‰
- æ¸¬è©¦æ™‚é–“ï¼š1 å°æ™‚ï¼ˆå……åˆ†ï¼‰
- å›æ»¾æˆæœ¬ï¼šä½ï¼ˆä¿ç•™ KV ä»£ç¢¼ä½œç‚º fallbackï¼‰

---

## ğŸ“š åƒè€ƒè³‡æ–™

1. **Cloudflare Community**: "Workers KV and rate limiting" (2019)
2. **EF-Map Blog**: "Reducing Cloud Costs by 93%" (2025-11-03)
3. **DZone**: "Why I Ditched Redis for Cloudflare Durable Objects" (2025-09-24)
4. **Cloudflare Docs**: "Choosing a data or storage product"
5. **Cloudflare Blog**: "Introducing Workers Durable Objects" (2020)

---

## âœ… è¡Œå‹•æ¸…å–®

- [ ] **ä»Šå¤©**: åŸ·è¡Œ Phase 1ï¼ˆ1 å°æ™‚ï¼‰
- [ ] **æœ¬é€±**: åŸ·è¡Œ Phase 2ï¼ˆ10 åˆ†é˜ï¼‰
- [ ] **2 é€±å…§**: åŸ·è¡Œ Phase 3ï¼ˆ3-4 å°æ™‚ï¼‰
- [ ] **æŒçºŒç›£æ§**: Cloudflare Dashboard è§€å¯Ÿ KV/DO ä½¿ç”¨é‡

**é æœŸæœ€çµ‚ç‹€æ…‹**ï¼š
- KV ä½¿ç”¨é‡ï¼š0%ï¼ˆå®Œå…¨ç§»é™¤ Rate Limiting çš„ KV ä¾è³´ï¼‰
- DO ä½¿ç”¨é‡ï¼š12.6%ï¼ˆå®‰å…¨é‚Šéš› 8xï¼‰
- å»¶é²ï¼š<5msï¼ˆæ€§èƒ½æå‡ 90%ï¼‰
- å®‰å…¨æ€§ï¼šå¼·ä¸€è‡´æ€§ï¼ˆç„¡æ³•ç¹éï¼‰
- æŠ€è¡“å‚µï¼šæ¸…é›¶ï¼ˆç¬¦åˆ Cloudflare å®˜æ–¹æœ€ä½³å¯¦è¸ï¼‰
