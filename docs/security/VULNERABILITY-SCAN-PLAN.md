# DB-Card å°ˆæ¡ˆå¼±é»æƒæè¨ˆåŠƒ

## ç‰ˆæœ¬è³‡è¨Š
- å°ˆæ¡ˆç‰ˆæœ¬: v4.3.2
- åˆ¶å®šæ—¥æœŸ: 2026-01-24
- åƒè€ƒæ¨™æº–: OWASP Top 10 2021, OWASP Testing Guide

---

## ä¸€ã€æƒæç›®æ¨™

### 1.1 æ‡‰ç”¨ç¨‹å¼ç¯„åœ
- **å‰ç«¯**: 
  - Landing Page (index.html)
  - Card Display (card-display.html)
  - User Portal (user-portal.html)
  - Admin Dashboard (admin-dashboard.html)

- **å¾Œç«¯ API**:
  - Public APIs: /api/nfc/tap, /api/read, /health
  - User APIs: /api/user/*, /api/oauth/*
  - Admin APIs: /api/admin/*

- **åŸºç¤è¨­æ–½**:
  - Cloudflare Workers
  - D1 Database
  - KV Storage

### 1.2 æ¸¬è©¦ç’°å¢ƒ
- **Staging**: https://db-card-staging.csw30454.workers.dev
- **Production**: https://db-card.csw30454.workers.dev (åƒ…è¢«å‹•æƒæ)

---

## äºŒã€OWASP Top 10 æ¸¬è©¦æ¸…å–®

### A01: Broken Access Control âš ï¸ é«˜å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] æ¸¬è©¦æœªæˆæ¬Šå­˜å– Admin API
- [ ] æ¸¬è©¦æ©«å‘æ¬Šé™æå‡ï¼ˆå­˜å–å…¶ä»–ä½¿ç”¨è€…çš„åç‰‡ï¼‰
- [ ] æ¸¬è©¦å‚ç›´æ¬Šé™æå‡ï¼ˆUser â†’ Adminï¼‰
- [ ] æ¸¬è©¦ IDOR (Insecure Direct Object Reference)
- [ ] æ¸¬è©¦ Session ç®¡ç†ï¼ˆCookie å®‰å…¨æ€§ï¼‰
- [ ] æ¸¬è©¦ CSRF Token é©—è­‰

**å·²çŸ¥é˜²è­·**:
- âœ… HttpOnly Cookie
- âœ… CSRF Token
- âœ… Admin éœ€è¦ SETUP_TOKEN
- âœ… User éœ€è¦ OAuth é©—è­‰
- âœ… ReadSession æˆæ¬Šæ©Ÿåˆ¶

### A02: Cryptographic Failures âš ï¸ é«˜å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] æ¸¬è©¦ HTTPS å¼·åˆ¶åŸ·è¡Œ
- [ ] æ¸¬è©¦æ•æ„Ÿè³‡æ–™åŠ å¯†ï¼ˆDEK/KEKï¼‰
- [ ] æ¸¬è©¦ Cookie å®‰å…¨å±¬æ€§ï¼ˆSecure, HttpOnly, SameSiteï¼‰
- [ ] æ¸¬è©¦å¯†ç¢¼å„²å­˜ï¼ˆbcrypt/scryptï¼‰
- [ ] æ¸¬è©¦ JWT Secret å¼·åº¦

**å·²çŸ¥é˜²è­·**:
- âœ… ä¿¡å°åŠ å¯†ï¼ˆEnvelope Encryptionï¼‰
- âœ… KEK è¼ªæ›¿æ©Ÿåˆ¶
- âœ… HttpOnly + Secure + SameSite Cookies
- âœ… JWT Secret (32+ bytes)

### A03: Injection ğŸ”¶ ä¸­å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] SQL Injection (D1 Database)
- [ ] NoSQL Injection (KV Storage)
- [ ] XSS (Cross-Site Scripting)
- [ ] Command Injection
- [ ] LDAP Injection

**å·²çŸ¥é˜²è­·**:
- âœ… Prepared Statements (D1)
- âœ… DOMPurify XSS é˜²è­·
- âœ… CSP Nonce-based
- âœ… Input Validation

### A04: Insecure Design ğŸ”¶ ä¸­å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] æ¸¬è©¦æ¥­å‹™é‚è¼¯æ¼æ´
- [ ] æ¸¬è©¦ Rate Limiting
- [ ] æ¸¬è©¦ Session Budget
- [ ] æ¸¬è©¦æ’¤éŠ·æ©Ÿåˆ¶
- [ ] æ¸¬è©¦ KEK è¼ªæ›¿æµç¨‹

**å·²çŸ¥é˜²è­·**:
- âœ… Rate Limiting (50/hour)
- âœ… Session Budget (daily/monthly)
- âœ… æ’¤éŠ·æ©Ÿåˆ¶
- âœ… KEK æœ¬åœ°è…³æœ¬åŸ·è¡Œ

### A05: Security Misconfiguration ğŸ”¶ ä¸­å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] æ¸¬è©¦é è¨­å¸³è™Ÿ/å¯†ç¢¼
- [ ] æ¸¬è©¦éŒ¯èª¤è¨Šæ¯æ´©æ¼
- [ ] æ¸¬è©¦ HTTP Headers
- [ ] æ¸¬è©¦ CORS é…ç½®
- [ ] æ¸¬è©¦ Debug Mode

**å·²çŸ¥é˜²è­·**:
- âœ… CSP Headers
- âœ… CORS Whitelist
- âœ… éŒ¯èª¤è¨Šæ¯ä¸æ´©æ¼æ•æ„Ÿè³‡è¨Š
- âœ… ç„¡é è¨­å¸³è™Ÿ

### A06: Vulnerable and Outdated Components ğŸ”¶ ä¸­å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] æª¢æŸ¥ npm ä¾è³´æ¼æ´
- [ ] æª¢æŸ¥ CDN è³‡æºç‰ˆæœ¬
- [ ] æª¢æŸ¥ Subresource Integrity (SRI)

**å·²çŸ¥é˜²è­·**:
- âœ… SRI 75% è¦†è“‹ç‡
- âœ… ä¾è³´å®šæœŸæ›´æ–°
- âš ï¸ Three.js r128 (èˆŠç‰ˆæœ¬)

### A07: Identification and Authentication Failures âš ï¸ é«˜å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] æ¸¬è©¦æš´åŠ›ç ´è§£é˜²è­·
- [ ] æ¸¬è©¦ Session å›ºå®šæ”»æ“Š
- [ ] æ¸¬è©¦ OAuth æµç¨‹å®‰å…¨æ€§
- [ ] æ¸¬è©¦ OIDC å¯¦ä½œ
- [ ] æ¸¬è©¦ Passkey å¯¦ä½œ

**å·²çŸ¥é˜²è­·**:
- âœ… OIDC 90% åˆè¦
- âœ… State + Nonce é˜²è­·
- âœ… HttpOnly Cookie
- âœ… Passkey æ”¯æ´
- âš ï¸ ç„¡æš´åŠ›ç ´è§£é˜²è­·ï¼ˆSETUP_TOKENï¼‰

### A08: Software and Data Integrity Failures ğŸ”· ä½å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] æ¸¬è©¦ CI/CD Pipeline å®‰å…¨æ€§
- [ ] æ¸¬è©¦ Subresource Integrity
- [ ] æ¸¬è©¦ç¨‹å¼ç¢¼ç°½ç« 

**å·²çŸ¥é˜²è­·**:
- âœ… SRI 75% è¦†è“‹ç‡
- âœ… GitHub Actions éƒ¨ç½²

### A09: Security Logging and Monitoring Failures ğŸ”¶ ä¸­å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] æ¸¬è©¦ Audit Log å®Œæ•´æ€§
- [ ] æ¸¬è©¦ Security Events è¨˜éŒ„
- [ ] æ¸¬è©¦ IP åŒ¿ååŒ–
- [ ] æ¸¬è©¦æ—¥èªŒä¿ç•™æœŸé™

**å·²çŸ¥é˜²è­·**:
- âœ… Audit Logs (365 å¤©)
- âœ… Security Events (90 å¤©)
- âœ… IP åŒ¿ååŒ–
- âœ… å®Œæ•´äº‹ä»¶è¨˜éŒ„

### A10: Server-Side Request Forgery (SSRF) ğŸ”· ä½å„ªå…ˆç´š
**æ¸¬è©¦é …ç›®**:
- [ ] æ¸¬è©¦ SSRF æ¼æ´
- [ ] æ¸¬è©¦ URL é©—è­‰

**å·²çŸ¥é˜²è­·**:
- âœ… ç„¡ä½¿ç”¨è€…å¯æ§çš„ URL è«‹æ±‚

---

## ä¸‰ã€å·¥å…·é¸æ“‡

### 3.1 è‡ªå‹•åŒ–æƒæå·¥å…·

#### OWASP ZAP (æ¨è–¦)
**å„ªé»**:
- å…è²»é–‹æº
- æ”¯æ´è¢«å‹• + ä¸»å‹•æƒæ
- å¯æ•´åˆ CI/CD
- æ”¯æ´ API æ¸¬è©¦

**ä½¿ç”¨æ–¹å¼**:
```bash
# è¢«å‹•æƒæï¼ˆProduction å¯ç”¨ï¼‰
docker run -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-stable zap-baseline.py \
  -t https://db-card.csw30454.workers.dev \
  -r zap-report.html

# ä¸»å‹•æƒæï¼ˆåƒ… Stagingï¼‰
docker run -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-stable zap-full-scan.py \
  -t https://db-card-staging.csw30454.workers.dev \
  -r zap-full-report.html
```

#### Burp Suite Community Edition
**å„ªé»**:
- å¼·å¤§çš„æ‰‹å‹•æ¸¬è©¦åŠŸèƒ½
- Proxy + Repeater + Intruder
- é©åˆæ·±åº¦æ¸¬è©¦

**ä½¿ç”¨æ–¹å¼**:
1. è¨­å®šç€è¦½å™¨ Proxy (127.0.0.1:8080)
2. ç€è¦½æ‡‰ç”¨ç¨‹å¼ï¼Œè¨˜éŒ„æ‰€æœ‰è«‹æ±‚
3. æ‰‹å‹•æ¸¬è©¦å¯ç–‘ç«¯é»

### 3.2 ä¾è³´æƒæå·¥å…·

#### npm audit
```bash
cd workers
npm audit
npm audit fix
```

#### Snyk
```bash
npm install -g snyk
snyk test
snyk monitor
```

---

## å››ã€æ¸¬è©¦æµç¨‹

### 4.1 éšæ®µ 1: è¢«å‹•æƒæï¼ˆProduction å®‰å…¨ï¼‰
**æ™‚é–“**: 1 å°æ™‚
**å·¥å…·**: OWASP ZAP Baseline Scan

**æ­¥é©Ÿ**:
1. åŸ·è¡Œ ZAP Baseline Scan
2. åˆ†æå ±å‘Š
3. è¨˜éŒ„ç™¼ç¾çš„å•é¡Œ
4. ä¸å½±éŸ¿æ­£å¸¸æœå‹™

### 4.2 éšæ®µ 2: ä¸»å‹•æƒæï¼ˆåƒ… Stagingï¼‰
**æ™‚é–“**: 2-3 å°æ™‚
**å·¥å…·**: OWASP ZAP Full Scan

**æ­¥é©Ÿ**:
1. é€šçŸ¥åœ˜éšŠï¼ˆé¿å…èª¤å ±ï¼‰
2. åŸ·è¡Œ ZAP Full Scan
3. åˆ†æå ±å‘Š
4. é©—è­‰æ¼æ´

**æ³¨æ„äº‹é …**:
- âš ï¸ å¯èƒ½è§¸ç™¼ Rate Limiting
- âš ï¸ å¯èƒ½ç”¢ç”Ÿå¤§é‡ Audit Logs
- âš ï¸ éœ€è¦åœ¨ Cloudflare ç™½åå–®æ¸¬è©¦ IP

### 4.3 éšæ®µ 3: æ‰‹å‹•æ¸¬è©¦ï¼ˆæ·±åº¦é©—è­‰ï¼‰
**æ™‚é–“**: 4-6 å°æ™‚
**å·¥å…·**: Burp Suite + æ‰‹å‹•æ¸¬è©¦

**é‡é»æ¸¬è©¦**:
1. **èªè­‰ç¹é**:
   - å˜—è©¦ä¸å¸¶ Cookie å­˜å– Admin API
   - å˜—è©¦å½é€  JWT Token
   - å˜—è©¦ Session å›ºå®šæ”»æ“Š

2. **æˆæ¬Šæ¼æ´**:
   - å˜—è©¦å­˜å–å…¶ä»–ä½¿ç”¨è€…çš„åç‰‡
   - å˜—è©¦ä¿®æ”¹å…¶ä»–ä½¿ç”¨è€…çš„è³‡æ–™
   - å˜—è©¦æå‡æ¬Šé™

3. **æ¥­å‹™é‚è¼¯**:
   - æ¸¬è©¦ Session Budget ç¹é
   - æ¸¬è©¦ Rate Limiting ç¹é
   - æ¸¬è©¦æ’¤éŠ·æ©Ÿåˆ¶ç¹é

4. **æ³¨å…¥æ”»æ“Š**:
   - SQL Injection (D1)
   - XSS (æ‰€æœ‰è¼¸å…¥æ¬„ä½)
   - Command Injection

### 4.4 éšæ®µ 4: ä¾è³´æƒæ
**æ™‚é–“**: 30 åˆ†é˜
**å·¥å…·**: npm audit + Snyk

**æ­¥é©Ÿ**:
1. åŸ·è¡Œ npm audit
2. æª¢æŸ¥ CVE è³‡æ–™åº«
3. æ›´æ–°æœ‰æ¼æ´çš„ä¾è³´
4. é‡æ–°æ¸¬è©¦

---

## äº”ã€Cloudflare Workers ç‰¹æ®Šè€ƒé‡

### 5.1 æ¸¬è©¦å‰æº–å‚™
1. **ç™½åå–®æ¸¬è©¦ IP**:
   - åœ¨ Cloudflare WAF ä¸­ç™½åå–®æ¸¬è©¦ IP
   - é¿å…è¢« Rate Limiting é˜»æ“‹

2. **é€šçŸ¥åœ˜éšŠ**:
   - å‘ŠçŸ¥æ¸¬è©¦æ™‚é–“
   - é¿å…èª¤å ±ç‚ºæ”»æ“Š

3. **å‚™ä»½è³‡æ–™**:
   - å‚™ä»½ D1 Database
   - å‚™ä»½ KV Storage

### 5.2 æ¸¬è©¦é™åˆ¶
- âŒ ç„¡æ³•æ¸¬è©¦ Infrastructure å±¤ï¼ˆCloudflare ç®¡ç†ï¼‰
- âŒ ç„¡æ³•æ¸¬è©¦ DDoS é˜²è­·ï¼ˆCloudflare ç®¡ç†ï¼‰
- âœ… å¯ä»¥æ¸¬è©¦ Application å±¤
- âœ… å¯ä»¥æ¸¬è©¦ API å®‰å…¨æ€§

---

## å…­ã€å ±å‘Šæ ¼å¼

### 6.1 æ¼æ´åˆ†ç´š
- **Critical**: å¯ç›´æ¥å–å¾—ç³»çµ±æ§åˆ¶æ¬Š
- **High**: å¯å­˜å–æ•æ„Ÿè³‡æ–™
- **Medium**: å¯å½±éŸ¿éƒ¨åˆ†åŠŸèƒ½
- **Low**: è³‡è¨Šæ´©æ¼
- **Info**: æœ€ä½³å¯¦è¸å»ºè­°

### 6.2 å ±å‘Šå…§å®¹
1. **åŸ·è¡Œæ‘˜è¦**
2. **æ¸¬è©¦ç¯„åœ**
3. **æ¸¬è©¦æ–¹æ³•**
4. **ç™¼ç¾çš„æ¼æ´**ï¼ˆä¾åš´é‡æ€§æ’åºï¼‰
5. **ä¿®å¾©å»ºè­°**
6. **é™„éŒ„**ï¼ˆè©³ç´°æ¸¬è©¦çµæœï¼‰

---

## ä¸ƒã€æ™‚ç¨‹è¦åŠƒ

### ç¸½æ™‚é–“: 8-11 å°æ™‚

| éšæ®µ | æ™‚é–“ | å·¥å…· | ç’°å¢ƒ |
|------|------|------|------|
| è¢«å‹•æƒæ | 1h | OWASP ZAP | Production |
| ä¸»å‹•æƒæ | 2-3h | OWASP ZAP | Staging |
| æ‰‹å‹•æ¸¬è©¦ | 4-6h | Burp Suite | Staging |
| ä¾è³´æƒæ | 0.5h | npm audit | Local |
| å ±å‘Šæ’°å¯« | 1-2h | - | - |

### å»ºè­°åŸ·è¡Œæ™‚é–“
- **é€±æœ«æˆ–éç‡Ÿæ¥­æ™‚é–“**ï¼ˆé¿å…å½±éŸ¿ä½¿ç”¨è€…ï¼‰
- **Staging ç’°å¢ƒå„ªå…ˆ**ï¼ˆé™ä½é¢¨éšªï¼‰
- **åˆ†éšæ®µåŸ·è¡Œ**ï¼ˆæ¯éšæ®µé–“éš” 1-2 å¤©ï¼‰

---

## å…«ã€é æœŸç™¼ç¾

### 8.1 é«˜é¢¨éšªï¼ˆé æœŸ 0-2 å€‹ï¼‰
- å¯èƒ½ï¼šSETUP_TOKEN æš´åŠ›ç ´è§£
- å¯èƒ½ï¼šThree.js r128 å·²çŸ¥æ¼æ´

### 8.2 ä¸­é¢¨éšªï¼ˆé æœŸ 2-5 å€‹ï¼‰
- å¯èƒ½ï¼šéŒ¯èª¤è¨Šæ¯æ´©æ¼
- å¯èƒ½ï¼šRate Limiting ç¹é
- å¯èƒ½ï¼šCORS é…ç½®å•é¡Œ

### 8.3 ä½é¢¨éšªï¼ˆé æœŸ 5-10 å€‹ï¼‰
- å¯èƒ½ï¼šHTTP Headers ç¼ºå¤±
- å¯èƒ½ï¼šè³‡è¨Šæ´©æ¼
- å¯èƒ½ï¼šæœ€ä½³å¯¦è¸å»ºè­°

---

## ä¹ã€ä¿®å¾©å„ªå…ˆç´š

### P0 - ç«‹å³ä¿®å¾©ï¼ˆ24 å°æ™‚å…§ï¼‰
- Critical æ¼æ´
- å¯ç›´æ¥å–å¾—ç³»çµ±æ§åˆ¶æ¬Š

### P1 - é«˜å„ªå…ˆç´šï¼ˆ1 é€±å…§ï¼‰
- High æ¼æ´
- å¯å­˜å–æ•æ„Ÿè³‡æ–™

### P2 - ä¸­å„ªå…ˆç´šï¼ˆ1 å€‹æœˆå…§ï¼‰
- Medium æ¼æ´
- å¯å½±éŸ¿éƒ¨åˆ†åŠŸèƒ½

### P3 - ä½å„ªå…ˆç´šï¼ˆä¸‹æ¬¡ç‰ˆæœ¬ï¼‰
- Low æ¼æ´
- è³‡è¨Šæ´©æ¼

---

## åã€æŒçºŒæ”¹é€²

### 10.1 å®šæœŸæƒæ
- **æ¯æœˆ**: è¢«å‹•æƒæ
- **æ¯å­£**: ä¸»å‹•æƒæ
- **æ¯åŠå¹´**: å®Œæ•´æ»²é€æ¸¬è©¦

### 10.2 CI/CD æ•´åˆ
```yaml
# .github/workflows/security-scan.yml
name: Security Scan
on:
  schedule:
    - cron: '0 0 * * 0'  # æ¯é€±æ—¥
  workflow_dispatch:

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    steps:
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'https://db-card-staging.csw30454.workers.dev'
```

### 10.3 ä¾è³´æ›´æ–°
```yaml
# .github/workflows/dependency-update.yml
name: Dependency Update
on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯é€±ä¸€

jobs:
  npm-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: npm audit
        run: |
          cd workers
          npm audit
          npm audit fix
```

---

## åä¸€ã€åƒè€ƒè³‡æº

### 11.1 æ¨™æº–èˆ‡æŒ‡å—
- [OWASP Top 10 2021](https://owasp.org/Top10/)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
- [OWASP API Security Top 10](https://owasp.org/www-project-api-security/)

### 11.2 å·¥å…·æ–‡æª”
- [OWASP ZAP Documentation](https://www.zaproxy.org/docs/)
- [Burp Suite Documentation](https://portswigger.net/burp/documentation)
- [Cloudflare Security Best Practices](https://developers.cloudflare.com/workers/platform/security/)

### 11.3 ç ”ç©¶ä¾†æº
- 70% æ‡‰ç”¨ç¨‹å¼æœ‰å¯è¢«æƒæç™¼ç¾çš„æ¼æ´
- Skeleton Screen å¯æ”¹å–„æ„ŸçŸ¥æ€§èƒ½ 50%
- è¢«å‹•æƒæä¸å½±éŸ¿æ­£å¸¸æœå‹™
- ä¸»å‹•æƒæéœ€è¦ç™½åå–® IP

---

## é™„éŒ„ A: æ¸¬è©¦ç”¨ä¾‹ç¯„ä¾‹

### A.1 èªè­‰ç¹éæ¸¬è©¦
```bash
# æ¸¬è©¦ä¸å¸¶ Cookie å­˜å– Admin API
curl -X GET https://db-card-staging.csw30454.workers.dev/api/admin/cards

# é æœŸçµæœ: 401 Unauthorized
```

### A.2 IDOR æ¸¬è©¦
```bash
# å˜—è©¦å­˜å–å…¶ä»–ä½¿ç”¨è€…çš„åç‰‡
curl -X GET https://db-card-staging.csw30454.workers.dev/api/user/cards/{other_user_uuid} \
  -H "Cookie: auth_token=YOUR_TOKEN"

# é æœŸçµæœ: 403 Forbidden
```

### A.3 SQL Injection æ¸¬è©¦
```bash
# æ¸¬è©¦ SQL Injection
curl -X POST https://db-card-staging.csw30454.workers.dev/api/nfc/tap \
  -H "Content-Type: application/json" \
  -d '{"card_uuid": "' OR '1'='1"}'

# é æœŸçµæœ: 400 Bad Request æˆ–æ­£å¸¸è™•ç†ï¼ˆPrepared Statement é˜²è­·ï¼‰
```

---

**åˆ¶å®šè€…**: Kiro (AWS AI Assistant)  
**å¯©æ ¸è€…**: å¾…æŒ‡å®š  
**æ ¸å‡†è€…**: å¾…æŒ‡å®š  
**ç‰ˆæœ¬**: 1.0  
**æœ€å¾Œæ›´æ–°**: 2026-01-24
