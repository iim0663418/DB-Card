<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 PWA Security Test Suite</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-section h2 {
            color: #34495e;
            margin-top: 0;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
        .test-controls {
            text-align: center;
            margin: 20px 0;
        }
        .summary {
            background: #34495e;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .file-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›¡ï¸ Phase 4: PWA Security Headers & CSP Test Suite</h1>
        
        <div class="summary">
            <h3>æ¸¬è©¦æ¦‚è¦½</h3>
            <p><strong>Phase 4 åŠŸèƒ½:</strong> PWA Security Headers & CSP (PWA-12 to PWA-15)</p>
            <p><strong>æ¸¬è©¦ç¯„åœ:</strong> åš´æ ¼ CSPã€PWA å®‰å…¨æ¨™é ­ã€Service Worker å®‰å…¨ã€æª”æ¡ˆåŒ¯å…¥é©—è­‰</p>
            <div class="progress-bar">
                <div class="progress-fill" id="overall-progress"></div>
            </div>
            <p id="progress-text">æº–å‚™é–‹å§‹æ¸¬è©¦...</p>
        </div>

        <div class="test-controls">
            <button onclick="runAllTests()">ğŸš€ åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
            <button onclick="exportResults()">ğŸ“Š åŒ¯å‡ºçµæœ</button>
        </div>

        <!-- PWA-12: Strict CSP Tests -->
        <div class="test-section">
            <h2>PWA-12: åš´æ ¼å…§å®¹å®‰å…¨æ”¿ç­– (Strict CSP)</h2>
            <div class="test-item">
                <h4>CSP æ¨™é ­ç”Ÿæˆæ¸¬è©¦</h4>
                <button onclick="testCSPGeneration()">æ¸¬è©¦ CSP ç”Ÿæˆ</button>
                <div id="csp-generation-result"></div>
            </div>
            <div class="test-item">
                <h4>Nonce ç”Ÿæˆèˆ‡é©—è­‰</h4>
                <button onclick="testNonceGeneration()">æ¸¬è©¦ Nonce</button>
                <div id="nonce-result"></div>
            </div>
            <div class="test-item">
                <h4>CSP é•è¦ç›£æ§</h4>
                <button onclick="testCSPViolationMonitoring()">æ¸¬è©¦é•è¦ç›£æ§</button>
                <div id="csp-violation-result"></div>
            </div>
        </div>

        <!-- PWA-13: PWA Security Headers Tests -->
        <div class="test-section">
            <h2>PWA-13: PWA å®‰å…¨æ¨™é ­</h2>
            <div class="test-item">
                <h4>å®‰å…¨æ¨™é ­å®Œæ•´æ€§</h4>
                <button onclick="testSecurityHeaders()">æ¸¬è©¦å®‰å…¨æ¨™é ­</button>
                <div id="security-headers-result"></div>
            </div>
            <div class="test-item">
                <h4>æ¬Šé™æ”¿ç­–è¨­å®š</h4>
                <button onclick="testPermissionsPolicy()">æ¸¬è©¦æ¬Šé™æ”¿ç­–</button>
                <div id="permissions-policy-result"></div>
            </div>
            <div class="test-item">
                <h4>è·¨åŸŸå®‰å…¨è¨­å®š</h4>
                <button onclick="testCORSHeaders()">æ¸¬è©¦è·¨åŸŸæ¨™é ­</button>
                <div id="cors-headers-result"></div>
            </div>
        </div>

        <!-- PWA-14: Service Worker Security Tests -->
        <div class="test-section">
            <h2>PWA-14: Service Worker å®‰å…¨å¼·åŒ–</h2>
            <div class="test-item">
                <h4>å¿«å–å®Œæ•´æ€§é©—è­‰</h4>
                <button onclick="testCacheIntegrity()">æ¸¬è©¦å¿«å–å®Œæ•´æ€§</button>
                <div id="cache-integrity-result"></div>
            </div>
            <div class="test-item">
                <h4>å®‰å…¨æ¨™é ­æ³¨å…¥</h4>
                <button onclick="testSWSecurityHeaders()">æ¸¬è©¦ SW å®‰å…¨æ¨™é ­</button>
                <div id="sw-security-headers-result"></div>
            </div>
            <div class="test-item">
                <h4>å…§å®¹é¡å‹é©—è­‰</h4>
                <button onclick="testContentTypeValidation()">æ¸¬è©¦å…§å®¹é¡å‹</button>
                <div id="content-type-result"></div>
            </div>
        </div>

        <!-- PWA-15: Secure File Import Tests -->
        <div class="test-section">
            <h2>PWA-15: å®‰å…¨æª”æ¡ˆåŒ¯å…¥é©—è­‰</h2>
            <div class="test-item">
                <h4>æª”æ¡ˆé¡å‹é©—è­‰</h4>
                <div class="file-input">
                    <input type="file" id="test-file" accept=".json,.vcf,.enc">
                    <p>é¸æ“‡æ¸¬è©¦æª”æ¡ˆ (æ”¯æ´ .json, .vcf, .enc)</p>
                </div>
                <button onclick="testFileValidation()">æ¸¬è©¦æª”æ¡ˆé©—è­‰</button>
                <div id="file-validation-result"></div>
            </div>
            <div class="test-item">
                <h4>æƒ¡æ„å…§å®¹æª¢æ¸¬</h4>
                <button onclick="testMaliciousContentDetection()">æ¸¬è©¦æƒ¡æ„å…§å®¹æª¢æ¸¬</button>
                <div id="malicious-content-result"></div>
            </div>
            <div class="test-item">
                <h4>JSON å®‰å…¨è§£æ</h4>
                <button onclick="testSecureJSONParsing()">æ¸¬è©¦å®‰å…¨ JSON è§£æ</button>
                <div id="secure-json-result"></div>
            </div>
        </div>

        <div class="summary" id="test-summary" style="display: none;">
            <h3>æ¸¬è©¦çµæœæ‘˜è¦</h3>
            <div id="summary-content"></div>
        </div>
    </div>

    <!-- Load Security Modules -->
    <script src="../../src/security/PWASecurityHeaders.js"></script>
    <script src="../../src/security/SecureFileValidator.js"></script>
    <script src="../../src/security/SecurityInputHandler.js"></script>
    <script src="../../src/security/SecurityDataHandler.js"></script>
    <script src="../../src/security/InputValidationSchema.js"></script>

    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0,
            details: []
        };

        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            document.getElementById('overall-progress').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = 
                `æ¸¬è©¦é€²åº¦: ${current}/${total} (${percentage}%)`;
        }

        function logResult(testName, success, message, details = null) {
            testResults.total++;
            if (success) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            
            testResults.details.push({
                test: testName,
                success,
                message,
                details,
                timestamp: new Date().toISOString()
            });
        }

        function displayResult(elementId, success, message, details = null) {
            const element = document.getElementById(elementId);
            const resultClass = success ? 'success' : 'error';
            
            let html = `<div class="test-result ${resultClass}">${message}</div>`;
            
            if (details) {
                html += `<div class="code-block">${JSON.stringify(details, null, 2)}</div>`;
            }
            
            element.innerHTML = html;
        }

        // PWA-12: CSP Tests
        async function testCSPGeneration() {
            try {
                if (!window.PWASecurityHeaders) {
                    throw new Error('PWASecurityHeaders æ¨¡çµ„æœªè¼‰å…¥');
                }

                const headers = window.PWASecurityHeaders.getSecurityHeaders();
                const csp = headers['Content-Security-Policy'];
                
                const requiredDirectives = [
                    'default-src',
                    'script-src',
                    'style-src',
                    'object-src',
                    'base-uri',
                    'frame-ancestors'
                ];

                const missingDirectives = requiredDirectives.filter(directive => 
                    !csp.includes(directive)
                );

                if (missingDirectives.length > 0) {
                    throw new Error(`ç¼ºå°‘å¿…è¦çš„ CSP æŒ‡ä»¤: ${missingDirectives.join(', ')}`);
                }

                logResult('CSP Generation', true, 'CSP æ¨™é ­ç”ŸæˆæˆåŠŸ');
                displayResult('csp-generation-result', true, 
                    'âœ… CSP æ¨™é ­ç”ŸæˆæˆåŠŸï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦æŒ‡ä»¤', 
                    { csp: csp.substring(0, 200) + '...' }
                );
            } catch (error) {
                logResult('CSP Generation', false, error.message);
                displayResult('csp-generation-result', false, `âŒ ${error.message}`);
            }
        }

        async function testNonceGeneration() {
            try {
                if (!window.PWASecurityHeaders) {
                    throw new Error('PWASecurityHeaders æ¨¡çµ„æœªè¼‰å…¥');
                }

                const nonce1 = window.PWASecurityHeaders.getCurrentNonce();
                const nonce2 = window.PWASecurityHeaders.regenerateNonce();
                
                if (!nonce1 || !nonce2) {
                    throw new Error('Nonce ç”Ÿæˆå¤±æ•—');
                }

                if (nonce1 === nonce2) {
                    throw new Error('Nonce æœªæ­£ç¢ºé‡æ–°ç”Ÿæˆ');
                }

                if (nonce2.length < 16) {
                    throw new Error('Nonce é•·åº¦ä¸è¶³');
                }

                logResult('Nonce Generation', true, 'Nonce ç”Ÿæˆèˆ‡é©—è­‰æˆåŠŸ');
                displayResult('nonce-result', true, 
                    'âœ… Nonce ç”Ÿæˆèˆ‡é‡æ–°ç”ŸæˆåŠŸèƒ½æ­£å¸¸', 
                    { nonce1: nonce1.substring(0, 10) + '...', nonce2: nonce2.substring(0, 10) + '...' }
                );
            } catch (error) {
                logResult('Nonce Generation', false, error.message);
                displayResult('nonce-result', false, `âŒ ${error.message}`);
            }
        }

        async function testCSPViolationMonitoring() {
            try {
                let violationDetected = false;
                
                // ç›£è½ CSP é•è¦äº‹ä»¶
                const violationHandler = (event) => {
                    violationDetected = true;
                    document.removeEventListener('securitypolicyviolation', violationHandler);
                };
                
                document.addEventListener('securitypolicyviolation', violationHandler);
                
                // å˜—è©¦è§¸ç™¼ CSP é•è¦ï¼ˆå®‰å…¨çš„æ–¹å¼ï¼‰
                try {
                    const script = document.createElement('script');
                    script.innerHTML = 'console.log("test");';
                    document.head.appendChild(script);
                    document.head.removeChild(script);
                } catch (e) {
                    // CSP é˜»æ­¢äº†è…³æœ¬åŸ·è¡Œï¼Œé€™æ˜¯é æœŸçš„
                }

                // ç­‰å¾…ä¸€å°æ®µæ™‚é–“æª¢æŸ¥æ˜¯å¦æœ‰é•è¦äº‹ä»¶
                await new Promise(resolve => setTimeout(resolve, 100));

                logResult('CSP Violation Monitoring', true, 'CSP é•è¦ç›£æ§åŠŸèƒ½æ­£å¸¸');
                displayResult('csp-violation-result', true, 
                    'âœ… CSP é•è¦ç›£æ§åŠŸèƒ½å·²å•Ÿç”¨', 
                    { violationDetected }
                );
            } catch (error) {
                logResult('CSP Violation Monitoring', false, error.message);
                displayResult('csp-violation-result', false, `âŒ ${error.message}`);
            }
        }

        // PWA-13: Security Headers Tests
        async function testSecurityHeaders() {
            try {
                if (!window.PWASecurityHeaders) {
                    throw new Error('PWASecurityHeaders æ¨¡çµ„æœªè¼‰å…¥');
                }

                const headers = window.PWASecurityHeaders.getSecurityHeaders();
                
                const requiredHeaders = [
                    'Content-Security-Policy',
                    'X-Content-Type-Options',
                    'X-Frame-Options',
                    'X-XSS-Protection',
                    'Referrer-Policy'
                ];

                const missingHeaders = requiredHeaders.filter(header => !headers[header]);

                if (missingHeaders.length > 0) {
                    throw new Error(`ç¼ºå°‘å¿…è¦çš„å®‰å…¨æ¨™é ­: ${missingHeaders.join(', ')}`);
                }

                // æª¢æŸ¥æ¨™é ­å€¼
                if (headers['X-Content-Type-Options'] !== 'nosniff') {
                    throw new Error('X-Content-Type-Options è¨­å®šä¸æ­£ç¢º');
                }

                if (headers['X-Frame-Options'] !== 'DENY') {
                    throw new Error('X-Frame-Options è¨­å®šä¸æ­£ç¢º');
                }

                logResult('Security Headers', true, 'å®‰å…¨æ¨™é ­è¨­å®šå®Œæ•´');
                displayResult('security-headers-result', true, 
                    'âœ… æ‰€æœ‰å¿…è¦çš„å®‰å…¨æ¨™é ­éƒ½å·²æ­£ç¢ºè¨­å®š', 
                    { headerCount: Object.keys(headers).length }
                );
            } catch (error) {
                logResult('Security Headers', false, error.message);
                displayResult('security-headers-result', false, `âŒ ${error.message}`);
            }
        }

        async function testPermissionsPolicy() {
            try {
                if (!window.PWASecurityHeaders) {
                    throw new Error('PWASecurityHeaders æ¨¡çµ„æœªè¼‰å…¥');
                }

                const headers = window.PWASecurityHeaders.getSecurityHeaders();
                const permissionsPolicy = headers['Permissions-Policy'];

                if (!permissionsPolicy) {
                    throw new Error('Permissions-Policy æ¨™é ­æœªè¨­å®š');
                }

                const restrictedFeatures = ['camera', 'microphone', 'geolocation', 'payment'];
                const missingRestrictions = restrictedFeatures.filter(feature => 
                    !permissionsPolicy.includes(`${feature}=()`)
                );

                if (missingRestrictions.length > 0) {
                    throw new Error(`ç¼ºå°‘æ¬Šé™é™åˆ¶: ${missingRestrictions.join(', ')}`);
                }

                logResult('Permissions Policy', true, 'æ¬Šé™æ”¿ç­–è¨­å®šæ­£ç¢º');
                displayResult('permissions-policy-result', true, 
                    'âœ… æ¬Šé™æ”¿ç­–å·²æ­£ç¢ºé™åˆ¶æ•æ„ŸåŠŸèƒ½', 
                    { policy: permissionsPolicy.substring(0, 100) + '...' }
                );
            } catch (error) {
                logResult('Permissions Policy', false, error.message);
                displayResult('permissions-policy-result', false, `âŒ ${error.message}`);
            }
        }

        async function testCORSHeaders() {
            try {
                if (!window.PWASecurityHeaders) {
                    throw new Error('PWASecurityHeaders æ¨¡çµ„æœªè¼‰å…¥');
                }

                const headers = window.PWASecurityHeaders.getSecurityHeaders();
                
                const corsHeaders = [
                    'Cross-Origin-Embedder-Policy',
                    'Cross-Origin-Opener-Policy',
                    'Cross-Origin-Resource-Policy'
                ];

                const missingCORSHeaders = corsHeaders.filter(header => !headers[header]);

                if (missingCORSHeaders.length > 0) {
                    throw new Error(`ç¼ºå°‘ CORS å®‰å…¨æ¨™é ­: ${missingCORSHeaders.join(', ')}`);
                }

                logResult('CORS Headers', true, 'CORS å®‰å…¨æ¨™é ­è¨­å®šå®Œæ•´');
                displayResult('cors-headers-result', true, 
                    'âœ… è·¨åŸŸå®‰å…¨æ¨™é ­å·²æ­£ç¢ºè¨­å®š', 
                    { 
                        coep: headers['Cross-Origin-Embedder-Policy'],
                        coop: headers['Cross-Origin-Opener-Policy'],
                        corp: headers['Cross-Origin-Resource-Policy']
                    }
                );
            } catch (error) {
                logResult('CORS Headers', false, error.message);
                displayResult('cors-headers-result', false, `âŒ ${error.message}`);
            }
        }

        // PWA-14: Service Worker Security Tests
        async function testCacheIntegrity() {
            try {
                // æ¨¡æ“¬å¿«å–å®Œæ•´æ€§é©—è­‰
                const mockResponse = new Response('test content', {
                    status: 200,
                    headers: { 'content-type': 'text/html' }
                });

                const mockRequest = new Request('/test');

                // é€™è£¡æ‡‰è©²æ¸¬è©¦ Service Worker ä¸­çš„ validateCacheIntegrity å‡½æ•¸
                // ç”±æ–¼åœ¨ä¸»ç·šç¨‹ä¸­ï¼Œæˆ‘å€‘æ¨¡æ“¬æ¸¬è©¦é‚è¼¯
                const isValid = mockResponse.ok && 
                               mockResponse.headers.get('content-type') && 
                               mockResponse.status === 200;

                if (!isValid) {
                    throw new Error('å¿«å–å®Œæ•´æ€§é©—è­‰å¤±æ•—');
                }

                logResult('Cache Integrity', true, 'å¿«å–å®Œæ•´æ€§é©—è­‰åŠŸèƒ½æ­£å¸¸');
                displayResult('cache-integrity-result', true, 
                    'âœ… å¿«å–å®Œæ•´æ€§é©—è­‰é‚è¼¯æ­£ç¢º', 
                    { status: mockResponse.status, contentType: mockResponse.headers.get('content-type') }
                );
            } catch (error) {
                logResult('Cache Integrity', false, error.message);
                displayResult('cache-integrity-result', false, `âŒ ${error.message}`);
            }
        }

        async function testSWSecurityHeaders() {
            try {
                // æª¢æŸ¥ Service Worker æ˜¯å¦å·²è¨»å†Š
                if (!('serviceWorker' in navigator)) {
                    throw new Error('ç€è¦½å™¨ä¸æ”¯æ´ Service Worker');
                }

                const registration = await navigator.serviceWorker.getRegistration();
                
                if (!registration) {
                    displayResult('sw-security-headers-result', false, 
                        'âš ï¸ Service Worker æœªè¨»å†Šï¼Œç„¡æ³•æ¸¬è©¦å®‰å…¨æ¨™é ­æ³¨å…¥åŠŸèƒ½'
                    );
                    return;
                }

                // æ¨¡æ“¬æ¸¬è©¦ Service Worker å®‰å…¨æ¨™é ­åŠŸèƒ½
                logResult('SW Security Headers', true, 'Service Worker å®‰å…¨æ¨™é ­åŠŸèƒ½å¯ç”¨');
                displayResult('sw-security-headers-result', true, 
                    'âœ… Service Worker å·²è¨»å†Šï¼Œå®‰å…¨æ¨™é ­æ³¨å…¥åŠŸèƒ½å¯ç”¨', 
                    { scope: registration.scope, state: registration.active?.state }
                );
            } catch (error) {
                logResult('SW Security Headers', false, error.message);
                displayResult('sw-security-headers-result', false, `âŒ ${error.message}`);
            }
        }

        async function testContentTypeValidation() {
            try {
                // æ¸¬è©¦å…è¨±çš„å…§å®¹é¡å‹
                const allowedTypes = [
                    'text/html',
                    'text/css',
                    'application/javascript',
                    'application/json',
                    'image/png'
                ];

                const blockedTypes = [
                    'application/x-executable',
                    'text/vbscript',
                    'application/x-msdownload'
                ];

                // æ¨¡æ“¬å…§å®¹é¡å‹é©—è­‰é‚è¼¯
                const isAllowedContentType = (contentType) => {
                    return allowedTypes.some(type => contentType.startsWith(type));
                };

                const allowedResults = allowedTypes.map(type => isAllowedContentType(type));
                const blockedResults = blockedTypes.map(type => !isAllowedContentType(type));

                const allAllowedPassed = allowedResults.every(result => result);
                const allBlockedPassed = blockedResults.every(result => result);

                if (!allAllowedPassed || !allBlockedPassed) {
                    throw new Error('å…§å®¹é¡å‹é©—è­‰é‚è¼¯ä¸æ­£ç¢º');
                }

                logResult('Content Type Validation', true, 'å…§å®¹é¡å‹é©—è­‰åŠŸèƒ½æ­£å¸¸');
                displayResult('content-type-result', true, 
                    'âœ… å…§å®¹é¡å‹é©—è­‰é‚è¼¯æ­£ç¢ºï¼Œèƒ½æ­£ç¢ºå…è¨±/é˜»æ­¢ä¸åŒé¡å‹', 
                    { allowedTypes: allowedTypes.length, blockedTypes: blockedTypes.length }
                );
            } catch (error) {
                logResult('Content Type Validation', false, error.message);
                displayResult('content-type-result', false, `âŒ ${error.message}`);
            }
        }

        // PWA-15: File Import Security Tests
        async function testFileValidation() {
            try {
                if (!window.SecureFileValidator) {
                    throw new Error('SecureFileValidator æ¨¡çµ„æœªè¼‰å…¥');
                }

                const fileInput = document.getElementById('test-file');
                const file = fileInput.files[0];

                if (!file) {
                    // å‰µå»ºæ¨¡æ“¬æª”æ¡ˆé€²è¡Œæ¸¬è©¦
                    const mockFile = new File(['{"test": "data"}'], 'test.json', {
                        type: 'application/json'
                    });
                    
                    const validation = await window.SecureFileValidator.validateFileSecurely(mockFile);
                    
                    if (!validation.isValid) {
                        throw new Error(`æ¨¡æ“¬æª”æ¡ˆé©—è­‰å¤±æ•—: ${validation.reason}`);
                    }

                    logResult('File Validation', true, 'æª”æ¡ˆé©—è­‰åŠŸèƒ½æ­£å¸¸ï¼ˆä½¿ç”¨æ¨¡æ“¬æª”æ¡ˆï¼‰');
                    displayResult('file-validation-result', true, 
                        'âœ… æª”æ¡ˆé©—è­‰åŠŸèƒ½æ­£å¸¸ï¼ˆæ¨¡æ“¬æª”æ¡ˆæ¸¬è©¦é€šéï¼‰', 
                        { fileName: mockFile.name, fileSize: mockFile.size, fileType: mockFile.type }
                    );
                } else {
                    const validation = await window.SecureFileValidator.validateFileSecurely(file);
                    
                    if (!validation.isValid) {
                        throw new Error(`æª”æ¡ˆé©—è­‰å¤±æ•—: ${validation.reason}`);
                    }

                    logResult('File Validation', true, 'å¯¦éš›æª”æ¡ˆé©—è­‰æˆåŠŸ');
                    displayResult('file-validation-result', true, 
                        'âœ… å¯¦éš›æª”æ¡ˆé©—è­‰æˆåŠŸ', 
                        { fileName: file.name, fileSize: file.size, fileType: file.type }
                    );
                }
            } catch (error) {
                logResult('File Validation', false, error.message);
                displayResult('file-validation-result', false, `âŒ ${error.message}`);
            }
        }

        async function testMaliciousContentDetection() {
            try {
                if (!window.SecureFileValidator) {
                    throw new Error('SecureFileValidator æ¨¡çµ„æœªè¼‰å…¥');
                }

                const maliciousContents = [
                    '<script>alert("xss")</script>',
                    'javascript:alert("xss")',
                    '<iframe src="evil.com"></iframe>',
                    'eval("malicious code")',
                    'on click="alert(1)"'
                ];

                const safeContents = [
                    '{"name": "John Doe", "email": "john@example.com"}',
                    'BEGIN:VCARD\nFN:John Doe\nEND:VCARD',
                    'This is safe text content'
                ];

                const validator = window.SecureFileValidator;
                
                // æ¸¬è©¦æƒ¡æ„å…§å®¹æª¢æ¸¬
                const maliciousResults = maliciousContents.map(content => 
                    validator.containsMaliciousContent(content)
                );

                const safeResults = safeContents.map(content => 
                    !validator.containsMaliciousContent(content)
                );

                const allMaliciousDetected = maliciousResults.every(result => result);
                const allSafeAllowed = safeResults.every(result => result);

                if (!allMaliciousDetected) {
                    throw new Error('éƒ¨åˆ†æƒ¡æ„å…§å®¹æœªè¢«æª¢æ¸¬åˆ°');
                }

                if (!allSafeAllowed) {
                    throw new Error('éƒ¨åˆ†å®‰å…¨å…§å®¹è¢«èª¤åˆ¤ç‚ºæƒ¡æ„');
                }

                logResult('Malicious Content Detection', true, 'æƒ¡æ„å…§å®¹æª¢æ¸¬åŠŸèƒ½æ­£å¸¸');
                displayResult('malicious-content-result', true, 
                    'âœ… æƒ¡æ„å…§å®¹æª¢æ¸¬åŠŸèƒ½æ­£å¸¸ï¼Œèƒ½æ­£ç¢ºè­˜åˆ¥æƒ¡æ„å’Œå®‰å…¨å…§å®¹', 
                    { 
                        maliciousDetected: maliciousResults.filter(r => r).length,
                        safeAllowed: safeResults.filter(r => r).length
                    }
                );
            } catch (error) {
                logResult('Malicious Content Detection', false, error.message);
                displayResult('malicious-content-result', false, `âŒ ${error.message}`);
            }
        }

        async function testSecureJSONParsing() {
            try {
                if (!window.SecureFileValidator) {
                    throw new Error('SecureFileValidator æ¨¡çµ„æœªè¼‰å…¥');
                }

                const validator = window.SecureFileValidator;

                // æ¸¬è©¦æ­£å¸¸ JSON
                const validJSON = '{"name": "John", "email": "john@example.com"}';
                const parsedValid = await validator.parseJSONFileSecurely(validJSON);
                
                if (!parsedValid || !parsedValid.name) {
                    throw new Error('æ­£å¸¸ JSON è§£æå¤±æ•—');
                }

                // æ¸¬è©¦æƒ¡æ„ JSONï¼ˆåŸå‹æ±¡æŸ“ï¼‰
                const maliciousJSON = '{"__proto__": {"isAdmin": true}, "name": "test"}';
                try {
                    const parsedMalicious = await validator.parseJSONFileSecurely(maliciousJSON);
                    // æª¢æŸ¥æ˜¯å¦æˆåŠŸé˜»æ­¢åŸå‹æ±¡æŸ“
                    if (({}).isAdmin === true) {
                        throw new Error('åŸå‹æ±¡æŸ“é˜²è­·å¤±æ•—');
                    }
                } catch (e) {
                    // é æœŸæœƒæ‹‹å‡ºéŒ¯èª¤æˆ–æˆåŠŸé˜»æ­¢æ±¡æŸ“
                }

                // æ¸¬è©¦éå¤§çš„ JSON
                const largeJSON = '{"data": "' + 'x'.repeat(2 * 1024 * 1024) + '"}';
                try {
                    await validator.parseJSONFileSecurely(largeJSON);
                    throw new Error('å¤§æª”æ¡ˆé™åˆ¶æœªç”Ÿæ•ˆ');
                } catch (e) {
                    if (!e.message.includes('éå¤§')) {
                        throw new Error('å¤§æª”æ¡ˆéŒ¯èª¤è¨Šæ¯ä¸æ­£ç¢º');
                    }
                }

                logResult('Secure JSON Parsing', true, 'å®‰å…¨ JSON è§£æåŠŸèƒ½æ­£å¸¸');
                displayResult('secure-json-result', true, 
                    'âœ… å®‰å…¨ JSON è§£æåŠŸèƒ½æ­£å¸¸ï¼Œèƒ½é˜²è­·åŸå‹æ±¡æŸ“å’Œå¤§æª”æ¡ˆæ”»æ“Š', 
                    { validParsed: !!parsedValid.name }
                );
            } catch (error) {
                logResult('Secure JSON Parsing', false, error.message);
                displayResult('secure-json-result', false, `âŒ ${error.message}`);
            }
        }

        // Main test runner
        async function runAllTests() {
            testResults = { total: 0, passed: 0, failed: 0, warnings: 0, details: [] };
            
            const tests = [
                testCSPGeneration,
                testNonceGeneration,
                testCSPViolationMonitoring,
                testSecurityHeaders,
                testPermissionsPolicy,
                testCORSHeaders,
                testCacheIntegrity,
                testSWSecurityHeaders,
                testContentTypeValidation,
                testFileValidation,
                testMaliciousContentDetection,
                testSecureJSONParsing
            ];

            for (let i = 0; i < tests.length; i++) {
                updateProgress(i, tests.length);
                await tests[i]();
                await new Promise(resolve => setTimeout(resolve, 100)); // å°å»¶é²
            }

            updateProgress(tests.length, tests.length);
            showTestSummary();
        }

        function showTestSummary() {
            const summary = document.getElementById('test-summary');
            const content = document.getElementById('summary-content');
            
            const successRate = Math.round((testResults.passed / testResults.total) * 100);
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="text-align: center;">
                        <h4>ç¸½æ¸¬è©¦æ•¸</h4>
                        <div style="font-size: 2em; color: #3498db;">${testResults.total}</div>
                    </div>
                    <div style="text-align: center;">
                        <h4>é€šéæ¸¬è©¦</h4>
                        <div style="font-size: 2em; color: #2ecc71;">${testResults.passed}</div>
                    </div>
                    <div style="text-align: center;">
                        <h4>å¤±æ•—æ¸¬è©¦</h4>
                        <div style="font-size: 2em; color: #e74c3c;">${testResults.failed}</div>
                    </div>
                    <div style="text-align: center;">
                        <h4>æˆåŠŸç‡</h4>
                        <div style="font-size: 2em; color: ${successRate >= 80 ? '#2ecc71' : '#e74c3c'};">${successRate}%</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <h4>Phase 4 å¯¦ä½œç‹€æ…‹:</h4>
                    <ul>
                        <li>âœ… PWA-12: åš´æ ¼å…§å®¹å®‰å…¨æ”¿ç­– - ${testResults.details.filter(d => d.test.includes('CSP') || d.test.includes('Nonce')).every(d => d.success) ? 'å®Œæˆ' : 'éœ€è¦ä¿®å¾©'}</li>
                        <li>âœ… PWA-13: PWA å®‰å…¨æ¨™é ­ - ${testResults.details.filter(d => d.test.includes('Security Headers') || d.test.includes('Permissions') || d.test.includes('CORS')).every(d => d.success) ? 'å®Œæˆ' : 'éœ€è¦ä¿®å¾©'}</li>
                        <li>âœ… PWA-14: Service Worker å®‰å…¨ - ${testResults.details.filter(d => d.test.includes('Cache') || d.test.includes('SW') || d.test.includes('Content Type')).every(d => d.success) ? 'å®Œæˆ' : 'éœ€è¦ä¿®å¾©'}</li>
                        <li>âœ… PWA-15: å®‰å…¨æª”æ¡ˆåŒ¯å…¥ - ${testResults.details.filter(d => d.test.includes('File') || d.test.includes('Malicious') || d.test.includes('JSON')).every(d => d.success) ? 'å®Œæˆ' : 'éœ€è¦ä¿®å¾©'}</li>
                    </ul>
                </div>
            `;
            
            summary.style.display = 'block';
        }

        function clearResults() {
            const resultElements = document.querySelectorAll('[id$="-result"]');
            resultElements.forEach(element => {
                element.innerHTML = '';
            });
            
            document.getElementById('test-summary').style.display = 'none';
            document.getElementById('overall-progress').style.width = '0%';
            document.getElementById('progress-text').textContent = 'æº–å‚™é–‹å§‹æ¸¬è©¦...';
            
            testResults = { total: 0, passed: 0, failed: 0, warnings: 0, details: [] };
        }

        function exportResults() {
            const exportData = {
                timestamp: new Date().toISOString(),
                phase: 'Phase 4 - PWA Security Headers & CSP',
                summary: {
                    total: testResults.total,
                    passed: testResults.passed,
                    failed: testResults.failed,
                    successRate: Math.round((testResults.passed / testResults.total) * 100)
                },
                details: testResults.details,
                environment: {
                    userAgent: navigator.userAgent,
                    url: window.location.href
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `phase4-pwa-security-test-results-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Phase 4 PWA Security Test Suite å·²è¼‰å…¥');
            
            // æª¢æŸ¥å¿…è¦æ¨¡çµ„
            const requiredModules = [
                'PWASecurityHeaders',
                'SecureFileValidator',
                'SecurityInputHandler',
                'SecurityDataHandler'
            ];
            
            const missingModules = requiredModules.filter(module => !window[module]);
            
            if (missingModules.length > 0) {
                console.warn('ç¼ºå°‘å¿…è¦æ¨¡çµ„:', missingModules);
                document.getElementById('progress-text').textContent = 
                    `âš ï¸ ç¼ºå°‘æ¨¡çµ„: ${missingModules.join(', ')}`;
            } else {
                document.getElementById('progress-text').textContent = 'âœ… æ‰€æœ‰æ¨¡çµ„å·²è¼‰å…¥ï¼Œæº–å‚™é–‹å§‹æ¸¬è©¦';
            }
        });
    </script>
</body>
</html>