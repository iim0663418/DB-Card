<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數位名片 | 管理後台</title>
    <link rel="icon" type="image/png" sizes="192x192" href="favicon.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="stylesheet" href="/css/v4-design.css">
    <script src="/js/tailwind-suppress.js"></script>
    <!-- Vite Icon Bundle (Tree-shaken: 11.62 KB, 96.9% reduction) -->
    <script type="module" src="/dist/icons.-k7gZ0Em.js"></script>
    <script src="/vendor/panzoom.min.js"
            integrity="sha384-u8bfQFCgKdKTTif7iRiNzaUcfforzK6TX9dtMm6yqWCfFRmzlg3cz2npEiioASrH"
            crossorigin="anonymous"
            defer></script>
    <script src="/vendor/simplewebauthn.min.js"
            integrity="sha384-LXX7Wq4Ygc47p1Tw1tlv1G83JPgHQzVzu3WDtaZpekmpq5DTOz3JwqHAa65L/wAE"
            crossorigin="anonymous"
            defer></script>
    <script src="/vendor/qr-creator.min.js"
            integrity="sha384-cmmVU8dn+rGH6Yvlt0Q1+31iG9lS4wdVsqV/ZP/53RBddef+VZcYakA+NhG4S8wE"
            crossorigin="anonymous"
            defer></script>
    <script src="/vendor/purify.min.js"
            integrity="sha384-qJNkHwhlYywDHfyoEe1np+1lYvX/8x+3gHCKFhSSBMQyCFlvFnn+zXmaebXl21rV"
            crossorigin="anonymous"
            defer></script>
    <script src="/vendor/chart.min.js"
            integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ"
            crossorigin="anonymous"
            defer></script>
    <script type="module" src="/js/config.js"></script>
    <script src="/js/social-link-validation.js"></script>
    <script src="/js/social-link-integration.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+TC:wght@300;500;700;900&display=swap');
        
        :root {
            --moda-accent: #6868ac;
            --moda-success: #10b981;
            --moda-warning: #f59e0b;
            --moda-danger: #ef4444;
            --crystal-bg: rgba(255, 255, 255, 0.8);
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }

        #three-canvas {
            position: fixed;
            top: 0; left: 0; z-index: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            opacity: 0.2;
        }

        .glass-surface {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px rgba(104, 104, 172, 0.12), 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* Tab 系統樣式 */
        .tab-btn {
            position: relative;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 700;
            color: #64748b;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            color: var(--moda-accent);
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px; left: 0; right: 0;
            height: 3px;
            background: var(--moda-accent);
        }
        .tab-btn.logout-btn {
            color: #dc2626 !important; /* text-red-600 */
        }
        .tab-btn.logout-btn:hover {
            color: #b91c1c !important; /* text-red-700 */
        }

        /* 雙語輸入框 */
        .bilingual-field {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 1px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        @media (max-width: 640px) {
            .bilingual-field {
                grid-template-columns: 1fr;
                gap: 1px;
            }
        }
        .bilingual-field input, .bilingual-field textarea {
            background: #fff;
            padding: 12px 16px;
            font-size: 14px;
            border: none;
            outline: none;
        }
        .bilingual-field input:focus, .bilingual-field textarea:focus {
            background: #fdfdff;
            box-shadow: inset 0 0 0 2px var(--moda-accent);
            z-index: 10;
        }

        .lang-indicator {
            font-size: 9px;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .social-chip-prev {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            color: var(--moda-accent);
            border: 1px solid #e2e8f0;
        }

        /* Badge 樣式 */
        .badge {
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }
        .badge-personal { background: #dbeafe; color: #1e40af; }
        .badge-event { background: #fef3c7; color: #92400e; }
        .badge-sensitive { background: #fee2e2; color: #991b1b; }
        .badge-bound { background: #d1fae5; color: #065f46; }
        .badge-revoked { background: #fecaca; color: #991b1b; }
        .badge-active { background: #d1fae5; color: #065f46; }
        .badge-suspended { background: #fed7aa; color: #9a3412; }

        /* Budget Badge */
        .badge-budget-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .badge-budget-critical {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-text {
            height: 12px;
            margin: 4px 0;
        }
        .skeleton-badge {
            width: 60px;
            height: 20px;
            display: inline-block;
        }

        /* 動畫 */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* 按鈕 Loading 狀態 */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }
        @keyframes btn-spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }

        /* MODA Accent 顏色覆蓋 Tailwind indigo */
        .bg-moda { background-color: var(--moda-accent) !important; }
        .text-moda { color: var(--moda-accent) !important; }
        .text-moda-dark { color: #4a4a8a !important; }
        .border-moda { border-color: var(--moda-accent) !important; }
        .border-moda-light { border-color: rgba(104, 104, 172, 0.1) !important; }
        .bg-moda-light { background-color: rgba(104, 104, 172, 0.1) !important; }
        .hover\:bg-moda:hover { background-color: #5858a0 !important; }
        .hover\:text-moda:hover { color: var(--moda-accent) !important; }
        .hover\:border-moda:hover { border-color: var(--moda-accent) !important; }
        .focus\:border-moda:focus { border-color: var(--moda-accent) !important; }
        .focus\:ring-moda:focus { --tw-ring-color: var(--moda-accent) !important; }
        .shadow-moda { box-shadow: 0 20px 25px -5px rgba(104, 104, 172, 0.1), 0 8px 10px -6px rgba(104, 104, 172, 0.1) !important; }
    </style>
</head>
<body class="p-4 lg:p-8">

    <canvas id="three-canvas"></canvas>

    <!-- 全屏 Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center gap-4 max-w-md mx-4">
            <div class="w-16 h-16 border-4 border-slate-200 border-t-moda rounded-full animate-spin"></div>
            <div class="text-center">
                <p id="loading-message" class="text-lg font-bold text-slate-900 mb-2">正在載入...</p>
                <p id="loading-submessage" class="text-sm text-slate-500">請稍候</p>
            </div>
            <!-- 錯誤狀態 (初始隱藏) -->
            <div id="loading-error" class="hidden w-full text-center">
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-600 mx-auto mb-2"></i>
                    <p id="loading-error-message" class="text-sm font-bold text-red-700 mb-1">載入失敗</p>
                    <p class="text-xs text-red-600">無法載入名片列表，請重試</p>
                </div>
                <button data-action="retryLoadCards" class="w-full bg-slate-900 text-white px-6 py-3 rounded-xl text-sm font-bold hover:bg-black transition-all">
                    重試
                </button>
            </div>
        </div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto space-y-6">
        
        <!-- 頂部導航與驗證 -->
        <header class="glass-surface p-6 rounded-2xl flex flex-col lg:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-moda text-white rounded-2xl flex items-center justify-center shadow-lg">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tight">Admin Dashboard</h1>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Ministry of Digital Affairs</p>
                </div>
            </div>

            <!-- Setup Token 驗證區 (Don't Make Me Think: 驗證後隱藏或縮小) -->
            <div id="token-section" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                <!-- SETUP_TOKEN 登入 -->
                <div id="token-login" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 bg-white/50 px-3 py-2 rounded-xl border border-white/50">
                    <input type="email" id="admin-email" placeholder="Email" class="w-full sm:w-28 bg-transparent outline-none text-xs placeholder:text-slate-400">
                    <div class="hidden sm:block w-px h-4 bg-slate-300"></div>
                    <input type="password" id="setup-token" placeholder="Token" class="w-full sm:w-28 bg-transparent outline-none text-xs placeholder:text-slate-400">
                    <button id="verify-btn" class="bg-slate-900 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-black transition-all whitespace-nowrap">驗證</button>
                </div>

                <!-- Passkey 登入 -->
                <div id="passkey-login" class="hidden">
                    <button data-action="loginWithPasskey" class="w-full flex items-center justify-center gap-2 bg-white/50 px-3 py-2 rounded-xl border border-white/50 hover:bg-white/70 transition-all">
                        <i data-lucide="fingerprint" class="w-4 h-4 text-slate-700"></i>
                        <span class="text-xs font-bold text-slate-700">Passkey</span>
                    </button>
                </div>
            </div>

            <!-- 已授權狀態 -->
            <div id="auth-status" class="hidden flex items-center justify-center gap-2 bg-white/50 px-3 py-2 rounded-xl border border-white/50">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-bold text-green-700">已授權</span>
            </div>
        </header>

        <!-- Tab 控制切換區 -->
        <nav id="admin-nav" class="hidden glass-surface rounded-2xl px-2 flex border-b border-slate-100 overflow-x-auto no-scrollbar">
            <button data-action="switchTab" data-tab="list" id="tab-list" class="tab-btn active flex items-center gap-2">
                <i data-lucide="list" class="w-4 h-4"></i> 名片列表
            </button>
            <button data-action="switchTab" data-tab="create" id="tab-create" class="tab-btn flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-4 h-4"></i> 創建名片
            </button>
            <button data-action="switchTab" data-tab="twin" id="tab-twin" class="tab-btn flex items-center gap-2">
                <i data-lucide="image" class="w-4 h-4"></i> 實體孿生
            </button>
            <button data-action="switchTab" data-tab="security" id="tab-security" class="tab-btn flex items-center gap-2">
                <i data-lucide="shield-alert" class="w-4 h-4"></i> 安全監控
            </button>
            <button data-action="switchTab" data-tab="tools" id="tab-tools" class="tab-btn flex items-center gap-2">
                <i data-lucide="settings" class="w-4 h-4"></i> 系統工具
            </button>
            <button id="register-passkey-btn" data-action="registerPasskey" class="hidden tab-btn flex items-center gap-2 text-slate-600 hover:text-slate-900">
                <i data-lucide="fingerprint" class="w-4 h-4"></i> 註冊 Passkey
            </button>
            <button data-action="handleLogout" class="tab-btn logout-btn flex items-center gap-2 ml-auto">
                <i data-lucide="log-out" class="w-4 h-4"></i> 登出
            </button>
        </nav>

        <!-- 主要內容容器 -->
        <div id="content-area" class="hidden">
            
            <!-- Tab 1: 名片列表 -->
            <section id="section-list" class="space-y-6 fade-in">
                <div class="glass-surface p-6 rounded-2xl flex flex-wrap gap-4 items-center justify-between">
                    <div class="relative flex-1 min-w-[300px]">
                        <i data-lucide="search" class="absolute left-4 top-3.5 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="search-input" placeholder="搜尋姓名、Email..." class="w-full pl-12 pr-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm">
                    </div>
                    <div class="flex gap-2">
                        <select id="filter-type" class="px-4 py-3 bg-white/50 border border-slate-200 rounded-xl text-xs font-bold outline-none">
                            <option value="">所有類型</option>
                            <option value="personal">個人</option>
                            <option value="event_booth">活動</option>
                            <option value="sensitive">敏感</option>
                        </select>
                        <button data-action="loadCards" class="p-3 bg-white border border-slate-200 rounded-xl hover:bg-slate-50"><i data-lucide="refresh-cw" class="w-4 h-4 text-slate-600"></i></button>
                    </div>
                </div>

                <div id="cards-grid" class="grid grid-cols-1 gap-4">
                    <!-- 卡片列表由 JS 注入 -->
                    <div class="text-center py-20 bg-white/40 rounded-2xl border border-dashed border-slate-200">
                        <i data-lucide="inbox" class="w-12 h-12 text-slate-300 mx-auto mb-4"></i>
                        <p class="text-slate-400 font-medium">尚無名片資料</p>
                    </div>
                </div>

                <!-- 分頁區 -->
                <div class="flex items-center justify-center gap-6 py-4">
                    <button class="p-2 rounded-lg hover:bg-white transition-colors disabled:opacity-30"><i data-lucide="chevron-left"></i></button>
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Page 1 of 1</span>
                    <button class="p-2 rounded-lg hover:bg-white transition-colors disabled:opacity-30"><i data-lucide="chevron-right"></i></button>
                </div>
            </section>

            <!-- Tab 2: 創建名片 (完全對齊 nfc-generator) -->
            <section id="section-create" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8 fade-in">
                <div class="lg:col-span-7 glass-surface p-8 rounded-2xl space-y-8">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400 flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> 基本身分資訊 (雙語必填)
                    </h2>
                    <form id="card-form" class="space-y-6">
                        <!-- 基本資訊區 -->
                        <div>
                            <div class="lang-indicator"><span>中文姓名 / CHINESE</span><span>英文姓名 / ENGLISH</span></div>
                            <div class="bilingual-field">
                                <input type="text" id="name_zh" placeholder="如：王小明" required>
                                <input type="text" id="name_en" placeholder="e.g. John Smith" required>
                            </div>
                        </div>

                        <div>
                            <div class="lang-indicator"><span>中文職稱 / POSITION</span><span>英文職稱 / TITLE</span></div>
                            <div class="bilingual-field">
                                <input type="text" id="title_zh" placeholder="如：部長">
                                <input type="text" id="title_en" placeholder="e.g. Minister">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">公務 Email</label>
                                <input type="email" id="email" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="example@moda.gov.tw">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">所屬部門</label>
                                <select id="department-preset" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm appearance-none">
                                    <option value="">請選擇部門</option>
                                    <option value="數位策略司">數位策略司</option>
                                    <option value="數位政府司">數位政府司</option>
                                    <option value="資源管理司">資源管理司</option>
                                    <option value="韌性建設司">韌性建設司</option>
                                    <option value="數位國際司">數位國際司</option>
                                    <option value="資料創新司">資料創新司</option>
                                    <option value="秘書處">秘書處</option>
                                    <option value="人事處">人事處</option>
                                    <option value="政風處">政風處</option>
                                    <option value="主計處">主計處</option>
                                    <option value="資訊處">資訊處</option>
                                    <option value="法制處">法制處</option>
                                    <option value="部長室">部長室</option>
                                    <option value="政務次長室">政務次長室</option>
                                    <option value="常務次長室">常務次長室</option>
                                    <option value="主任秘書室">主任秘書室</option>
                                    <option value="custom">自訂部門</option>
                                </select>

                                <div id="custom-department-field" class="hidden space-y-2">
                                    <input type="text" id="department-custom-zh" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="請輸入部門名稱（中文）">
                                    <input type="text" id="department-custom-en" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="Department Name (English)">
                                </div>
                            </div>
                        </div>

                        <!-- 聯絡資訊區 -->
                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">
                                公務電話 Office Phone
                            </label>
                            <input type="text" id="phone"
                                   class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm"
                                   placeholder="(02) 2700-0000 #1234">
                        </div>

                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">
                                官方網站 Official Website
                            </label>
                            <input type="url" id="web"
                                   class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm"
                                   placeholder="https://moda.gov.tw">
                        </div>

                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">
                                地址 Address
                            </label>

                            <select id="address-preset" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm mb-2">
                                <option value="">-- 選擇預設地址或自訂 --</option>
                                <option value="yanping">延平大樓（數位發展部）</option>
                                <option value="shinkong">新光大樓（數位發展部）</option>
                                <option value="custom">自訂地址</option>
                            </select>

                            <div id="custom-address-fields" class="hidden space-y-2">
                                <input type="text" id="address_zh"
                                       class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm"
                                       placeholder="中文地址（例：10058 台北市中正區延平南路143號）">
                                <input type="text" id="address_en"
                                       class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm"
                                       placeholder="English Address (e.g., No. 143, Yanping S. Rd., Taipei 10058)">
                            </div>
                        </div>

                        <!-- 進階資訊（折疊） -->
                        <details class="group border-t border-slate-100 pt-4">
                            <summary class="list-none cursor-pointer flex items-center justify-between text-xs font-bold text-moda hover:text-moda transition-colors">
                                <span>+ 進階與社群資訊 (手機、頭像、關於我、社群)</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180 transition-transform"></i>
                            </summary>
                            <div class="pt-6 space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">手機號碼</label>
                                        <input type="text" id="mobile" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="0912-345-678">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">大頭貼 URL</label>
                                        <input type="url" id="avatar_url" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="https://...">
                                    </div>
                                </div>
                                <div>
                                    <div class="lang-indicator"><span>關於我（中文，每行一句）</span><span>ABOUT ME (ENGLISH)</span></div>
                                    <div class="bilingual-field">
                                        <textarea id="greetings_zh" class="h-24" placeholder="Hello, 數位連結未來"></textarea>
                                        <textarea id="greetings_en" class="h-24" placeholder="Nice to meet you!"></textarea>
                                    </div>
                                </div>
                                
                                <!-- 社群連結 - 獨立輸入框 -->
                                <div class="space-y-3">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">社群連結 (Social Links)</label>
                                    
                                    <div class="grid grid-cols-1 gap-3">
                                        <!-- GitHub -->
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <i data-lucide="github" class="w-4 h-4 text-slate-600"></i>
                                            </div>
                                            <input type="url" id="social_github" class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs" placeholder="https://github.com/username">
                                        </div>
                                        
                                        <!-- LinkedIn -->
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <i data-lucide="linkedin" class="w-4 h-4 text-slate-600"></i>
                                            </div>
                                            <input type="url" id="social_linkedin" class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs" placeholder="https://linkedin.com/in/username">
                                        </div>
                                        
                                        <!-- Facebook -->
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <i data-lucide="facebook" class="w-4 h-4 text-slate-600"></i>
                                            </div>
                                            <input type="url" id="social_facebook" class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs" placeholder="https://facebook.com/username">
                                        </div>
                                        
                                        <!-- Instagram -->
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <i data-lucide="instagram" class="w-4 h-4 text-slate-600"></i>
                                            </div>
                                            <input type="url" id="social_instagram" class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs" placeholder="https://instagram.com/username">
                                        </div>
                                        
                                        <!-- X/Twitter -->
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <i data-lucide="twitter" class="w-4 h-4 text-slate-600"></i>
                                            </div>
                                            <input type="url" id="social_twitter" class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs" placeholder="https://x.com/username">
                                        </div>
                                        
                                        <!-- YouTube -->
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <i data-lucide="youtube" class="w-4 h-4 text-slate-600"></i>
                                            </div>
                                            <input type="url" id="social_youtube" class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs" placeholder="https://youtube.com/@channel">
                                        </div>

                                        <!-- LINE -->
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <svg class="w-4 h-4 text-slate-600" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                                                </svg>
                                            </div>
                                            <input type="text" id="social_line" class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs" placeholder="LINE ID 或 https://line.me/ti/p/~username">
                                        </div>

                                        <!-- Signal -->
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <svg class="w-4 h-4 text-slate-600" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M12 0q-.934 0-1.83.139l.17 1.111a11 11 0 0 1 3.32 0l.172-1.111A12 12 0 0 0 12 0M9.152.34A12 12 0 0 0 5.77 1.742l.584.961a10.8 10.8 0 0 1 3.066-1.27zm5.696 0-.268 1.094a10.8 10.8 0 0 1 3.066 1.27l.584-.962A12 12 0 0 0 14.848.34M12 2.25a9.75 9.75 0 0 0-8.539 14.459c.074.134.1.292.064.441l-1.013 4.338 4.338-1.013a.62.62 0 0 1 .441.064A9.7 9.7 0 0 0 12 21.75c5.385 0 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25m-7.092.068a12 12 0 0 0-2.59 2.59l.909.664a11 11 0 0 1 2.345-2.345zm14.184 0-.664.909a11 11 0 0 1 2.345 2.345l.909-.664a12 12 0 0 0-2.59-2.59M1.742 5.77A12 12 0 0 0 .34 9.152l1.094.268a10.8 10.8 0 0 1 1.269-3.066zm20.516 0-.961.584a10.8 10.8 0 0 1 1.27 3.066l1.093-.268a12 12 0 0 0-1.402-3.383M.138 10.168A12 12 0 0 0 0 12q0 .934.139 1.83l1.111-.17A11 11 0 0 1 1.125 12q0-.848.125-1.66zm23.723.002-1.111.17q.125.812.125 1.66c0 .848-.042 1.12-.125 1.66l1.111.172a12.1 12.1 0 0 0 0-3.662M1.434 14.58l-1.094.268a12 12 0 0 0 .96 2.591l-.265 1.14 1.096.255.36-1.539-.188-.365a10.8 10.8 0 0 1-.87-2.35m21.133 0a10.8 10.8 0 0 1-1.27 3.067l.962.584a12 12 0 0 0 1.402-3.383zm-1.793 3.848a11 11 0 0 1-2.345 2.345l.664.909a12 12 0 0 0 2.59-2.59zm-19.959 1.1L.357 21.48a1.8 1.8 0 0 0 2.162 2.161l1.954-.455-.256-1.095-1.953.455a.675.675 0 0 1-.81-.81l.454-1.954zm16.832 1.769a10.8 10.8 0 0 1-3.066 1.27l.268 1.093a12 12 0 0 0 3.382-1.402zm-10.94.213-1.54.36.256 1.095 1.139-.266c.814.415 1.683.74 2.591.961l.268-1.094a10.8 10.8 0 0 1-2.35-.869zm3.634 1.24-.172 1.111a12.1 12.1 0 0 0 3.662 0l-.17-1.111q-.812.125-1.66.125a11 11 0 0 1-1.66-.125"/>
                                                </svg>
                                            </div>
                                            <input type="text" id="social_signal" class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs" placeholder="+886912345678 或 https://signal.me/#p/+886...">
                                        </div>
                                    </div>

                                    <p class="text-[9px] text-slate-400 italic">直接貼上完整連結，留空表示不顯示該平台</p>
                                </div>
                            </div>
                        </details>

                        <!-- 名片設定 -->
                        <div class="pt-6 space-y-4">
                            <select id="card_type" class="w-full px-4 py-3 bg-slate-100 border-none rounded-xl text-sm font-bold">
                                <option value="personal">標準個人名片 (20 次讀取)</option>
                                <option value="event">活動專用名片 (50 次讀取)</option>
                                <option value="sensitive">敏感資料保護 (5 次讀取)</option>
                            </select>
                            <div class="flex flex-col md:flex-row gap-4">
                                <button id="cancel-edit-btn" type="button" data-action="cancelEdit" class="hidden md:flex-1 bg-slate-100 text-slate-600 px-8 py-4 rounded-xl font-bold hover:bg-slate-200 transition-all flex items-center justify-center gap-3">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                    取消編輯
                                </button>
                                <button type="submit" class="md:flex-1 bg-moda text-white px-8 py-4 rounded-xl font-bold hover:bg-moda shadow-lg transition-all flex items-center justify-center gap-3">
                                    <i data-lucide="zap" class="w-5 h-5"></i>
                                    簽發數位名片
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- 預覽區 -->
                <div class="lg:col-span-5 space-y-6">
                    <div class="glass-surface p-6 rounded-2xl sticky top-8">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-[10px] font-black tracking-widest text-slate-400">REAL-TIME CONTEXT</span>
                            <div id="preview-lang-switch" class="flex bg-slate-100 p-1 rounded-lg">
                                <button data-lang="zh" class="px-4 py-1 text-[10px] font-bold rounded-md bg-white shadow-sm transition-all">中</button>
                                <button data-lang="en" class="px-4 py-1 text-[10px] font-bold rounded-md text-slate-500 hover:text-slate-900 transition-all">EN</button>
                            </div>
                        </div>

                        <div class="transform scale-85 origin-top">
                            <div id="preview-card" class="bg-white rounded-[2.5rem] shadow-2xl border-t-[6px] border-moda overflow-hidden text-center p-8 space-y-6">
                                <div class="relative inline-block">
                                    <img id="prev-avatar" src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=400&q=80" class="w-28 h-28 rounded-[2rem] object-cover shadow-lg border-2 border-slate-50">
                                </div>
                                <div>
                                    <h3 id="prev-name" class="text-3xl font-black text-slate-900 italic">王小明</h3>
                                    <p id="prev-title" class="text-moda font-bold text-[10px] uppercase tracking-[0.2em] mt-2">部長</p>
                                    <p id="prev-department" class="text-sm text-slate-500 mt-1 flex items-center gap-1 justify-center" style="display:none;">
                                        <i data-lucide="briefcase" class="w-3 h-3 flex-shrink-0"></i>
                                        <span id="prev-department-text" class="truncate max-w-[200px]">---</span>
                                    </p>
                                </div>

                                <!-- 社群圖標預覽區 -->
                                <div id="prev-social-cluster" class="flex justify-center gap-2 flex-wrap min-h-[32px]">
                                    <!-- 動態生成 -->
                                </div>

                                <div id="prev-greeting-section" class="mt-8 pt-8 border-t border-moda-light hidden">
                                    <p class="hud-text mb-4 opacity-40 text-[8px] font-black tracking-widest text-slate-400 uppercase">關於我 About Me</p>
                                    <p id="prev-greeting" class="text-slate-600 font-medium italic min-h-[1.5em] text-[10px]"></p>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-2xl flex items-center gap-4 text-left mt-2">
                                    <i data-lucide="mail" class="w-4 h-4 text-moda opacity-60"></i>
                                    <span id="prev-email" class="text-[10px] font-bold text-slate-600 truncate">---</span>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-2xl flex items-center gap-4 text-left mt-2">
                                    <i data-lucide="phone" class="w-4 h-4 text-moda opacity-60"></i>
                                    <span id="prev-phone" class="text-[10px] font-bold text-slate-600 truncate">---</span>
                                </div>
                                <div id="prev-web-container" class="bg-slate-50 p-4 rounded-2xl flex items-center gap-4 text-left mt-2" style="display:none;">
                                    <i data-lucide="globe" class="w-4 h-4 text-moda opacity-60"></i>
                                    <span id="prev-web" class="text-[10px] font-bold text-slate-600 truncate">---</span>
                                </div>
                                <div id="prev-mobile-container" class="bg-slate-50 p-4 rounded-2xl flex items-center gap-4 text-left mt-2" style="display:none;">
                                    <i data-lucide="smartphone" class="w-4 h-4 text-moda opacity-60"></i>
                                    <span id="prev-mobile" class="text-[10px] font-bold text-slate-600 truncate">---</span>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-2xl flex items-center gap-4 text-left mt-2">
                                    <i data-lucide="map-pin" class="w-4 h-4 text-moda opacity-60"></i>
                                    <span id="prev-address" class="text-[10px] font-bold text-slate-600 truncate">---</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tab 2.5: 實體孿生 -->
            <section id="section-twin" class="hidden space-y-6 fade-in">
                <div class="glass-surface p-8 rounded-2xl space-y-6">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400 flex items-center gap-2">
                        <i data-lucide="image" class="w-4 h-4"></i> 上傳實體名片圖片
                    </h2>

                    <!-- 選擇名片 -->
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">選擇名片</label>
                        <select id="twin-card-select" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:border-moda text-sm">
                            <option value="">請選擇名片...</option>
                        </select>
                    </div>

                    <!-- 圖片類型 -->
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">圖片類型</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="asset-type" value="twin_front" checked class="w-4 h-4 text-moda">
                                <span class="text-sm">正面 (twin_front)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="asset-type" value="twin_back" class="w-4 h-4 text-moda">
                                <span class="text-sm">背面 (twin_back)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="asset-type" value="avatar" class="w-4 h-4 text-moda">
                                <span class="text-sm">大頭貼 (avatar)</span>
                            </label>
                        </div>
                    </div>

                    <!-- 拖放上傳區 -->
                    <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-2xl p-12 text-center cursor-pointer hover:border-moda hover:bg-moda-light transition-all">
                        <input type="file" id="file-input" accept="image/jpeg,image/png,image/webp" class="hidden">
                        <i data-lucide="upload-cloud" class="w-12 h-12 text-slate-400 mx-auto mb-4"></i>
                        <p class="text-slate-700 font-bold mb-2">拖放圖片到此處</p>
                        <p class="text-sm text-slate-500 mb-1">或點擊選擇檔案</p>
                        <p class="text-xs text-slate-400">支援格式: JPEG, PNG, WebP | 最大大小: 5 MB</p>
                    </div>

                    <!-- 圖片預覽 -->
                    <div id="preview-container" class="hidden space-y-4">
                        <div class="flex items-start gap-4 bg-slate-50 p-4 rounded-xl">
                            <img id="preview-image" class="w-32 h-32 object-cover rounded-lg border border-slate-200">
                            <div class="flex-1">
                                <p id="preview-filename" class="font-bold text-slate-900 mb-1"></p>
                                <p id="preview-filesize" class="text-sm text-slate-600 mb-1"></p>
                                <p id="preview-dimensions" class="text-sm text-slate-600"></p>
                            </div>
                            <button data-action="clearPreview" class="text-slate-400 hover:text-red-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 上傳按鈕 -->
                    <div class="flex gap-3">
                        <button id="upload-btn" data-action="uploadAsset" disabled class="flex-1 bg-moda text-white px-6 py-3 rounded-xl font-bold hover:bg-moda transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            上傳
                        </button>
                        <button data-action="clearPreview" class="px-6 py-3 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-all">
                            取消
                        </button>
                    </div>

                    <!-- 上傳進度 -->
                    <div id="upload-progress" class="hidden">
                        <div class="bg-slate-200 rounded-full h-2 overflow-hidden">
                            <div id="progress-bar" class="bg-moda h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2 text-center">上傳中...</p>
                    </div>
                </div>

                <!-- 已上傳的圖片列表 -->
                <div class="glass-surface p-8 rounded-2xl space-y-4">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-slate-400">已上傳的圖片</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 text-[10px] font-bold uppercase tracking-wider text-slate-500">
                                <tr>
                                    <th class="px-4 py-3 text-left">縮圖</th>
                                    <th class="px-4 py-3 text-left">類型</th>
                                    <th class="px-4 py-3 text-left">版本</th>
                                    <th class="px-4 py-3 text-left">上傳時間</th>
                                    <th class="px-4 py-3 text-left">操作</th>
                                </tr>
                            </thead>
                            <tbody id="assets-table-body" class="divide-y divide-slate-100">
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-slate-400">請選擇名片以查看已上傳的圖片</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Tab 3: 安全監控 -->
            <section id="section-security" class="hidden space-y-6 fade-in">

                <!-- 系統監控 -->
                <div class="space-y-4">
                    <h2 class="text-lg font-bold text-slate-900">系統監控</h2>
                    
                    <!-- Health Status -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="glass-surface p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Database</p>
                                <span id="health-db-status" class="text-xs font-bold text-green-600">●</span>
                            </div>
                            <p id="health-db-latency" class="text-2xl font-black text-slate-900">-- ms</p>
                        </div>
                        <div class="glass-surface p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">R2 Storage</p>
                                <span id="health-r2-status" class="text-xs font-bold text-green-600">●</span>
                            </div>
                            <p id="health-r2-latency" class="text-2xl font-black text-slate-900">-- ms</p>
                        </div>
                        <div class="glass-surface p-6 rounded-2xl">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">KV Cache</p>
                                <span id="health-kv-status" class="text-xs font-bold text-green-600">●</span>
                            </div>
                            <p id="health-kv-latency" class="text-2xl font-black text-slate-900">-- ms</p>
                        </div>
                    </div>

                    <!-- Upload & Read Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-surface p-6 rounded-2xl">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Upload (24h)</p>
                            <div class="flex items-baseline gap-2">
                                <p id="upload-total" class="text-3xl font-black text-slate-900">--</p>
                                <p class="text-sm text-slate-500">total</p>
                            </div>
                            <div class="mt-2 flex gap-4 text-xs">
                                <span class="text-green-600">✓ <span id="upload-success">--</span></span>
                                <span class="text-red-600">✗ <span id="upload-failed">--</span></span>
                                <span class="text-slate-500">(<span id="upload-rate">--%</span>)</span>
                            </div>
                        </div>
                        <div class="glass-surface p-6 rounded-2xl">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Read (24h)</p>
                            <div class="flex items-baseline gap-2">
                                <p id="read-total" class="text-3xl font-black text-slate-900">--</p>
                                <p class="text-sm text-slate-500">total</p>
                            </div>
                            <div class="mt-2 flex gap-4 text-xs">
                                <span class="text-green-600">✓ <span id="read-success">--</span></span>
                                <span class="text-red-600">✗ <span id="read-failed">--</span></span>
                                <span class="text-slate-500">(<span id="read-rate">--%</span>)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Core Web Vitals (2024) -->
                    <div class="glass-surface p-6 rounded-2xl">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-4">Core Web Vitals (2024)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-500 mb-1">LCP (Largest Contentful Paint)</span>
                                <span id="vitals-lcp" class="text-2xl font-black">--</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-500 mb-1">INP (Interaction to Next Paint)</span>
                                <span id="vitals-inp" class="text-2xl font-black">--</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-500 mb-1">CLS (Cumulative Layout Shift)</span>
                                <span id="vitals-cls" class="text-2xl font-black">--</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-200">
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-500 mb-1">FCP (First Contentful Paint)</span>
                                <span id="vitals-fcp" class="text-2xl font-black">--</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-500 mb-1">CardContentReady (自訂)</span>
                                <span id="vitals-card_content_ready" class="text-2xl font-black">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-slate-200">

                <!-- 統計卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="glass-surface p-6 rounded-2xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Total Events</p>
                        <p id="stat-total" class="text-3xl font-black text-slate-900">---</p>
                    </div>
                    <div class="glass-surface p-6 rounded-2xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Blocked Attempts</p>
                        <p id="stat-blocked" class="text-3xl font-black text-red-600">---</p>
                    </div>
                    <div class="glass-surface p-6 rounded-2xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Suspicious IPs</p>
                        <p id="stat-suspicious" class="text-3xl font-black text-amber-600">---</p>
                    </div>
                    <div class="glass-surface p-6 rounded-2xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Rate Limit Hits</p>
                        <p id="stat-ratelimit" class="text-3xl font-black text-moda">---</p>
                    </div>
                </div>

                <!-- Top IPs & 時間軸圖表 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="glass-surface p-6 rounded-2xl">
                        <h3 class="text-sm font-bold uppercase tracking-widest text-slate-400 mb-4">Top 5 IPs</h3>
                        <div id="top-ips-list" class="space-y-2">
                            <p class="text-xs text-slate-400">Loading...</p>
                        </div>
                    </div>
                    <div class="lg:col-span-2 glass-surface p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold uppercase tracking-widest text-slate-400">Timeline</h3>
                            <select id="timeline-range" class="px-3 py-1 bg-slate-100 border-none rounded-lg text-xs font-bold">
                                <option value="24">24h</option>
                                <option value="48">48h</option>
                                <option value="168">7d</option>
                            </select>
                        </div>
                        <canvas id="timeline-chart" class="w-full" style="max-height: 200px;"></canvas>
                    </div>
                </div>

                <!-- IP 封鎖表單 -->
                <div class="glass-surface p-6 rounded-2xl">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-slate-400 mb-4">Block IP Address</h3>
                    <form id="block-ip-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="block-ip" placeholder="192.168.1.1" class="px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm" required>
                        <select id="block-duration" class="px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm">
                            <option value="3600">1 Hour</option>
                            <option value="86400">24 Hours</option>
                            <option value="604800">7 Days</option>
                            <option value="0">Permanent</option>
                        </select>
                        <input type="text" id="block-reason" placeholder="Reason (optional)" class="px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm">
                        <button type="submit" class="bg-red-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-700 transition-all">Block IP</button>
                    </form>
                </div>

                <!-- 事件列表 -->
                <div class="glass-surface p-6 rounded-2xl">
                    <div class="flex flex-wrap gap-4 items-center justify-between mb-6">
                        <h3 class="text-sm font-bold uppercase tracking-widest text-slate-400">Security Events</h3>
                        <div class="flex gap-2">
                            <select id="event-type-filter" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold">
                                <option value="">All Types</option>
                                <option value="rate_limit">Rate Limit</option>
                                <option value="suspicious_activity">Suspicious</option>
                                <option value="blocked_ip">Blocked IP</option>
                            </select>
                            <button data-action="exportSecurityEvents" class="px-4 py-2 bg-moda text-white rounded-xl text-xs font-bold hover:bg-moda">Export CSV</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 text-[10px] font-bold uppercase tracking-wider text-slate-500">
                                <tr>
                                    <th class="px-4 py-3 text-left">ID</th>
                                    <th class="px-4 py-3 text-left">Type</th>
                                    <th class="px-4 py-3 text-left">IP Address</th>
                                    <th class="px-4 py-3 text-left">Endpoint</th>
                                    <th class="px-4 py-3 text-left">User Agent</th>
                                    <th class="px-4 py-3 text-left">Time</th>
                                </tr>
                            </thead>
                            <tbody id="events-table-body" class="divide-y divide-slate-100">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-slate-400">Loading events...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex items-center justify-between mt-6 pt-6 border-t border-slate-100">
                        <button id="events-prev-btn" data-action="loadSecurityEvents" data-page="-1" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 disabled:opacity-30" disabled>Previous</button>
                        <span id="events-page-info" class="text-xs font-bold text-slate-500">Page 1</span>
                        <button id="events-next-btn" data-action="loadSecurityEvents" data-page="+1" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200 disabled:opacity-30" disabled>Next</button>
                    </div>
                </div>

            </section>

            <!-- Tab 3: 系統工具 -->
            <section id="section-tools" class="hidden space-y-6 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- KEK 密鑰監控 -->
                    <div class="glass-surface p-8 rounded-2xl space-y-4">
                        <h2 class="text-lg font-black text-slate-900 flex items-center gap-3">
                            <i data-lucide="shield-check" class="text-moda"></i> KEK 密鑰監控
                        </h2>
                        <div id="kek-monitor" class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100">
                                <div class="flex items-center gap-2">
                                    <span id="kek-status-badge" class="px-2 py-1 text-xs font-bold rounded-lg bg-green-100 text-green-700">正常</span>
                                    <span id="kek-status-text" class="text-sm text-slate-600">已使用 -- 天 / 建議 90 天</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <div class="p-3 bg-slate-50 rounded-xl">
                                    <p class="text-slate-400 mb-1">當前版本</p>
                                    <p id="kek-version" class="font-bold text-slate-900">v--</p>
                                </div>
                                <div class="p-3 bg-slate-50 rounded-xl">
                                    <p class="text-slate-400 mb-1">啟用時間</p>
                                    <p id="kek-activated-at" class="font-bold text-slate-900">--</p>
                                </div>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-xl">
                                <p class="text-xs text-blue-700">
                                    <i data-lucide="info" class="w-3 h-3 inline"></i>
                                    距離建議輪替：<span id="kek-days-until" class="font-bold">-- 天</span>
                                </p>
                            </div>
                        </div>
                        <button data-action="showRotationGuide" class="w-full py-4 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-all">查看輪替指引</button>
                    </div>

                    <!-- System Health Status -->
                    <div class="glass-surface p-8 rounded-2xl">
                        <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400 mb-6">System Health Status</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-white rounded-2xl border border-slate-100">
                                <p class="text-[10px] text-slate-400 mb-1">API Node</p>
                                <p id="health-api" class="font-bold text-green-600">Operational</p>
                            </div>
                            <div class="p-4 bg-white rounded-2xl border border-slate-100">
                                <p class="text-[10px] text-slate-400 mb-1">Database</p>
                                <p id="health-database" class="font-bold text-green-600">Connected</p>
                            </div>
                            <div class="p-4 bg-white rounded-2xl border border-slate-100">
                                <p class="text-[10px] text-slate-400 mb-1">KEK Version</p>
                                <p id="health-kek-version" class="font-bold text-moda">Loading...</p>
                            </div>
                            <div class="p-4 bg-white rounded-2xl border border-slate-100">
                                <p class="text-[10px] text-slate-400 mb-1">Active Cards</p>
                                <p id="health-active-cards" class="font-bold text-slate-900">Loading...</p>
                                <p class="text-[8px] text-slate-400 mt-1">Bound + Revoked</p>
                            </div>
                        </div>
                    </div>

                    <!-- Resource Health Status -->
                    <div class="glass-surface p-8 rounded-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400">Resource Health Status</h2>
                            <button data-action="checkCDNHealth" class="text-xs text-moda hover:underline flex items-center gap-1">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                <span>Refresh</span>
                            </button>
                        </div>
                        <div id="cdn-health-container" class="space-y-3">
                            <p class="text-sm text-slate-400">Loading...</p>
                        </div>
                    </div>
                </div>
            </section>

        </div>

    </div>

    <!-- 確認操作 Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-6">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8">
            <div class="text-center mb-6">
                <div id="modal-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                </div>
                <h3 id="modal-title" class="text-2xl font-black text-slate-900">確定執行此操作？</h3>
                <p id="modal-desc" class="text-sm text-slate-600 mt-2">此操作具有高度破壞性，且無法輕易復原。</p>
            </div>
            <div class="flex gap-3">
                <button data-action="closeModal" class="flex-1 px-6 py-4 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-colors">
                    取消
                </button>
                <button id="modal-confirm-btn" class="flex-1 px-6 py-4 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors">
                    確認執行
                </button>
            </div>
        </div>
    </div>

    <!-- KEK 輪替指引 Modal -->
    <div id="rotation-guide-modal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-6">
        <div class="bg-white max-w-2xl w-full p-8 rounded-2xl space-y-6 max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-black text-slate-900 flex items-center gap-3">
                    <i data-lucide="shield-alert" class="text-red-500 animate-pulse"></i>
                    KEK 輪替標準作業程序 (SOP)
                </h2>
                <button data-action="closeRotationGuide" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                <div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="text-red-500 flex-shrink-0"></i>
                    <div>
                        <p class="text-sm font-bold text-red-700">警告：KEK 輪替需要系統管理員權限</p>
                        <p class="text-xs text-red-600 mt-1">此操作需要存取環境變數與 Cloudflare Workers 部署權限</p>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="p-5 bg-white rounded-lg border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-[#6868ac] text-white rounded-full flex items-center justify-center font-bold">1</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-900 mb-2">生成新 KEK</h3>
                            <div class="relative group">
                                <pre class="bg-slate-900 text-green-400 p-4 rounded-lg text-xs overflow-x-auto whitespace-nowrap"><code>
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
</code></pre>
                                <button data-action="copyToClipboard" data-text="node -e &quot;console.log(require('crypto').randomBytes(32).toString('base64'))&quot;" class="absolute top-2 right-2 p-2 bg-slate-800 hover:bg-slate-700 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 bg-white rounded-lg border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-[#6868ac] text-white rounded-full flex items-center justify-center font-bold">2</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-900 mb-2">更新環境變數</h3>
                            <p class="text-sm text-slate-600 mb-3">將當前 KEK 移至 OLD_KEK，新 KEK 設為 KEK</p>
                            <div class="relative group">
                                <pre class="bg-slate-900 text-green-400 p-4 rounded-lg text-xs overflow-x-auto whitespace-nowrap"><code>
wrangler secret put KEK
wrangler secret put OLD_KEK
</code></pre>
                                <button data-action="copyToClipboard" data-text="wrangler secret put KEK&#10;wrangler secret put OLD_KEK" class="absolute top-2 right-2 p-2 bg-slate-800 hover:bg-slate-700 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 bg-white rounded-lg border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-[#6868ac] text-white rounded-full flex items-center justify-center font-bold">3</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-900 mb-2">重新部署</h3>
                            <div class="relative group">
                                <pre class="bg-slate-900 text-green-400 p-4 rounded-lg text-xs overflow-x-auto whitespace-nowrap"><code>
wrangler deploy
</code></pre>
                                <button data-action="copyToClipboard" data-text="wrangler deploy" class="absolute top-2 right-2 p-2 bg-slate-800 hover:bg-slate-700 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 bg-white rounded-lg border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-[#6868ac] text-white rounded-full flex items-center justify-center font-bold">4</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-900 mb-2">執行 DEK 重新包裝腳本</h3>
                            <p class="text-sm text-slate-600 mb-3">在本地執行腳本進行重新包裝</p>
                            <div class="relative group">
                                <pre class="bg-slate-900 text-green-400 p-4 rounded-lg text-xs overflow-x-auto whitespace-nowrap"><code>
cd workers
npm run kek:rewrap
</code></pre>
                                <button data-action="copyToClipboard" data-text="cd workers&#10;npm run kek:rewrap" class="absolute top-2 right-2 p-2 bg-slate-800 hover:bg-slate-700 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 bg-white rounded-lg border border-slate-200 hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-[#6868ac] text-white rounded-full flex items-center justify-center font-bold">5</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-900 mb-2">清理舊密鑰</h3>
                            <p class="text-sm text-slate-600 mb-3">確認輪替成功後刪除 OLD_KEK</p>
                            <div class="relative group">
                                <pre class="bg-slate-900 text-green-400 p-4 rounded-lg text-xs overflow-x-auto whitespace-nowrap"><code>
wrangler secret delete OLD_KEK
</code></pre>
                                <button data-action="copyToClipboard" data-text="wrangler secret delete OLD_KEK" class="absolute top-2 right-2 p-2 bg-slate-800 hover:bg-slate-700 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                <div class="flex items-start gap-3">
                    <i data-lucide="info" class="text-blue-600 flex-shrink-0"></i>
                    <div>
                        <p class="text-sm font-bold text-blue-700 mb-1">需要協助？</p>
                        <p class="text-xs text-blue-600">請聯絡系統管理員或參考運維文檔</p>
                    </div>
                </div>
            </div>

            <div class="flex gap-4">
                <button data-action="closeRotationGuide" class="flex-1 py-4 bg-slate-100 text-slate-700 rounded-2xl font-bold hover:bg-slate-200 transition-colors">關閉</button>
            </div>
        </div>
    </div>

    <!-- IP 詳情 Modal -->
    <div id="ip-detail-modal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-6">
        <div class="glass-surface max-w-2xl w-full p-8 rounded-2xl space-y-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black text-slate-900">IP Details</h2>
                <button data-action="closeIPDetailModal" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-2xl">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">IP Address</p>
                    <p id="ip-detail-address" class="font-black text-lg text-slate-900">---</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Status</p>
                        <p id="ip-detail-status" class="font-bold text-sm">---</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Total Events</p>
                        <p id="ip-detail-total" class="font-bold text-sm">---</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">First Seen</p>
                        <p id="ip-detail-first" class="font-bold text-xs text-slate-600">---</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Last Seen</p>
                        <p id="ip-detail-last" class="font-bold text-xs text-slate-600">---</p>
                    </div>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Event Type Distribution</p>
                    <canvas id="ip-detail-chart" style="max-height: 200px;"></canvas>
                </div>
                <div id="ip-detail-unblock-section" class="hidden">
                    <button data-action="handleUnblockIP" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700">Unblock IP</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="/js/admin-dashboard.js" defer></script>

</body>
</html>