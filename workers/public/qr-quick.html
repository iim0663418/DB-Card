<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>數位名片 QR Code</title>
<link id="dynamic-manifest" rel="manifest" href="">
<link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png">
<!-- Vite Icon Bundle (Tree-shaken: 11.62 KB, 96.9% reduction) -->
<script type="module" src="/dist/icons.-k7gZ0Em.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<style>
body{margin:0;padding:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(244,247,249,0.3) 0%,rgba(230,235,240,0.4) 100%);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
.modal{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center}
.backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px)}
.content{position:relative;background:#fff;border-radius:1.5rem;box-shadow:0 20px 40px rgba(0,0,0,0.1);max-width:28rem;width:100%;margin:1rem;padding:2rem}
.header{text-align:center;margin-bottom:1.5rem}
.icon{width:4rem;height:4rem;background:rgba(104,104,172,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem}
h3{font-size:1.5rem;font-weight:900;color:#1e293b;margin:0 0 0.5rem}
.subtitle{font-size:0.875rem;color:#64748b;margin:0}
.guide{padding:1rem;border-radius:0.75rem;margin-bottom:1rem}
.guide-title{font-size:0.875rem;font-weight:700;margin-bottom:0.5rem}
.guide-text{font-size:0.75rem;line-height:1.5}
.ios-guide{background:#dbeafe;border:1px solid #93c5fd;color:#1e3a8a}
.android-guide{background:#dcfce7;border:1px solid #86efac;color:#14532d}
.desktop-guide{background:#f1f5f9;border:1px solid #cbd5e1;color:#334155}
.chrome-guide{background:#fef3c7;border:1px solid #fde047;color:#713f12}
.btn{width:100%;padding:1rem;border:none;border-radius:0.75rem;font-weight:700;font-size:0.875rem;cursor:pointer;margin-top:0.5rem}
.btn-primary{background:#6868ac;color:#fff}
.btn-primary:hover{background:#5858a0}
.btn-secondary{background:#f1f5f9;color:#64748b}
.btn-secondary:hover{background:#e2e8f0}
.hidden{display:none!important}
.card{background:#fff;border-radius:1.5rem;padding:2rem;box-shadow:0 4px 20px rgba(0,0,0,.1);text-align:center}
canvas{max-width:100%;height:auto;border-radius:.5rem}
</style>
</head>
<body>
<div id="install-view" class="modal">
<div class="backdrop"></div>
<div class="content">
<div class="header">
<div class="icon"><i data-lucide="qr-code" style="width:2rem;height:2rem;color:#6868ac"></i></div>
<h3 data-i18n="install-title">加到主畫面</h3>
<p class="subtitle" data-i18n="install-subtitle">隨時打開，立即分享</p>
</div>

<div id="ios-guide" class="guide ios-guide hidden">
<p class="guide-title" data-i18n="ios-guide-title">iOS Safari 安裝步驟</p>
<p class="guide-text" data-i18n="ios-guide-text">點選 <svg style="display:inline;width:1rem;height:1rem;vertical-align:middle" fill="currentColor" viewBox="0 0 24 24"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg> → 加入主畫面 → 完成</p>
</div>

<div id="ios-chrome-guide" class="guide chrome-guide hidden">
<p class="guide-title" data-i18n="chrome-warning">⚠️ 需要使用 Safari</p>
<p class="guide-text" data-i18n="chrome-text">Chrome 不支援此功能，將自動切換到 Safari 瀏覽器</p>
<button class="btn btn-primary" onclick="openInSafari()" data-i18n="open-safari">在 Safari 中打開</button>
</div>

<div id="android-guide" class="guide android-guide hidden">
<div id="android-auto"><button class="btn btn-primary" onclick="triggerInstall()"><i data-lucide="qr-code" style="width:1.25rem;height:1.25rem;vertical-align:middle"></i> <span data-i18n="android-install">安裝（3 秒完成）</span></button>
<p style="font-size:0.75rem;color:#64748b;text-align:center;margin-top:0.5rem" data-i18n="android-confirm">點擊後會顯示瀏覽器確認對話框</p></div>
<div id="android-manual" class="hidden"><p class="guide-title" data-i18n="android-manual-title">Android 安裝步驟</p><p class="guide-text" data-i18n="android-manual-text">選單 (⋮) → 加到主畫面 → 完成</p></div>
</div>

<div id="desktop-guide" class="guide desktop-guide hidden">
<p class="guide-title" data-i18n="desktop-title">桌面版瀏覽器</p>
<p class="guide-text" data-i18n="desktop-text">請使用手機瀏覽器開啟此頁面，或複製連結傳送到手機。</p>
<button class="btn btn-primary" onclick="copyLink(event)" style="margin-top:0.75rem">
<i data-lucide="copy" style="width:1rem;height:1rem;display:inline-block;vertical-align:middle;margin-right:0.5rem"></i>
<span data-i18n="copy-link">複製連結</span>
</button>
</div>

<div id="success-message" class="guide android-guide hidden"><p class="guide-title" data-i18n="success-title">已加入主畫面</p><p class="guide-text" data-i18n="success-text">您現在可以從主畫面開啟 QR Code 了</p></div>

<button class="btn btn-secondary" onclick="backToPortal()" data-i18n="back-to-portal">返回名片列表</button>
</div>
</div>

<div id="qr-view" class="card hidden">
<div class="header">
<div class="icon"><i data-lucide="contact" style="width:2rem;height:2rem;color:#6868ac"></i></div>
<h3 id="qr-card-name">數位名片</h3>
<p class="subtitle" data-i18n="qr-subtitle">掃描 QR Code 查看名片</p>
</div>
<canvas id="qr"></canvas>
<p style="font-size:0.875rem;color:#64748b;margin-top:1.5rem;line-height:1.6" data-i18n="qr-instruction">
使用手機相機或任何 QR Code 掃描器<br>即可開啟此名片
</p>
</div>

<script>
// 自動語言偵測
const lang=(navigator.language||'zh-TW').toLowerCase().startsWith('zh')?'zh':'en';
const i18n={
'qr-subtitle':{'zh':'掃描 QR Code 查看名片','en':'Scan QR Code to view card'},
'qr-instruction':{'zh':'使用手機相機或任何 QR Code 掃描器<br>即可開啟此名片','en':'Use your phone camera or any QR Code scanner<br>to open this card'},
'install-title':{'zh':'加到主畫面','en':'Add to Home Screen'},
'install-subtitle':{'zh':'隨時打開，立即分享','en':'Quick access, instant sharing'},
'ios-guide-title':{'zh':'iOS Safari 安裝步驟','en':'iOS Safari Installation'},
'ios-guide-text':{'zh':'點選 <svg style="display:inline;width:1rem;height:1rem;vertical-align:middle" fill="currentColor" viewBox="0 0 24 24"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg> → 加入主畫面 → 完成','en':'Tap <svg style="display:inline;width:1rem;height:1rem;vertical-align:middle" fill="currentColor" viewBox="0 0 24 24"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg> → Add to Home Screen → Done'},
'chrome-warning':{'zh':'⚠️ 需要使用 Safari','en':'⚠️ Safari Required'},
'chrome-text':{'zh':'Chrome 不支援此功能，將自動切換到 Safari 瀏覽器','en':'Chrome does not support this feature. Will switch to Safari'},
'open-safari':{'zh':'在 Safari 中打開','en':'Open in Safari'},
'android-install':{'zh':'安裝（3 秒完成）','en':'Install (3 seconds)'},
'android-confirm':{'zh':'點擊後會顯示瀏覽器確認對話框','en':'Browser confirmation dialog will appear'},
'android-manual-title':{'zh':'Android 安裝步驟','en':'Android Installation'},
'android-manual-text':{'zh':'選單 (⋮) → 加到主畫面 → 完成','en':'Menu (⋮) → Add to Home Screen → Done'},
'desktop-title':{'zh':'桌面版瀏覽器','en':'Desktop Browser'},
'desktop-text':{'zh':'請使用手機瀏覽器開啟此頁面，或複製連結傳送到手機。','en':'Please open this page on a mobile browser, or copy the link to your phone.'},
'copy-link':{'zh':'複製連結','en':'Copy Link'},
'success-title':{'zh':'已加入主畫面','en':'Added to Home Screen'},
'success-text':{'zh':'您現在可以從主畫面開啟 QR Code 了','en':'You can now open QR Code from home screen'},
'back-to-portal':{'zh':'返回名片列表','en':'Back to Card List'}
};
document.querySelectorAll('[data-i18n]').forEach(el=>{const key=el.getAttribute('data-i18n');if(i18n[key])el.innerHTML=i18n[key][lang]});

let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e});

const params=new URLSearchParams(window.location.search);
const uuid=params.get('uuid');
const name=params.get('name')||'數位名片';
const type=params.get('type')||'personal';

if(!uuid){document.body.innerHTML='<div class="card"><p>錯誤：缺少名片 ID</p></div>';throw new Error('Missing uuid');}

// Add type suffix for title
const typeSuffix = type === 'personal' ? '' : 
                   type === 'event' ? '（活動）' : 
                   type === 'sensitive' ? '（敏感）' : '';
const displayName = type === 'personal' ? `${name}的名片` : `${name}的名片${typeSuffix}`;

document.getElementById('dynamic-manifest').href=`/api/manifest/${uuid}?name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`;
document.title=displayName;

const ua=navigator.userAgent;
const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone===true;

if(isStandalone){
document.getElementById('install-view').classList.add('hidden');
document.getElementById('qr-view').classList.remove('hidden');
document.getElementById('qr-card-name').textContent=displayName;
const size=Math.min(window.innerWidth-80,320);
const shareUrl=`${window.location.origin}/card-display.html?uuid=${uuid}`;
new QRious({element:document.getElementById('qr'),value:shareUrl,size:size,level:'H'});
}else{
const isMobile=navigator.userAgentData?navigator.userAgentData.mobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua)||('ontouchstart' in window)||(navigator.maxTouchPoints>0);

if(!isMobile){
document.getElementById('desktop-guide').classList.remove('hidden');
}else{
const isIOS=/iPad|iPhone|iPod/i.test(ua);
const isIOSChrome=isIOS&&/CriOS/i.test(ua);
const isAndroid=/Android/i.test(ua);

if(isIOSChrome){
document.getElementById('ios-chrome-guide').classList.remove('hidden');
}else if(isIOS){
document.getElementById('ios-guide').classList.remove('hidden');
}else if(isAndroid){
document.getElementById('android-guide').classList.remove('hidden');
if(deferredPrompt){
document.getElementById('android-auto').classList.remove('hidden');
document.getElementById('android-manual').classList.add('hidden');
}else{
document.getElementById('android-auto').classList.add('hidden');
document.getElementById('android-manual').classList.remove('hidden');
}
}else{
document.getElementById('android-guide').classList.remove('hidden');
document.getElementById('android-auto').classList.add('hidden');
document.getElementById('android-manual').classList.remove('hidden');
}
}
}

function triggerInstall(){
if(!deferredPrompt){
document.getElementById('android-auto').classList.add('hidden');
document.getElementById('android-manual').classList.remove('hidden');
return;
}
deferredPrompt.prompt();
deferredPrompt.userChoice.then(result=>{
if(result.outcome==='accepted'){
document.getElementById('android-guide').classList.add('hidden');
document.getElementById('success-message').classList.remove('hidden');
}
deferredPrompt=null;
});
}

function openInSafari(){
const safariUrl=window.location.href.replace('https://','x-safari-https://');
window.location.href=safariUrl;
}

async function copyLink(event){
const url=window.location.href;
try{
await navigator.clipboard.writeText(url);
const btn=event.target.closest('button');
const originalHTML=btn.innerHTML;
btn.innerHTML='<i data-lucide="check" style="width:1rem;height:1rem;display:inline-block;vertical-align:middle;margin-right:0.5rem"></i>已複製';
window.initIcons();
setTimeout(()=>{
btn.innerHTML=originalHTML;
window.initIcons();
},2000);
}catch(err){
console.error('Copy failed:', err);
alert('複製失敗，請手動複製連結');
}
}

function backToPortal(){
window.location.href='/user-portal.html';
}

window.initIcons();
</script>
</body>
</html>
