<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數位名片 | 使用者入口</title>
    <link rel="icon" type="image/png" sizes="192x192" href="favicon.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&family=Noto+Sans+TC:wght@300;500;900&display=swap" rel="stylesheet">
    <script src="/js/tailwind-suppress.js"></script>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://unpkg.com/lucide@0.562.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"
            integrity="sha512-dLxUelApnYxpLt6K2iomGngnHO83iUvZytA3YjDUCjT0HDOHKXnVYdf3hU4JjM8uEhxf9nD1/ey98U3t2vZ0qQ=="
            crossorigin="anonymous"
            defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.7/purify.min.js"
            integrity="sha512-78KH17QLT5e55GJqP76vutp1D2iAoy06WcYBXB6iBCsmO6wWzx0Qdg8EDpm8mKXv68BcvHOyeeP4wxAL0twJGQ=="
            crossorigin="anonymous"
            defer></script>
    <script src="/js/config.js"></script>
    <script src="/js/social-link-validation.js"></script>
    <script src="/js/social-link-integration.js"></script>
    <style>

        :root {
            --moda-accent: #6868ac;
            --moda-glow: rgba(104, 104, 172, 0.2);
            --crystal-bg: rgba(255, 255, 255, 0.5);
            --ui-text: #1e1e3f;
        }

        body {
            font-family: 'Outfit', 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, rgba(244,247,249,0.3) 0%, rgba(230,235,240,0.4) 100%);
            color: var(--ui-text);
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }

        #three-canvas {
            position: fixed;
            top: 0; left: 0; z-index: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            opacity: 0.6;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px rgba(104, 104, 172, 0.12), 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* 雙語輸入框組合 */
        .bilingual-field {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #e2e8f0;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .bilingual-field input, .bilingual-field textarea {
            background: #fff;
            padding: 14px 18px;
            font-size: 14px;
            border: none;
            outline: none;
        }
        .bilingual-field input:focus, .bilingual-field textarea:focus {
            background: #fdfdff;
            z-index: 10;
            box-shadow: inset 0 0 0 2px var(--moda-accent);
        }

        /* 卡片選擇位樣式優化 */
        .selection-card {
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid rgba(104, 104, 172, 0.05);
        }
        .selection-card:hover:not(.disabled) {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px -10px rgba(104, 104, 172, 0.2);
            border-color: var(--moda-accent);
        }
        .selection-card.revoked {
            border: 2px solid #ef4444;
            background: rgba(254, 242, 242, 0.8);
        }

        .btn-google {
            background: white;
            border: 1px solid #dadce0;
            color: #3c4043;
            transition: all 0.2s;
        }
        .btn-google:hover:not(:disabled) {
            background-color: #f8f9fa;
            box-shadow: 0 1px 3px rgba(60,64,67,0.3);
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 200;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* MODA Accent 顏色覆蓋 Tailwind indigo */
        .bg-moda { background-color: var(--moda-accent) !important; }
        .text-moda { color: var(--moda-accent) !important; }
        .border-moda { border-color: var(--moda-accent) !important; }
        .hover\:bg-moda:hover { background-color: #5858a0 !important; }
        .hover\:text-moda:hover { color: var(--moda-accent) !important; }
        .hover\:border-moda:hover { border-color: var(--moda-accent) !important; }
        .focus\:border-moda:focus { border-color: var(--moda-accent) !important; }
        .shadow-moda { box-shadow: 0 20px 25px -5px rgba(104, 104, 172, 0.1), 0 8px 10px -6px rgba(104, 104, 172, 0.1) !important; }

        .social-chip-prev {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(104, 104, 172, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--moda-accent);
            transition: all 0.2s;
        }

        /* Modal 動畫 */
        #success-modal {
            animation: fadeIn 0.2s ease-out;
        }

        #success-modal .modal-content {
            animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* MODA hover/90 效果 */
        .bg-moda\/90 {
            background-color: rgba(104, 104, 172, 0.9);
        }

        .hover\:bg-moda\/90:hover {
            background-color: rgba(104, 104, 172, 0.9);
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 lg:p-8">

    <canvas id="three-canvas"></canvas>

    <!-- Loading 遮罩 -->
    <div id="global-loading" class="loading-overlay hidden">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-moda opacity-20 border-t-moda rounded-full animate-spin"></div>
            <p class="text-xs font-black text-moda uppercase tracking-widest">Processing Request</p>
        </div>
    </div>

    <!-- 頂部導航列 -->
    <header id="app-header" class="hidden fixed top-0 left-0 right-0 z-50 p-6 flex justify-between items-center pointer-events-none">
        <div class="flex items-center gap-3 bg-white/60 backdrop-blur-md px-5 py-2.5 rounded-2xl border border-white/50 pointer-events-auto shadow-sm">
            <div class="w-8 h-8 bg-moda text-white rounded-lg flex items-center justify-center">
                <i data-lucide="component" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-black tracking-tight uppercase">User Portal</span>
        </div>
        <div class="flex items-center gap-4 pointer-events-auto">
            <div class="hidden md:flex flex-col items-end">
                <span id="user-email-display" class="text-[10px] font-black text-slate-400 uppercase tracking-widest">---</span>
                <span class="text-[9px] font-bold text-green-600 uppercase">Secure Link</span>
            </div>
            <button onclick="handleLogout()" class="px-6 py-2.5 bg-white border border-slate-200 rounded-xl text-xs font-black text-slate-700 hover:text-red-600 transition-all uppercase tracking-widest shadow-sm">
                Logout
            </button>
        </div>
    </header>

    <!-- 主要視圖 -->
    <main id="view-container" class="relative z-10 w-full max-w-6xl mt-20 lg:mt-24">

        <!-- 1. OAuth 登入頁 -->
        <section id="view-login" class="flex flex-col items-center justify-center min-h-[70vh] space-y-10 fade-in">
            <div class="text-center space-y-4">
                <div class="w-20 h-20 bg-moda text-white rounded-[2rem] flex items-center justify-center shadow-2xl mx-auto mb-8">
                    <i data-lucide="user-circle" class="w-10 h-10"></i>
                </div>
                <h1 class="text-4xl font-black tracking-tighter">DB-Card 數位名片系統</h1>
                <p class="text-slate-400 font-medium">請使用內部 Google 帳號登入</p>
            </div>

            <div class="glass-panel p-6 sm:p-10 rounded-[2rem] sm:rounded-[3rem] w-full max-w-md space-y-6 sm:space-y-8 text-center">
                <div id="login-error-box" class="hidden p-4 bg-red-50 border border-red-100 rounded-2xl text-xs text-red-600 font-bold mb-4">
                    <!-- 錯誤訊息注入 -->
                </div>
                <button id="google-login-btn" onclick="handleGoogleLogin()" class="btn-google w-full flex items-center justify-center gap-4 py-4 rounded-2xl font-bold text-sm">
                    <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" class="w-5 h-5" alt="Google">
                    Login with Google
                </button>
                <div class="space-y-2">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Authorized Access Only</p>
                    <p class="text-[11px] text-slate-400">僅限 @moda.gov.tw 或 @nics.nat.gov.tw 網域使用者訪問</p>
                </div>
            </div>
        </section>

        <!-- 2. 卡片選擇頁 -->
        <section id="view-selection" class="hidden space-y-12 fade-in">
            <div class="flex flex-col items-center text-center space-y-2">
                <h2 class="text-3xl font-black tracking-tight">我的數位名片庫</h2>
                <p class="text-slate-400 font-medium text-sm">您最多可持有三種用途的數位名片</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8" id="card-slots-container">
                <!-- Slot Template (由 JS 渲染) -->
            </div>
        </section>

        <!-- 3. 卡片編輯表單 -->
        <section id="view-form" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-10 fade-in">
            <div class="lg:col-span-8 space-y-8">
                <div class="flex items-center gap-4 mb-2">
                    <button onclick="showView('selection')" class="p-3 bg-white border border-slate-200 rounded-2xl hover:bg-slate-50 transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <div>
                        <h2 id="form-title" class="text-2xl font-black tracking-tight">編輯數位名片</h2>
                        <p id="form-subtitle" class="text-xs text-slate-400 font-bold uppercase tracking-widest">Self-Service Issuance</p>
                    </div>
                </div>

                <form id="edit-form" class="glass-panel p-6 lg:p-10 rounded-[2rem] lg:rounded-[3rem] space-y-6 lg:space-y-8">
                    <!-- 隱藏欄位 -->
                    <input type="hidden" id="form-type" name="form-type">
                    <input type="hidden" id="form-uuid" name="form-uuid">

                    <!-- 姓名與職稱 -->
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">
                                <span>Chinese Name *</span><span>English Name *</span>
                            </div>
                            <div class="bilingual-field">
                                <input type="text" id="name_zh" name="name_zh" placeholder="如：王大明" required>
                                <input type="text" id="name_en" name="name_en" placeholder="e.g. John Smith" required>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">
                                <span>Position (ZH)</span><span>Title (EN)</span>
                            </div>
                            <div class="bilingual-field">
                                <input type="text" id="title_zh" name="title_zh" placeholder="如：科長">
                                <input type="text" id="title_en" name="title_en" placeholder="e.g. Section Chief">
                            </div>
                        </div>
                    </div>

                    <!-- 部門選擇下拉選單 -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">所屬部門</label>
                        <select id="department-preset" name="department" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold appearance-none">
                            <option value="">請選擇部門</option>
                            <option value="數位策略司">數位策略司</option>
                            <option value="數位政府司">數位政府司</option>
                            <option value="資源管理司">資源管理司</option>
                            <option value="韌性建設司">韌性建設司</option>
                            <option value="數位國際司">數位國際司</option>
                            <option value="資料創新司">資料創新司</option>
                            <option value="秘書處">秘書處</option>
                            <option value="人事處">人事處</option>
                            <option value="政風處">政風處</option>
                            <option value="主計處">主計處</option>
                            <option value="資訊處">資訊處</option>
                            <option value="法制處">法制處</option>
                            <option value="部長室">部長室</option>
                            <option value="政務次長室">政務次長室</option>
                            <option value="常務次長室">常務次長室</option>
                            <option value="主任秘書室">主任秘書室</option>
                            <option value="custom">自訂部門</option>
                        </select>

                        <div id="custom-department-field" class="hidden space-y-2">
                            <input type="text" id="department-custom-zh" name="department_custom_zh" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold" placeholder="請輸入部門名稱（中文）">
                            <input type="text" id="department-custom-en" name="department_custom_en" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold" placeholder="Department Name (English)">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Email *</label>
                            <input type="email" id="email" name="email" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Phone</label>
                            <input type="text" id="phone" name="phone" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold" placeholder="02-2380-XXXX">
                        </div>
                    </div>

                    <!-- 地址預設選擇 + 自訂 -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">地址 Address</label>
                        <select id="address-preset" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold appearance-none mb-2">
                            <option value="">-- 選擇預設地址或自訂 --</option>
                            <option value="yanping">延平大樓（數位發展部）</option>
                            <option value="shinkong">新光大樓（數位發展部）</option>
                            <option value="custom">自訂地址</option>
                        </select>

                        <div id="custom-address-fields" class="hidden space-y-2">
                            <input type="text" id="address_zh" name="address_zh" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold" placeholder="中文地址（例：10058 台北市中正區延平南路143號）">
                            <input type="text" id="address_en" name="address_en" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold" placeholder="English Address (e.g., No. 143, Yanping S. Rd., Taipei 10058)">
                        </div>
                    </div>

                    <!-- 進階資訊折疊區 -->
                    <details class="group border-t border-slate-100 pt-6 mt-6">
                        <summary class="list-none cursor-pointer flex items-center justify-between text-xs font-black text-moda hover:text-moda transition-colors uppercase tracking-widest">
                            <span>+ 進階與社群資訊</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="pt-6 space-y-6">
                            <!-- 手機 & 大頭貼 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">手機號碼</label>
                                    <input type="text" id="mobile" name="mobile" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold" placeholder="0912-345-678">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">大頭貼 URL</label>
                                    <input type="url" id="avatar_url" name="avatar_url" class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-moda font-bold" placeholder="https://drive.google.com/file/d/...">
                                    <p class="text-xs text-slate-500 ml-1">
                                        推薦使用 Google Drive：取得連結時設為「知道連結的任何人」，並點擊右上角齒輪設定下載權限
                                    </p>
                                </div>
                            </div>

                            <!-- 問候語 -->
                            <div class="space-y-2">
                                <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">
                                    <span>Greeting (ZH)</span><span>Greeting (EN)</span>
                                </div>
                                <div class="bilingual-field">
                                    <textarea id="greetings_zh" name="greetings_zh" class="h-24 resize-none" placeholder="您好，很高興認識您"></textarea>
                                    <textarea id="greetings_en" name="greetings_en" class="h-24 resize-none" placeholder="Hello, nice to meet you"></textarea>
                                </div>
                            </div>

                            <!-- 社群連結 -->
                            <div class="space-y-3">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">社群連結 Social Links</label>

                                <!-- GitHub -->
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="github" class="w-4 h-4 text-slate-600"></i>
                                    </div>
                                    <input type="url" id="social_github" name="social_github" class="flex-1 px-5 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="https://github.com/username">
                                </div>

                                <!-- LinkedIn -->
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="linkedin" class="w-4 h-4 text-slate-600"></i>
                                    </div>
                                    <input type="url" id="social_linkedin" name="social_linkedin" class="flex-1 px-5 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="https://linkedin.com/in/username">
                                </div>

                                <!-- Facebook -->
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="facebook" class="w-4 h-4 text-slate-600"></i>
                                    </div>
                                    <input type="url" id="social_facebook" name="social_facebook" class="flex-1 px-5 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="https://facebook.com/username">
                                </div>

                                <!-- Instagram -->
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="instagram" class="w-4 h-4 text-slate-600"></i>
                                    </div>
                                    <input type="url" id="social_instagram" name="social_instagram" class="flex-1 px-5 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="https://instagram.com/username">
                                </div>

                                <!-- X/Twitter -->
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="twitter" class="w-4 h-4 text-slate-600"></i>
                                    </div>
                                    <input type="url" id="social_twitter" name="social_twitter" class="flex-1 px-5 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="https://x.com/username">
                                </div>

                                <!-- YouTube -->
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="youtube" class="w-4 h-4 text-slate-600"></i>
                                    </div>
                                    <input type="url" id="social_youtube" name="social_youtube" class="flex-1 px-5 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="https://youtube.com/@channel">
                                </div>

                                <!-- LINE -->
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 text-slate-600" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                                        </svg>
                                    </div>
                                    <input type="text" id="social_line" name="social_line" class="flex-1 px-5 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="LINE ID 或 https://line.me/ti/p/~username">
                                </div>

                                <!-- Signal -->
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 text-slate-600" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 16.707s-1.067 1.341-1.24 1.514c-.173.173-.346.26-.519.26-.173 0-.346-.087-.519-.26l-3.616-3.616-3.616 3.616c-.173.173-.346.26-.519.26-.173 0-.346-.087-.519-.26-.173-.173-1.24-1.514-1.24-1.514-.173-.173-.26-.433-.26-.693 0-.26.087-.52.26-.693l3.616-3.616-3.616-3.616c-.173-.173-.26-.433-.26-.693 0-.26.087-.52.26-.693 0 0 1.067-1.341 1.24-1.514.173-.173.346-.26.519-.26.173 0 .346.087.519.26l3.616 3.616 3.616-3.616c.173-.173.346-.26.519-.26.173 0 .346.087.519.26.173.173 1.24 1.514 1.24 1.514.173.173.26.433.26.693 0 .26-.087.52-.26.693l-3.616 3.616 3.616 3.616c.173.173.26.433.26.693 0 .26-.087.52-.26.693z"/>
                                        </svg>
                                    </div>
                                    <input type="text" id="social_signal" name="social_signal" class="flex-1 px-5 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:border-moda text-sm" placeholder="Signal username 或 https://signal.me/#eu/...">
                                </div>

                                <p class="text-[9px] text-slate-400 italic">直接貼上完整連結，留空表示不顯示該平台</p>
                            </div>
                        </div>
                    </details>

                    <div id="form-error-msg" class="hidden p-4 bg-red-50 text-red-600 rounded-2xl text-xs font-bold"></div>

                    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 pt-6">
                        <button type="button" onclick="showView('selection')" class="sm:flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-slate-200">Cancel</button>
                        <button id="submit-btn" type="submit" class="sm:flex-[2] py-4 bg-moda text-white rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-moda shadow-xl shadow-moda transition-all">
                            <span id="submit-btn-text">Save Changes</span>
                            <span id="submit-btn-loading" class="hidden">
                                <i data-lucide="loader-2" class="w-4 h-4 inline animate-spin"></i> Saving...
                            </span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- 右側預覽 -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-panel p-6 lg:p-8 rounded-[3rem] lg:sticky lg:top-28 text-center flex flex-col items-center">
                    <p class="text-[10px] font-black text-moda opacity-60 uppercase tracking-[0.3em] mb-10">Real-time Context</p>
                    <div id="preview-lang-switch" class="flex bg-slate-100 p-1 rounded-lg mb-6">
                        <button data-lang="zh" class="px-4 py-1 text-[10px] font-bold rounded-md bg-white shadow-sm transition-all">中</button>
                        <button data-lang="en" class="px-4 py-1 text-[10px] font-bold rounded-md text-slate-500 hover:text-slate-900 transition-all">EN</button>
                    </div>
                    <div id="preview-card" class="w-full max-w-[240px] sm:max-w-[260px] bg-white rounded-[2rem] sm:rounded-[3rem] shadow-2xl border-t-[6px] sm:border-t-[8px] border-t-moda p-6 sm:p-8 space-y-4 sm:space-y-6">
                        <img id="prev-avatar" src="" class="w-24 h-24 rounded-[2rem] mx-auto object-cover border-2 border-slate-50 hidden">
                        <div>
                            <h3 id="prev-name" class="text-2xl font-black italic">---</h3>
                            <p id="prev-title" class="text-moda font-bold text-[10px] uppercase tracking-widest mt-2">---</p>
                            <p id="prev-department" class="text-sm text-slate-500 mt-1 flex items-center gap-1 justify-center" style="display:none;">
                                <i data-lucide="briefcase" class="w-3 h-3 flex-shrink-0"></i>
                                <span id="prev-department-text" class="truncate max-w-[200px]">---</span>
                            </p>
                        </div>

                        <!-- 社群圖標預覽 -->
                        <div id="prev-social-cluster" class="flex justify-center gap-2 flex-wrap min-h-[32px] mt-4">
                            <!-- 動態生成 -->
                        </div>

                        <!-- 問候語區塊 -->
                        <div id="prev-greeting-section" class="mt-6 pt-6 border-t border-moda opacity-20 hidden">
                            <p class="text-[8px] font-black tracking-widest text-slate-400 uppercase mb-3 opacity-40">Dynamic Transmission Feed</p>
                            <p id="prev-greeting" class="text-slate-600 font-medium italic text-[10px]"></p>
                        </div>

                        <!-- Email -->
                        <div class="bg-slate-50 p-3 rounded-xl flex items-center gap-3 text-left mt-2">
                            <i data-lucide="mail" class="w-4 h-4 text-moda opacity-60"></i>
                            <span id="prev-email" class="text-[10px] font-bold text-slate-600 truncate">---</span>
                        </div>

                        <!-- Phone -->
                        <div class="bg-slate-50 p-3 rounded-xl flex items-center gap-3 text-left mt-2">
                            <i data-lucide="phone" class="w-4 h-4 text-moda opacity-60"></i>
                            <span id="prev-phone" class="text-[10px] font-bold text-slate-600 truncate">---</span>
                        </div>

                        <!-- Address -->
                        <div class="bg-slate-50 p-3 rounded-xl flex items-center gap-3 text-left mt-2">
                            <i data-lucide="map-pin" class="w-4 h-4 text-moda opacity-60"></i>
                            <span id="prev-address" class="text-[10px] font-bold text-slate-600 truncate">---</span>
                        </div>
                    </div>
                    <p class="text-[9px] text-slate-400 mt-10 italic uppercase font-bold tracking-widest">Digital Twin Preview</p>
                </div>
            </div>
        </section>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[300] px-8 py-4 bg-slate-900 text-white rounded-2xl shadow-2xl text-xs font-bold uppercase tracking-widest hidden fade-in"></div>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center">
        <!-- Backdrop -->
        <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

        <!-- Modal Content -->
        <div class="modal-content relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8">
            <!-- Header -->
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="check-circle" class="w-8 h-8 text-green-600"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-900">名片創建成功！</h3>
                <p id="modal-card-type" class="text-sm text-slate-600 mt-2">您的個人名片已準備就緒</p>
            </div>

            <!-- Share Link -->
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">名片網址</label>
                <div class="flex gap-2">
                    <input id="modal-share-link" type="text" readonly class="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono text-slate-700">
                    <button id="modal-copy-btn" onclick="copyModalLink()" class="px-6 py-3 bg-moda text-white rounded-xl font-bold hover:bg-moda/90 transition-colors flex items-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                        <span id="modal-copy-text">複製</span>
                    </button>
                </div>
                <p class="text-xs text-slate-500 mt-2">此連結可分享給他人查看您的名片</p>
            </div>

            <!-- Next Steps -->
            <div class="mb-6 p-4 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl border border-purple-100">
                <h4 class="text-xs font-black text-slate-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <i data-lucide="lightbulb" class="w-4 h-4 text-moda"></i>
                    下一步操作建議
                </h4>
                <div class="grid grid-cols-2 gap-3">
                    <!-- NFC Card Writing -->
                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-xl border border-white/50 hover:border-moda/30 transition-all cursor-default group">
                        <div class="flex flex-col items-center text-center gap-2">
                            <div class="w-10 h-10 bg-moda/10 rounded-lg flex items-center justify-center group-hover:bg-moda/20 transition-colors">
                                <i data-lucide="credit-card" class="w-5 h-5 text-moda"></i>
                            </div>
                            <div>
                                <p class="text-xs font-black text-slate-700">寫入 NFC 卡片</p>
                                <p class="text-[9px] text-slate-500 mt-1">實體卡片快速分享</p>
                            </div>
                        </div>
                    </div>
                    <!-- URL Shortening -->
                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-xl border border-white/50 hover:border-moda/30 transition-all cursor-default group">
                        <div class="flex flex-col items-center text-center gap-2">
                            <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center group-hover:bg-green-100 transition-colors">
                                <i data-lucide="link-2" class="w-5 h-5 text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-xs font-black text-slate-700">縮短網址</p>
                                <p class="text-[9px] text-slate-500 mt-1">方便線上分享</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-3">
                <button id="modal-view-btn" onclick="viewModalCard()" class="flex-1 px-6 py-4 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-colors">
                    查看名片效果
                </button>
                <button onclick="closeSuccessModal()" class="flex-1 px-6 py-4 bg-moda text-white rounded-xl font-bold hover:bg-moda/90 transition-colors">
                    完成
                </button>
            </div>
        </div>
    </div>

    <!-- Revoke Confirmation Modal -->
    <div id="revoke-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeRevokeModal()"></div>
        <div class="modal-content relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="shield-alert" class="w-8 h-8 text-red-600"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-900">確認撤銷名片</h3>
                <p class="text-sm text-slate-600 mt-2">撤銷後，所有分享的連結將立即失效</p>
                <p class="text-xs text-amber-600 mt-2 font-medium">您可在 7 天內自行恢復此名片</p>
                <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-xl">
                    <p class="text-xs text-blue-800">
                        <span class="font-bold">需要立即刪除並重新註冊？</span><br>
                        請聯繫管理員協助永久刪除，即可立即創建新卡片
                    </p>
                </div>
            </div>

            <div class="mb-6 space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider block">撤銷原因（可選）</label>
                <select id="revoke-reason" class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-moda">
                    <option value="">不提供原因</option>
                    <option value="lost">卡片遺失</option>
                    <option value="suspected_leak">疑似資訊外洩</option>
                    <option value="info_update">資訊需更新</option>
                    <option value="misdelivery">誤發</option>
                    <option value="other">其他</option>
                </select>
            </div>

            <div id="rate-limit-warning" class="hidden mb-4 p-3 bg-amber-50 border border-amber-200 rounded-xl">
                <p class="text-xs text-amber-800 font-medium"></p>
            </div>

            <div class="flex gap-3">
                <button onclick="closeRevokeModal()" class="flex-1 px-6 py-4 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-colors">
                    取消
                </button>
                <button id="confirm-revoke-btn" onclick="confirmRevokeCard()" class="flex-1 px-6 py-4 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors">
                    確認撤銷
                </button>
            </div>
        </div>
    </div>

    <!-- Rate Limit Error Banner -->
    <div id="rate-limit-banner" class="hidden fixed top-24 left-1/2 transform -translate-x-1/2 z-[250] max-w-md w-full mx-4">
        <div class="glass-panel p-4 rounded-2xl border-2 border-amber-500 shadow-lg">
            <div class="flex items-start gap-3">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"></i>
                <div class="flex-1">
                    <p id="rate-limit-message" class="text-sm font-bold text-slate-900"></p>
                    <p id="rate-limit-retry" class="text-xs text-slate-600 mt-1"></p>
                    <p class="text-xs text-blue-600 mt-2 font-medium">
                        需要立即刪除並重新註冊？請聯繫管理員協助處理
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/user-portal-init.js"></script>
</body>
</html>
